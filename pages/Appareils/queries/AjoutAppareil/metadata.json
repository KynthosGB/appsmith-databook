{
  "gitSyncId": "6900ce0e5fba93519b2b9c51_298255f6-059d-4347-bffe-4d88262e239b",
  "id": "Appareils_AjoutAppareil",
  "pluginId": "postgres-plugin",
  "pluginType": "DB",
  "unpublishedAction": {
    "actionConfiguration": {
      "body": "WITH params AS (\n  SELECT\n    '{{ appsmith.URL.queryParams.numero_affaire + InputRepereAppareil.text }}'::text AS num_app,\n    '{{ appsmith.URL.queryParams.numero_affaire }}'::text                            AS num_aff,\n    '{{ InputNomAppareil.text }}'::text                                              AS nom_appareil,\n    '{{ InputRepereAppareil.text }}'::text                                           AS repere\n),\n\n-- 1) appareils\nins_app AS (\n  INSERT INTO public.appareils (numero_appareil, numero_affaire)\n  SELECT num_app, num_aff FROM params\n  ON CONFLICT (numero_appareil) DO NOTHING\n  RETURNING 1\n),\n\n-- 2) caractéristiques\nins_carac AS (\n  INSERT INTO public.caracteristiques_appareils\n         (numero_appareil, numero_affaire, nom_appareil, repere_appareil)\n  SELECT p.num_app, p.num_aff, p.num_aff || p.repere || ' - ' || p.nom_appareil, p.repere\n  FROM params p\n  ON CONFLICT (numero_appareil) DO NOTHING\n  RETURNING 1\n),\n\n-- 3) données générales\nins_dg AS (\n  INSERT INTO public.donnees_generales_appareils\n         (numero_appareil, numero_affaire, nom_client, nom_affaire)\n  SELECT p.num_app, p.num_aff, a.nom_client, p.num_aff\n  FROM params p\n  JOIN public.affaires a ON a.numero_affaire = p.num_aff\n  ON CONFLICT (numero_appareil) DO NOTHING\n  RETURNING 1\n),\n\n-- 4) sync sommaire -> sommaire_appareils\nsync_som AS (\n  INSERT INTO public.sommaire_appareils\n         (numero_appareil, master_id, include, chapter_ord_override, sub_ord_override)\n  SELECT p.num_app, s.master_id, TRUE, NULL, NULL\n  FROM params p\n  CROSS JOIN public.sommaire s\n  ON CONFLICT (numero_appareil, master_id) DO NOTHING\n  RETURNING 1\n),\n\n/* 5) calcul des nouveaux ordres :\n      - actifs : 1..N selon ordre effectif\n      - inactifs : 1000 + rang global pour ne pas gêner les actifs\n*/\nnew_orders AS (\n  SELECT\n    a.numero_appareil,\n    a.master_id,\n    CASE\n      WHEN a.include IS TRUE THEN\n        ROW_NUMBER() OVER (\n          PARTITION BY a.numero_appareil\n          ORDER BY COALESCE(a.chapter_ord_override, s.default_chapter_ord)\n        )\n      ELSE\n        1000 + ROW_NUMBER() OVER (\n          PARTITION BY a.numero_appareil\n          ORDER BY COALESCE(a.chapter_ord_override, s.default_chapter_ord)\n        )\n    END AS new_ord\n  FROM public.sommaire_appareils a\n  JOIN public.sommaire s ON s.master_id = a.master_id\n  JOIN params p ON p.num_app = a.numero_appareil\n  WHERE s.level = 1\n),\n\n-- 6) mise à jour des overrides à partir de new_orders\nupd_idx AS (\n  UPDATE public.sommaire_appareils t\n  SET chapter_ord_override = n.new_ord\n  FROM new_orders n\n  WHERE t.numero_appareil = n.numero_appareil\n    AND t.master_id      = n.master_id\n  RETURNING 1\n)\n\nSELECT\n  (SELECT COALESCE(COUNT(*),0) FROM ins_app)   AS app_inserted,\n  (SELECT COALESCE(COUNT(*),0) FROM ins_carac) AS carac_inserted,\n  (SELECT COALESCE(COUNT(*),0) FROM ins_dg)    AS dg_inserted,\n  (SELECT COALESCE(COUNT(*),0) FROM sync_som)  AS sommaire_rows_added,\n  (SELECT COALESCE(COUNT(*),0) FROM upd_idx)   AS chapters_reindexed;\n",
      "encodeParamsToggle": true,
      "paginationType": "NONE",
      "pluginSpecifiedTemplates": [
        {
          "value": true
        }
      ],
      "timeoutInMillisecond": 10000
    },
    "confirmBeforeExecute": false,
    "datasource": {
      "id": "Databook - Neon",
      "isAutoGenerated": false,
      "name": "Databook - Neon",
      "pluginId": "postgres-plugin"
    },
    "dynamicBindingPathList": [
      {
        "key": "body"
      }
    ],
    "name": "AjoutAppareil",
    "pageId": "Appareils",
    "runBehaviour": "MANUAL",
    "userSetOnLoad": true
  }
}