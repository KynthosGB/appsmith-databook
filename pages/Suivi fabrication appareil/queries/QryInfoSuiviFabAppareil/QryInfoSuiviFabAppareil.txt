SELECT
  -- clé et info étape
  wga.id                AS groupe_appareil_id,
  wge.code              AS groupe_code,
  wge.libelle           AS groupe_libelle,

  -- statut
  ws.id                 AS statut_id,
  ws.code               AS statut_code,
  ws.libelle            AS statut_libelle,
  ws.couleur            AS statut_couleur,

  -- NOTE_CALCUL
  wnc.numero            AS ndc_numero,
  wnc.indice            AS ndc_indice,
  wnc.date_objectif     AS ndc_date_objectif,
  wnc.date_edition      AS ndc_date_edition,
	wnc.nombre_jours      AS ndc_nombre_jours,

  -- PLAN
  wp.numero             AS plan_numero,
  wp.indice             AS plan_indice,
  wp.dessinateur_id     AS plan_dessinateur_id,
  wp.date_objectif      AS plan_date_objectif,
	wp.date_debut         AS plan_date_debut,
  wp.date_premier_envoi AS plan_date_premier_envoi,
	wp.date_fin           AS plan_date_fin,
	wp.nombre_jours       AS plan_nombre_jours,

  -- CAHIER SOUDAGE
  wcs.iwt_id        AS cs_iwt_id,
	wcs.numero        AS cs_numero,
	wcs.indice        AS cs_indice,
	wcs.date_objectif AS cs_date_objectif,
	wcs.date_debut    AS cs_date_debut,
	wcs.date_fin      AS cs_date_fin,
	wcs.nombre_jours  AS cs_nombre_jours,
	
	-- APPRO
	wa.date_objectif AS appro_date_objectif,
	
		-- ACHATS
	wach.date_objectif AS achats_date_objectif,

  -- PREPARATION
  wprep.preparateur_id  AS prep_preparateur_id,
  wprep.date_objectif   AS prep_date_objectif,
	wprep.date_debut      AS prep_date_debut,
	wprep.date_fin        AS prep_date_fin,
	wprep.nombre_jours    AS prep_nombre_jours,

  -- FABRICATION
  wf.monteur_id                 AS fab_monteur_id,
  wf.heures_prevues             AS fab_heures_prevues,
	wf.heures_prevues_montage     AS fab_heures_prevues_montage,
	wf.nombre_jours_marge_fab     AS fab_nombre_jours_marge_fab,
  wf.heures_passees             AS fab_heures_passees,
	wf.date_debut                 AS fab_date_debut,
	wf.date_fin                   AS fab_date_fin,

  -- DOSSIER CONSTRUCTEUR
  wdc.numero            AS dc_numero

FROM public.workflow_groupe_appareil      wga
JOIN public.workflow_groupe_etape         wge ON wge.id = wga.groupe_id
JOIN public.workflow_statut               ws  ON ws.id  = wga.statut_id

LEFT JOIN public.workflow_note_calcul      wnc  ON wnc.groupe_appareil_id = wga.id
  AND wge.code = 'NOTE_CALCUL'

LEFT JOIN public.workflow_plan             wp   ON wp.groupe_appareil_id  = wga.id
  AND wge.code = 'PLAN'

LEFT JOIN public.workflow_cahier_soudage   wcs  ON wcs.groupe_appareil_id = wga.id
  AND wge.code = 'CAHIER_SOUDAGE'
	
LEFT JOIN public.workflow_appro wa ON wa.groupe_appareil_id = wga.id
  AND wge.code = 'APPRO'
	
LEFT JOIN public.workflow_achats wach ON wach.groupe_appareil_id = wga.id
  AND wge.code = 'ACHATS'

LEFT JOIN public.workflow_preparation      wprep ON wprep.groupe_appareil_id = wga.id
  AND wge.code = 'PREPARATION'

LEFT JOIN public.workflow_fabrication      wf   ON wf.groupe_appareil_id  = wga.id
  AND wge.code = 'FABRICATION'

LEFT JOIN public.workflow_dossier_constructeur wdc ON wdc.groupe_appareil_id = wga.id
  AND wge.code = 'DOSSIER_CONSTRUCTEUR'

WHERE wga.numero_appareil = '{{ appsmith.URL.queryParams.numero_appareil }}'
ORDER BY wge.ordre;
