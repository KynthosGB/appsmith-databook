SELECT
  a.numero_appareil,
  a.numero_affaire,
  ca.nom_appareil,
  a.delai,
  aff.nom_client AS client,

  -- Stats globales par appareil
  COUNT(wga.*) AS total_etapes,
  COUNT(*) FILTER (
    WHERE ws.code IN ('TERMINE', 'VALIDE_CLIENT')
  ) AS etapes_faites,
  COUNT(*) FILTER (
    WHERE ws.code IN ('EN_COURS', 'ATTENTE_CLIENT')
  ) AS etapes_en_cours,
  COUNT(*) FILTER (
    WHERE ws.code IN ('A_FAIRE')
  ) AS etapes_a_faire,
  COUNT(*) FILTER (
    WHERE ws.code = 'ATTENTE_CLIENT'
  ) AS nb_en_attente_client,

  -- Détail des grandes étapes pour l'appareil (utilisé dans l'UI)
  jsonb_agg(
    jsonb_build_object(
      'groupe_id',          wge.id,
      'groupe_code',        wge.code,
      'groupe_libelle',     wge.libelle,

      'statut_id',          ws.id,
      'statut_code',        ws.code,
      'statut_libelle',     ws.libelle,
      'statut_couleur',     ws.couleur,

      -- dates génériques pour l'étape
      'date_objectif',
        CASE
          WHEN wge.code = 'NOTE_CALCUL'     THEN wnc.date_objectif
          WHEN wge.code = 'PLAN'            THEN wp.date_objectif
          WHEN wge.code = 'CAHIER_SOUDAGE'  THEN wcs.date_objectif
          WHEN wge.code = 'PREPARATION'     THEN wprep.date_objectif
          WHEN wge.code = 'APPRO'           THEN wa.date_objectif
          WHEN wge.code = 'ACHATS'          THEN wach.date_objectif

          -- ✅ FABRICATION : objectif = fin calculée (marge 2 semaines)
          WHEN wge.code = 'FABRICATION' THEN fab.fab_date_fin
          ELSE NULL
        END,

      'date_fin',
        CASE
          WHEN wge.code = 'NOTE_CALCUL'     THEN wnc.date_objectif
          WHEN wge.code = 'PLAN'            THEN wp.date_objectif
          WHEN wge.code = 'CAHIER_SOUDAGE'  THEN wcs.date_objectif
          WHEN wge.code = 'PREPARATION'     THEN wprep.date_objectif
          WHEN wge.code = 'APPRO'           THEN wa.date_objectif
          WHEN wge.code = 'ACHATS'          THEN wach.date_objectif

          -- ✅ FABRICATION : fin = délai - 2 semaines
          WHEN wge.code = 'FABRICATION' THEN fab.fab_date_fin
          ELSE NULL
        END,

      -- Nombre de jours (durée en jours ouvrés)
      'nombre_jours',
        CASE
          WHEN wge.code = 'NOTE_CALCUL'     THEN wnc.nombre_jours
          WHEN wge.code = 'PLAN'            THEN wp.nombre_jours
          WHEN wge.code = 'CAHIER_SOUDAGE'  THEN wcs.nombre_jours
          WHEN wge.code = 'PREPARATION'     THEN wprep.nombre_jours

          -- ✅ FABRICATION = 70% des heures prévues / 7.5h par jour
          WHEN wge.code = 'FABRICATION' THEN fab.fab_jours_total
          ELSE NULL
        END,

      'groupe_appareil_id', wga.id,
      'color',              ws.couleur
    )
    ORDER BY wge.ordre
  ) AS etapes

FROM public.appareils a
LEFT JOIN public.affaires aff
       ON aff.numero_affaire = a.numero_affaire
LEFT JOIN public.caracteristiques_appareils ca
       ON ca.numero_appareil = a.numero_appareil

LEFT JOIN public.workflow_groupe_appareil wga
       ON wga.numero_appareil = a.numero_appareil
LEFT JOIN public.workflow_groupe_etape wge
       ON wge.id = wga.groupe_id
LEFT JOIN public.workflow_statut ws
       ON ws.id = wga.statut_id

-- tables de détail
LEFT JOIN public.workflow_note_calcul     wnc   ON wnc.groupe_appareil_id = wga.id
LEFT JOIN public.workflow_plan            wp    ON wp.groupe_appareil_id  = wga.id
LEFT JOIN public.workflow_cahier_soudage  wcs   ON wcs.groupe_appareil_id = wga.id
LEFT JOIN public.workflow_preparation     wprep ON wprep.groupe_appareil_id = wga.id
LEFT JOIN public.workflow_appro           wa    ON wa.groupe_appareil_id = wga.id
LEFT JOIN public.workflow_achats          wach  ON wach.groupe_appareil_id = wga.id

-- ✅ ajout FABRICATION (heures prévues montage ici)
LEFT JOIN public.workflow_fabrication     wfab  ON wfab.groupe_appareil_id = wga.id
LEFT JOIN LATERAL (
  SELECT
    /* 1) Fin = veille du délai, ajustée hors week-end */
    (
      CASE
        WHEN EXTRACT(ISODOW FROM (a.delai::date - INTERVAL '1 day')) = 6 THEN (a.delai::date - INTERVAL '2 day')::date  -- samedi -> vendredi
        WHEN EXTRACT(ISODOW FROM (a.delai::date - INTERVAL '1 day')) = 7 THEN (a.delai::date - INTERVAL '3 day')::date  -- dimanche -> vendredi
        ELSE (a.delai::date - INTERVAL '1 day')::date
      END
    ) AS fab_date_fin,

    /* 2) Durée "heures" en jours ouvrés (base) */
    CEIL( (COALESCE(wfab.heures_prevues, 0) * 0.70) / 7.5 )::int AS fab_jours_base,

    /* 3) Durée totale pour le Gantt = base + 14 jours (marge au début) */
    (CEIL( (COALESCE(wfab.heures_prevues, 0) * 0.70) / 7.5 )::int + 10) AS fab_jours_total
) fab ON TRUE


WHERE a.cloture_suivi_fabrication = false

GROUP BY
  a.numero_appareil,
  a.numero_affaire,
  ca.nom_appareil,
  a.delai,
  aff.nom_client

ORDER BY a.numero_appareil DESC;
