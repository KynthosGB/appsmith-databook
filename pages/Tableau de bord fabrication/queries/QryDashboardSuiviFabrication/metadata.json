{
  "gitSyncId": "6915b9d6a2ab6852a3eeef70_54259a97-bdd9-443f-b27c-e7f0e52307d8",
  "id": "Tableau de bord fabrication_QryDashboardSuiviFabrication",
  "pluginId": "postgres-plugin",
  "pluginType": "DB",
  "unpublishedAction": {
    "actionConfiguration": {
      "body": "SELECT\n  a.numero_appareil,\n  a.numero_affaire,\n  ca.nom_appareil,\n  a.delai,\n  aff.nom_client AS client,\n\n  -- Stats globales par appareil\n  COUNT(wga.*) AS total_etapes,\n  COUNT(*) FILTER (\n    WHERE ws.code IN ('TERMINE', 'VALIDE_CLIENT')\n  ) AS etapes_faites,\n  COUNT(*) FILTER (\n    WHERE ws.code IN ('EN_COURS', 'ATTENTE_CLIENT')\n  ) AS etapes_en_cours,\n  COUNT(*) FILTER (\n    WHERE ws.code IN ('A_FAIRE')\n  ) AS etapes_a_faire,\n  COUNT(*) FILTER (\n    WHERE ws.code = 'ATTENTE_CLIENT'\n  ) AS nb_en_attente_client,\n\n  -- Détail des grandes étapes pour l'appareil (utilisé dans l'UI)\n  jsonb_agg(\n    jsonb_build_object(\n      -- Groupe (grande étape)\n      'groupe_id',          wge.id,\n      'groupe_code',        wge.code,        -- NOTE_CALCUL, PLAN, APPRO, ...\n      'groupe_libelle',     wge.libelle,\n\n      -- Statut\n      'statut_id',          ws.id,\n      'statut_code',        ws.code,         -- EN_COURS, TERMINE, ATTENTE_CLIENT, ...\n      'statut_libelle',     ws.libelle,\n      'statut_couleur',     ws.couleur,\n\t\t\t\n\t\t\t-- dates génériques pour l'étape\n      'date_objectif',\n        CASE\n          WHEN wge.code = 'NOTE_CALCUL'     THEN wnc.date_objectif\n          WHEN wge.code = 'PLAN'            THEN wp.date_objectif\n          WHEN wge.code = 'CAHIER_SOUDAGE'  THEN wcs.date_objectif\n          WHEN wge.code = 'PREPARATION'     THEN wprep.date_objectif\n\t\t\t    WHEN wge.code = 'APPRO'           THEN wa.date_objectif\n\t\t\t    WHEN wge.code = 'ACHATS'          THEN wach.date_objectif\n          ELSE NULL\n        END,\n      'date_fin',\n        CASE\n          WHEN wge.code = 'NOTE_CALCUL'     THEN wnc.date_edition\n          WHEN wge.code = 'PLAN'            THEN wp.date_fin\n          WHEN wge.code = 'CAHIER_SOUDAGE'  THEN wcs.date_fin\n          WHEN wge.code = 'PREPARATION'     THEN wprep.date_fin\n\t\t\t\n\t\t\t\t\t-- APPRO : max(date des items) ou date du jour si aucune\n\t\t\t\t\tWHEN wge.code = 'APPRO' THEN (\n\t\t\t\t\t\tSELECT COALESCE(MAX(wai.date), CURRENT_DATE)\n\t\t\t\t\t\tFROM public.workflow_appro_item AS wai\n\t\t\t\t\t\tWHERE wai.groupe_appareil_id = wga.id\n\t\t\t\t\t\t\tAND wai.na = false          -- on ignore les items marqués NA\n\t\t\t\t\t)\n          ELSE NULL\n        END,\n\n      -- Id technique pour UPDATE\n      'groupe_appareil_id', wga.id,\n\n      -- Couleur directe pour l'UI (également = couleur du statut)\n      'color',              ws.couleur\n    )\n    ORDER BY wge.ordre\n  ) AS etapes\n\nFROM public.appareils a\nLEFT JOIN public.affaires aff\n       ON aff.numero_affaire = a.numero_affaire\nLEFT JOIN public.caracteristiques_appareils ca\n       ON ca.numero_appareil = a.numero_appareil\n\nLEFT JOIN public.workflow_groupe_appareil wga\n       ON wga.numero_appareil = a.numero_appareil\nLEFT JOIN public.workflow_groupe_etape wge\n       ON wge.id = wga.groupe_id\nLEFT JOIN public.workflow_statut ws\n       ON ws.id = wga.statut_id\n\t\t\t \n-- tables de détail\nLEFT JOIN public.workflow_note_calcul     wnc   ON wnc.groupe_appareil_id = wga.id\nLEFT JOIN public.workflow_plan            wp    ON wp.groupe_appareil_id  = wga.id\nLEFT JOIN public.workflow_cahier_soudage  wcs   ON wcs.groupe_appareil_id = wga.id\nLEFT JOIN public.workflow_preparation     wprep ON wprep.groupe_appareil_id = wga.id\nLEFT JOIN public.workflow_appro           wa    ON wa.groupe_appareil_id = wga.id\nLEFT JOIN public.workflow_appro_item      wai   ON wai.groupe_appareil_id = wga.id\nLEFT JOIN public.workflow_achats          wach  ON wa.groupe_appareil_id = wga.id\n\nWHERE\na.cloture_suivi_fabrication = false\nAND a.numero_appareil NOT LIKE '%Z'\n\nGROUP BY\n  a.numero_appareil,\n  a.numero_affaire,\n  ca.nom_appareil,\n  a.delai,\n  aff.nom_client\n\nORDER BY a.numero_appareil DESC;\n",
      "encodeParamsToggle": true,
      "paginationType": "NONE",
      "pluginSpecifiedTemplates": [
        {
          "value": true
        }
      ],
      "timeoutInMillisecond": 10000
    },
    "confirmBeforeExecute": false,
    "datasource": {
      "id": "Databook - Neon",
      "isAutoGenerated": false,
      "name": "Databook - Neon",
      "pluginId": "postgres-plugin"
    },
    "dynamicBindingPathList": [],
    "name": "QryDashboardSuiviFabrication",
    "pageId": "Tableau de bord fabrication",
    "runBehaviour": "AUTOMATIC",
    "userSetOnLoad": false
  }
}