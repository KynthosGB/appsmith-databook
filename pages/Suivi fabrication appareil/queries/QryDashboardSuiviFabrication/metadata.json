{
  "gitSyncId": "6915b9d6a2ab6852a3eeef70_1826f116-a35a-412e-900d-26bbbf467f22",
  "id": "Suivi fabrication appareil_QryDashboardSuiviFabrication",
  "pluginId": "postgres-plugin",
  "pluginType": "DB",
  "unpublishedAction": {
    "actionConfiguration": {
      "body": "SELECT\n  a.numero_appareil,\n  a.numero_affaire,\n  ca.nom_appareil,\n  a.delai,\n  aff.nom_client AS client,\n\n  -- Stats globales par appareil\n  COUNT(wga.*) AS total_etapes,\n  COUNT(*) FILTER (WHERE ws.code IN ('TERMINE', 'VALIDE_CLIENT')) AS etapes_faites,\n  COUNT(*) FILTER (WHERE ws.code IN ('EN_COURS', 'ATTENTE_CLIENT')) AS etapes_en_cours,\n  COUNT(*) FILTER (WHERE ws.code IN ('A_FAIRE')) AS etapes_a_faire,\n  COUNT(*) FILTER (WHERE ws.code = 'ATTENTE_CLIENT') AS nb_en_attente_client,\n\n  -- Détail des grandes étapes pour l'appareil (utilisé dans l'UI)\n  jsonb_agg(\n    jsonb_build_object(\n      -- debug (optionnel)\n      'debug_fab_base', CASE WHEN wge.code='FABRICATION' THEN fab.fab_jours_base END,\n\n      'groupe_id',          wge.id,\n      'groupe_code',        wge.code,\n      'groupe_libelle',     wge.libelle,\n\n      'statut_id',          ws.id,\n      'statut_code',        ws.code,\n      'statut_libelle',     ws.libelle,\n      'statut_couleur',     ws.couleur,\n\n      -- dates génériques pour l'étape\n      'date_objectif',\n        CASE\n          WHEN wge.code = 'NOTE_CALCUL'     THEN wnc.date_objectif\n          WHEN wge.code = 'PLAN'            THEN wp.date_objectif\n          WHEN wge.code = 'CAHIER_SOUDAGE'  THEN wcs.date_objectif\n          WHEN wge.code = 'PREPARATION'     THEN wprep.date_objectif\n          WHEN wge.code = 'BESOINS'         THEN wa.date_objectif\n          WHEN wge.code = 'ACHATS'          THEN wach.date_objectif\n\n          -- ✅ FABRICATION : objectif = date fin réelle (fallback si null)\n          WHEN wge.code = 'FABRICATION'     THEN fab.fab_date_fin\n          ELSE NULL\n        END,\n\n      -- ✅ FABRICATION : début = date début réelle (fallback si null)\n      'date_debut',\n        CASE\n          WHEN wge.code = 'FABRICATION'     THEN fab.fab_date_debut\n          ELSE NULL\n        END,\n\n      'date_fin',\n        CASE\n          WHEN wge.code = 'NOTE_CALCUL'     THEN wnc.date_objectif\n          WHEN wge.code = 'PLAN'            THEN wp.date_objectif\n          WHEN wge.code = 'CAHIER_SOUDAGE'  THEN wcs.date_objectif\n          WHEN wge.code = 'PREPARATION'     THEN wprep.date_objectif\n          WHEN wge.code = 'BESOINS'         THEN wa.date_objectif\n          WHEN wge.code = 'ACHATS'          THEN wach.date_objectif\n\n          -- ✅ FABRICATION : fin = date fin réelle (fallback si null)\n          WHEN wge.code = 'FABRICATION'     THEN fab.fab_date_fin\n          ELSE NULL\n        END,\n\t\t\t\n\t\t\t-- ✅ DATES RÉELLES POUR BASELINE\n      'date_debut_reel',\n        CASE\n          WHEN wge.code = 'NOTE_CALCUL'     THEN wnc.date_debut\n          WHEN wge.code = 'PLAN'            THEN wp.date_debut\n          WHEN wge.code = 'CAHIER_SOUDAGE'  THEN wcs.date_debut\n          WHEN wge.code = 'PREPARATION'     THEN wprep.date_debut\n\n          -- Besoins / Achats = jalons => pas de début réel\n          WHEN wge.code = 'BESOINS'         THEN NULL\n          WHEN wge.code = 'ACHATS'          THEN NULL\n\n          -- Fabrication (colonnes spécifiques)\n          WHEN wge.code = 'FABRICATION'     THEN wfab.date_debut_reelle\n          ELSE NULL\n        END,\n\n      'date_fin_reel',\n        CASE\n          WHEN wge.code = 'NOTE_CALCUL'     THEN wnc.date_edition\n          WHEN wge.code = 'PLAN'            THEN wp.date_fin\n          WHEN wge.code = 'CAHIER_SOUDAGE'  THEN wcs.date_fin\n          WHEN wge.code = 'PREPARATION'     THEN wprep.date_fin\n\n          -- jalons\n          WHEN wge.code = 'BESOINS'         THEN wa.date_fin\n          WHEN wge.code = 'ACHATS'          THEN wach.date_fin\n\n          -- Fabrication\n          WHEN wge.code = 'FABRICATION'     THEN wfab.date_fin_reelle\n          ELSE NULL\n        END,\n\n      -- Nombre de jours (durée en jours ouvrés)\n      'nombre_jours',\n        CASE\n          WHEN wge.code = 'NOTE_CALCUL'     THEN wnc.nombre_jours\n          WHEN wge.code = 'PLAN'            THEN wp.nombre_jours\n          WHEN wge.code = 'CAHIER_SOUDAGE'  THEN wcs.nombre_jours\n          WHEN wge.code = 'PREPARATION'     THEN wprep.nombre_jours\n\n          -- ✅ FABRICATION : durée base (sans marge) juste informative\n          WHEN wge.code = 'FABRICATION'     THEN fab.fab_jours_base\n          ELSE NULL\n        END,\n\n      'groupe_appareil_id', wga.id,\n      'color',              ws.couleur\n    )\n    ORDER BY wge.ordre\n  ) AS etapes\n\nFROM public.appareils a\nLEFT JOIN public.affaires aff\n       ON aff.numero_affaire = a.numero_affaire\nLEFT JOIN public.caracteristiques_appareils ca\n       ON ca.numero_appareil = a.numero_appareil\n\nLEFT JOIN public.workflow_groupe_appareil wga\n       ON wga.numero_appareil = a.numero_appareil\nLEFT JOIN public.workflow_groupe_etape wge\n       ON wge.id = wga.groupe_id\nLEFT JOIN public.workflow_statut ws\n       ON ws.id = wga.statut_id\n\n-- tables de détail\nLEFT JOIN public.workflow_note_calcul     wnc   ON wnc.groupe_appareil_id = wga.id\nLEFT JOIN public.workflow_plan            wp    ON wp.groupe_appareil_id  = wga.id\nLEFT JOIN public.workflow_cahier_soudage  wcs   ON wcs.groupe_appareil_id = wga.id\nLEFT JOIN public.workflow_preparation     wprep ON wprep.groupe_appareil_id = wga.id\nLEFT JOIN public.workflow_appro           wa    ON wa.groupe_appareil_id = wga.id\nLEFT JOIN public.workflow_achats          wach  ON wach.groupe_appareil_id = wga.id\n\n-- ✅ FABRICATION (dates réelles)\nLEFT JOIN public.workflow_fabrication wfab\n       ON wfab.groupe_appareil_id = wga.id\n\n-- ✅ Calculs FAB (dates réelles + fallback)\nLEFT JOIN LATERAL (\n  SELECT\n    calc.fab_jours_base,\n\n    -- fin = date fin réelle si renseignée, sinon veille du délai hors week-end\n    COALESCE(\n      fin_real.fab_date_fin_real,\n      fin_calc.fab_date_fin_calc\n    ) AS fab_date_fin,\n\n    -- début = date début réelle si renseignée, sinon reculé en jours ouvrés (base heures, sans marge)\n    COALESCE(\n      deb_real.fab_date_debut_real,\n      (\n        SELECT d::date\n        FROM generate_series(\n          (COALESCE(fin_real.fab_date_fin_real, fin_calc.fab_date_fin_calc)::date - INTERVAL '730 days')::date,\n          COALESCE(fin_real.fab_date_fin_real, fin_calc.fab_date_fin_calc)::date,\n          INTERVAL '1 day'\n        ) AS g(d)\n        WHERE EXTRACT(ISODOW FROM d) < 6\n        ORDER BY d DESC\n        OFFSET (GREATEST(calc.fab_jours_base, 1) - 1)\n        LIMIT 1\n      )\n    ) AS fab_date_debut\n\n  FROM\n    -- durée base (sans marge)\n    LATERAL (\n      SELECT CEIL(((COALESCE(wfab.heures_prevues, 0) * 0.70) / 7.5))::int AS fab_jours_base\n    ) calc\n\n    -- dates réelles (normalisées si week-end)\n    CROSS JOIN LATERAL (\n      SELECT\n        CASE\n          WHEN wfab.date_fin IS NULL THEN NULL\n          WHEN EXTRACT(ISODOW FROM wfab.date_fin::date) = 6 THEN (wfab.date_fin::date - INTERVAL '1 day')::date\n          WHEN EXTRACT(ISODOW FROM wfab.date_fin::date) = 7 THEN (wfab.date_fin::date - INTERVAL '2 day')::date\n          ELSE wfab.date_fin::date\n        END AS fab_date_fin_real\n    ) fin_real\n\n    CROSS JOIN LATERAL (\n      SELECT\n        CASE\n          WHEN wfab.date_debut IS NULL THEN NULL\n          WHEN EXTRACT(ISODOW FROM wfab.date_debut::date) = 6 THEN (wfab.date_debut::date - INTERVAL '1 day')::date\n          WHEN EXTRACT(ISODOW FROM wfab.date_debut::date) = 7 THEN (wfab.date_debut::date - INTERVAL '2 day')::date\n          ELSE wfab.date_debut::date\n        END AS fab_date_debut_real\n    ) deb_real\n\n    -- fin calculée = veille du délai hors week-end (fallback)\n    CROSS JOIN LATERAL (\n      SELECT\n        CASE\n          WHEN EXTRACT(ISODOW FROM (a.delai::date - INTERVAL '1 day')) = 6 THEN (a.delai::date - INTERVAL '2 day')::date\n          WHEN EXTRACT(ISODOW FROM (a.delai::date - INTERVAL '1 day')) = 7 THEN (a.delai::date - INTERVAL '3 day')::date\n          ELSE (a.delai::date - INTERVAL '1 day')::date\n        END AS fab_date_fin_calc\n    ) fin_calc\n) fab ON TRUE\n\nWHERE a.cloture_suivi_fabrication = false\n  AND a.numero_affaire = '{{ SelectAffaire.selectedOptionValue }}'\n\nGROUP BY\n  a.numero_appareil,\n  a.numero_affaire,\n  ca.nom_appareil,\n  a.delai,\n  aff.nom_client\n\nORDER BY a.numero_appareil DESC;",
      "encodeParamsToggle": true,
      "paginationType": "NONE",
      "pluginSpecifiedTemplates": [
        {
          "value": true
        }
      ],
      "timeoutInMillisecond": 10000
    },
    "confirmBeforeExecute": false,
    "datasource": {
      "id": "Databook - Neon",
      "isAutoGenerated": false,
      "name": "Databook - Neon",
      "pluginId": "postgres-plugin"
    },
    "dynamicBindingPathList": [
      {
        "key": "body"
      }
    ],
    "name": "QryDashboardSuiviFabrication",
    "pageId": "Suivi fabrication appareil",
    "runBehaviour": "AUTOMATIC",
    "userSetOnLoad": true
  }
}