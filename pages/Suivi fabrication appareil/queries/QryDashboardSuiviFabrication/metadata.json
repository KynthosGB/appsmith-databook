{
  "gitSyncId": "6915b9d6a2ab6852a3eeef70_1826f116-a35a-412e-900d-26bbbf467f22",
  "id": "Suivi fabrication appareil_QryDashboardSuiviFabrication",
  "pluginId": "postgres-plugin",
  "pluginType": "DB",
  "unpublishedAction": {
    "actionConfiguration": {
      "body": "SELECT\n  a.numero_appareil,\n  a.numero_affaire,\n  ca.nom_appareil,\n  a.delai,\n  aff.nom_client AS client,\n\n  -- Stats globales par appareil\n  COUNT(wga.*) AS total_etapes,\n  COUNT(*) FILTER (\n    WHERE ws.code IN ('TERMINE', 'VALIDE_CLIENT')\n  ) AS etapes_faites,\n  COUNT(*) FILTER (\n    WHERE ws.code IN ('EN_COURS', 'ATTENTE_CLIENT')\n  ) AS etapes_en_cours,\n  COUNT(*) FILTER (\n    WHERE ws.code IN ('A_FAIRE')\n  ) AS etapes_a_faire,\n  COUNT(*) FILTER (\n    WHERE ws.code = 'ATTENTE_CLIENT'\n  ) AS nb_en_attente_client,\n\n  -- Détail des grandes étapes pour l'appareil (utilisé dans l'UI)\n  jsonb_agg(\n    jsonb_build_object(\n\t\t\t'debug_fab_base', CASE WHEN wge.code='FABRICATION' THEN fab.fab_jours_base END,\n\t\t\t'debug_fab_marge', CASE WHEN wge.code='FABRICATION' THEN COALESCE(NULLIF(btrim(wfab.nombre_jours_marge_fab), '')::int, 0) END,\n\t\t\t'debug_fab_total', CASE WHEN wge.code='FABRICATION' THEN fab.fab_jours_total END,\n\n      'groupe_id',          wge.id,\n      'groupe_code',        wge.code,\n      'groupe_libelle',     wge.libelle,\n\n      'statut_id',          ws.id,\n      'statut_code',        ws.code,\n      'statut_libelle',     ws.libelle,\n      'statut_couleur',     ws.couleur,\n\n      -- dates génériques pour l'étape\n      'date_objectif',\n        CASE\n          WHEN wge.code = 'NOTE_CALCUL'     THEN wnc.date_objectif\n          WHEN wge.code = 'PLAN'            THEN wp.date_objectif\n          WHEN wge.code = 'CAHIER_SOUDAGE'  THEN wcs.date_objectif\n          WHEN wge.code = 'PREPARATION'     THEN wprep.date_objectif\n          WHEN wge.code = 'APPRO'           THEN wa.date_objectif\n          WHEN wge.code = 'ACHATS'          THEN wach.date_objectif\n\n          -- ✅ FABRICATION : objectif = fin calculée (marge 2 semaines)\n          WHEN wge.code = 'FABRICATION' THEN fab.fab_date_fin\n          ELSE NULL\n        END,\n\n      'date_fin',\n        CASE\n          WHEN wge.code = 'NOTE_CALCUL'     THEN wnc.date_objectif\n          WHEN wge.code = 'PLAN'            THEN wp.date_objectif\n          WHEN wge.code = 'CAHIER_SOUDAGE'  THEN wcs.date_objectif\n          WHEN wge.code = 'PREPARATION'     THEN wprep.date_objectif\n          WHEN wge.code = 'APPRO'           THEN wa.date_objectif\n          WHEN wge.code = 'ACHATS'          THEN wach.date_objectif\n\n          -- ✅ FABRICATION : fin = délai - 2 semaines\n          WHEN wge.code = 'FABRICATION' THEN fab.fab_date_fin\n          ELSE NULL\n        END,\n\n      -- Nombre de jours (durée en jours ouvrés)\n      'nombre_jours',\n        CASE\n          WHEN wge.code = 'NOTE_CALCUL'     THEN wnc.nombre_jours\n          WHEN wge.code = 'PLAN'            THEN wp.nombre_jours\n          WHEN wge.code = 'CAHIER_SOUDAGE'  THEN wcs.nombre_jours\n          WHEN wge.code = 'PREPARATION'     THEN wprep.nombre_jours\n\n          -- ✅ FABRICATION = 70% des heures prévues / 7.5h par jour\n          WHEN wge.code = 'FABRICATION' THEN fab.fab_jours_total\n          ELSE NULL\n        END,\n\n      'groupe_appareil_id', wga.id,\n      'color',              ws.couleur\n    )\n    ORDER BY wge.ordre\n  ) AS etapes\n\nFROM public.appareils a\nLEFT JOIN public.affaires aff\n       ON aff.numero_affaire = a.numero_affaire\nLEFT JOIN public.caracteristiques_appareils ca\n       ON ca.numero_appareil = a.numero_appareil\n\nLEFT JOIN public.workflow_groupe_appareil wga\n       ON wga.numero_appareil = a.numero_appareil\nLEFT JOIN public.workflow_groupe_etape wge\n       ON wge.id = wga.groupe_id\nLEFT JOIN public.workflow_statut ws\n       ON ws.id = wga.statut_id\n\n-- tables de détail\nLEFT JOIN public.workflow_note_calcul     wnc   ON wnc.groupe_appareil_id = wga.id\nLEFT JOIN public.workflow_plan            wp    ON wp.groupe_appareil_id  = wga.id\nLEFT JOIN public.workflow_cahier_soudage  wcs   ON wcs.groupe_appareil_id = wga.id\nLEFT JOIN public.workflow_preparation     wprep ON wprep.groupe_appareil_id = wga.id\nLEFT JOIN public.workflow_appro           wa    ON wa.groupe_appareil_id = wga.id\nLEFT JOIN public.workflow_achats          wach  ON wach.groupe_appareil_id = wga.id\n\n-- ✅ ajout FABRICATION (heures prévues montage ici)\nLEFT JOIN public.workflow_fabrication     wfab  ON wfab.groupe_appareil_id = wga.id\nLEFT JOIN LATERAL (\n  SELECT\n    /* 1) Fin = veille du délai, ajustée hors week-end */\n    (\n      CASE\n        WHEN EXTRACT(ISODOW FROM (a.delai::date - INTERVAL '1 day')) = 6 THEN (a.delai::date - INTERVAL '2 day')::date  -- samedi -> vendredi\n        WHEN EXTRACT(ISODOW FROM (a.delai::date - INTERVAL '1 day')) = 7 THEN (a.delai::date - INTERVAL '3 day')::date  -- dimanche -> vendredi\n        ELSE (a.delai::date - INTERVAL '1 day')::date\n      END\n    ) AS fab_date_fin,\n\n    /* 2) Durée \"heures\" en jours ouvrés (base) */\n    CEIL( (COALESCE(wfab.heures_prevues, 0) * 0.70) / 7.5 )::int AS fab_jours_base,\n\n    /* 3) Durée totale pour le Gantt = base + X jours (marge au début) */\n    (\n\t\t\tCEIL( (COALESCE(wfab.heures_prevues, 0) * 0.70) / 7.5 )::int\n\t\t\t+ COALESCE(NULLIF(btrim(wfab.nombre_jours_marge_fab), '')::int, 0)\n\t\t) AS fab_jours_total\n\n\n) fab ON TRUE\n\n\nWHERE a.cloture_suivi_fabrication = false\n  AND a.numero_affaire = '{{ SelectAffaire.selectedOptionValue }}'\n\nGROUP BY\n  a.numero_appareil,\n  a.numero_affaire,\n  ca.nom_appareil,\n  a.delai,\n  aff.nom_client\n\nORDER BY a.numero_appareil DESC;\n",
      "encodeParamsToggle": true,
      "paginationType": "NONE",
      "pluginSpecifiedTemplates": [
        {
          "value": true
        }
      ],
      "timeoutInMillisecond": 10000
    },
    "confirmBeforeExecute": false,
    "datasource": {
      "id": "Databook - Neon",
      "isAutoGenerated": false,
      "name": "Databook - Neon",
      "pluginId": "postgres-plugin"
    },
    "dynamicBindingPathList": [
      {
        "key": "body"
      }
    ],
    "name": "QryDashboardSuiviFabrication",
    "pageId": "Suivi fabrication appareil",
    "runBehaviour": "AUTOMATIC",
    "userSetOnLoad": true
  }
}