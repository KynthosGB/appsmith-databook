INSERT INTO public.alert_rules (
  event_type,
  step_code,
  status_code,
  event_key,
  event_value,
  target_everwin_user_id,
	notify_charge_affaires,
  enabled,
  only_on_change,
  throttle_minutes,
  description
)
VALUES (
  '{{ TableAlertRules.newRow.event_type ?? "STATUS_CHANGED" }}',

  CASE
    WHEN '{{ TableAlertRules.newRow.event_type ?? "STATUS_CHANGED" }}' = 'STATUS_CHANGED'
      THEN NULLIF('{{ TableAlertRules.newRow.step_code ?? "" }}', '')
    ELSE NULL
  END,

  CASE
    WHEN '{{ TableAlertRules.newRow.event_type ?? "STATUS_CHANGED" }}' = 'STATUS_CHANGED'
      THEN NULLIF('{{ TableAlertRules.newRow.status_code ?? "" }}', '')
    ELSE NULL
  END,

  CASE
    WHEN '{{ TableAlertRules.newRow.event_type ?? "STATUS_CHANGED" }}' <> 'STATUS_CHANGED'
      THEN NULLIF('{{ TableAlertRules.newRow.event_key ?? "" }}', '')
    ELSE NULL
  END,

  CASE
    WHEN '{{ TableAlertRules.newRow.event_type ?? "STATUS_CHANGED" }}' <> 'STATUS_CHANGED'
      THEN 'true'
    ELSE NULL
  END,

  CASE
    WHEN '{{ TableAlertRules.newRow.event_type ?? "STATUS_CHANGED" }}' = 'STATUS_CHANGED'
     AND NULLIF('{{ TableAlertRules.newRow.status_code ?? "" }}','') = 'ATTENTE_CLIENT'
      THEN NULL
    ELSE NULLIF('{{ TableAlertRules.newRow.target_everwin_user_id ?? "" }}', '')
  END,
	
	{{ TableAlertRules.newRow.notify_charge_affaire ?? false }},
  {{ TableAlertRules.newRow.enabled ?? true }},
  {{ TableAlertRules.newRow.only_on_change ?? true }},
  {{ TableAlertRules.newRow.throttle_minutes ?? 0 }},
  '{{ (TableAlertRules.newRow.description || "").replaceAll("'", "''") }}'
)
RETURNING id;
