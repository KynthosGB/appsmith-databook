{
  "backgroundColor": "#FFFFFF",
  "borderColor": "#E0DEDE",
  "borderRadius": "{{appsmith.theme.borderRadius.appBorderRadius}}",
  "borderWidth": "1",
  "bottomRow": 104,
  "boxShadow": "{{appsmith.theme.boxShadow.appBoxShadow}}",
  "defaultModel": "{{ { rows: QryDashboardSuiviFabrication.data || [] } }}",
  "dynamicBindingPathList": [
    {
      "key": "theme"
    },
    {
      "key": "borderRadius"
    },
    {
      "key": "boxShadow"
    },
    {
      "key": "defaultModel"
    }
  ],
  "dynamicHeight": "AUTO_HEIGHT",
  "dynamicPropertyPathList": [],
  "dynamicTriggerPathList": [],
  "events": [],
  "isCanvas": false,
  "isLoading": false,
  "isSearchWildcard": true,
  "isVisible": true,
  "key": "ctx98s9hxm",
  "leftColumn": 0,
  "maxDynamicHeight": 9000,
  "minDynamicHeight": 4,
  "mobileBottomRow": 40,
  "mobileLeftColumn": 19,
  "mobileRightColumn": 42,
  "mobileTopRow": 10,
  "needsErrorInfo": false,
  "originalBottomRow": 104,
  "originalTopRow": 0,
  "parentColumnSpace": 20.25,
  "parentId": "5d9mv378b8",
  "parentRowSpace": 10,
  "renderMode": "CANVAS",
  "rightColumn": 64,
  "shouldScrollContents": true,
  "srcDoc": {
    "css": "@charset \"UTF-8\";\n/* Toolbar zoom */\n.planning-toolbar {\n  display: flex;\n  gap: 8px;\n  margin-bottom: 6px;\n}\n\n.planning-toolbar button {\n  font-size: 11px;\n  padding: 4px 8px;\n  border-radius: 4px;\n  border: 1px solid #d1d5db;\n  background: #f9fafb;\n  cursor: pointer;\n}\n\n.planning-toolbar button:hover {\n  background: #e5e7eb;\n}\n\n/* Le Gantt occupe tout l'espace du widget */\n#gantt_here {\n  width: 100%;\n  min-height: 1000px; /* hauteur minimum visible */\n}\n\n/* Couleurs des tâches suivant le statut */\n.gantt_task_line.status-A_FAIRE {\n  background-color: #cdd5df;\n  border-color: #b91c1c;\n}\n\n.gantt_task_line.status-EN_COURS {\n  background-color: #eab308;\n  border-color: #a16207;\n}\n\n.gantt_task_line.status-COMMENTAIRE_A_TRAITER {\n  background-color: #fc9c62;\n  border-color: #a16207;\n}\n\n.gantt_task_line.status-ATTENTE_CLIENT {\n  background-color: #7ac2f0;\n  border-color: #a16207;\n}\n\n.gantt_task_line.status-TERMINE,\n.gantt_task_line.status-VALIDE_CLIENT {\n  background-color: #22c55e;\n  border-color: #15803d;\n}\n\n/* Week-end légèrement grisé */\n.gantt_scale_cell.weekend,\n.gantt_task_cell.weekend {\n  background-color: #f3f4f6;\n}\n\n/* ===== Fond rouge léger pour le jour courant ===== */\n/* En-tête (échelle) */\n.gantt_scale_cell.today-scale {\n  background-color: #fee2e2; /* rouge très clair */\n}\n\n/* Cellules de la timeline */\n.gantt_task_cell.today-cell {\n  background-color: #fee2e2;\n}\n\n/* ===== Ligne rouge \"aujourd'hui\" ===== */\n.gantt_marker.today-marker {\n  z-index: 3; /* au-dessus des barres */\n}\n\n/* La vraie ligne rouge verticale */\n.gantt_marker.today-marker .gantt_marker_content {\n  background-color: #ef4444; /* rouge */\n  width: 2px;\n  margin-left: -1px; /* pour la centrer sur la date */\n}\n\n/* ===== JALON DELAI EN LOSANGE ===== */\n/* ===== JALON DELAI EN LOSANGE (corrigé) ===== */\n/* On neutralise la barre pour le jalon */\n.gantt_task_line.deadline-milestone {\n  background: transparent !important;\n  border: none !important;\n}\n\n/* On masque contenu & progression : on ne garde que le losange */\n.gantt_task_line.deadline-milestone .gantt_task_content,\n.gantt_task_line.deadline-milestone .gantt_task_progress {\n  display: none !important;\n}\n\n/* Losange centré sur la ligne (vert. & horiz.) */\n.gantt_task_line.deadline-milestone::before {\n  content: \"\";\n  position: absolute;\n  /* centre horizontalement sur la barre (donc sur le jour du délai) */\n  left: 50%;\n  margin-left: -5px;\n  /* centre verticalement sur la ligne */\n  top: 50%;\n  margin-top: -5px;\n  width: 10px;\n  height: 10px;\n  transform: rotate(45deg);\n  background: #cf3232; /* couleur du jalon */\n  border-radius: 2px;\n}\n\n/* ===== Jalons pour APPRO & ACHATS ===== */\n/* On supprime complètement la barre */\n.gantt_task_line.step-milestone {\n  background: transparent !important;\n  border: none !important;\n}\n\n/* On masque tout contenu interne */\n.gantt_task_line.step-milestone .gantt_task_content,\n.gantt_task_line.step-milestone .gantt_task_progress {\n  display: none !important;\n}\n\n/* On dessine un losange coloré selon statut */\n.gantt_task_line.step-milestone::before {\n  content: \"\";\n  position: absolute;\n  left: 50%;\n  top: 50%;\n  margin-left: -5px;\n  margin-top: -5px;\n  width: 10px;\n  height: 10px;\n  transform: rotate(45deg);\n  border-radius: 2px;\n  /* couleur via classe \"status-XXX\" */\n}\n\n/* Couleur via statut */\n.gantt_task_line.step-milestone.status-A_FAIRE::before {\n  background: #cdd5df;\n}\n\n.gantt_task_line.step-milestone.status-EN_COURS::before,\n.gantt_task_line.step-milestone.status-ATTENTE_CLIENT::before {\n  background: #eab308;\n}\n\n.gantt_task_line.step-milestone.status-TERMINE::before,\n.gantt_task_line.step-milestone.status-VALIDE_CLIENT::before {\n  background: #22c55e;\n}\n\n/* ===== Taille des textes ===== */\n/* Réduction taille du texte dans la grille (tableau à gauche) */\n.gantt_grid,\n.gantt_grid * {\n  font-size: 10px !important;\n}\n\n/* Réduction taille du texte dans la timeline */\n.gantt_task,\n.gantt_task * {\n  font-size: 10px !important;\n}\n\n/* Réduction taille du header grille */\n.gantt_grid_head_cell {\n  font-size: 11px !important;\n}\n\n/* Réduction taille du header timeline */\n.gantt_scale_cell {\n  font-size: 11px !important;\n}\n\n/* Barre de regroupement (ligne appareil) */\n.gantt_task_line.appareil-group {\n  background: #111 !important;\n  border-color: #111 !important;\n  border-radius: 6px !important;\n  height: 16px !important; /* barre plus \"fine\" */\n  margin-top: 6px !important; /* centre visuellement dans la ligne */\n}\n\n/* Texte à l'intérieur de la barre project (si affiché) */\n.gantt_task_line.appareil-group .gantt_task_content {\n  color: #fff !important;\n  font-weight: 600 !important;\n  font-size: 12px !important;\n}\n\n/* Optionnel : enlever le \"progress\" des projects */\n.gantt_task_line.appareil-group .gantt_task_progress {\n  display: none !important;\n}\n\n.gantt_task_line.appareil-group .gantt_task_content {\n  display: none !important;\n}\n\n.real-bar-layer {\n  position: absolute;\n  background: #10b981; /* vert */\n  border-radius: 3px;\n  pointer-events: none;\n  opacity: 0.95;\n}\n\n.gantt_task_line {\n  overflow: visible !important;\n}\n\n.real-bar-layer {\n  z-index: 9999 !important;\n}\n\n/* IMPORTANT : le layer est dans ces conteneurs, pas dans gantt_task_line */\n.gantt_task_data,\n.gantt_task_bars {\n  overflow: visible !important;\n}\n\n.task-wrap {\n  position: relative;\n  width: 100%;\n  height: 100%;\n  display: flex;\n  align-items: center;\n  justify-content: center;\n}\n\n.task-label {\n  position: relative;\n  z-index: 2;\n}\n\n.real-point {\n  position: absolute;\n  bottom: 2px;\n  transform: translateX(-1px);\n  width: 2px;\n  height: 10px;\n  background: #000;\n  z-index: 3;\n  border-radius: 1px;\n  opacity: 0.95;\n}\n\n.real-range {\n  position: absolute;\n  bottom: 2px;\n  height: 6px;\n  background: #000;\n  z-index: 3;\n  border-radius: 3px;\n  opacity: 0.95;\n}\n\n.real-overlay {\n  position: absolute;\n  left: 0;\n  top: 0;\n  width: 100%;\n  height: 100%;\n  pointer-events: none;\n  z-index: 9999;\n}\n\n.real-bar-layer {\n  position: absolute;\n  background: #000;\n  border-radius: 3px;\n  opacity: 0.95;\n}",
    "html": "<link\n  rel=\"stylesheet\"\n  href=\"https://cdn.dhtmlx.com/gantt/edge/dhtmlxgantt.css\"\n/>\n\n<div class=\"planning-toolbar\">\n  <button data-zoom=\"day\">Jour</button>\n  <button data-zoom=\"week\">Semaine</button>\n  <button data-zoom=\"month\">Mois</button>\n</div>\n\n<div id=\"gantt_here\"></div>\n",
    "js": "// -------- Helpers généraux --------\nfunction parseIsoToDate(iso) {\n  if (!iso || !window.gantt) return null;\n  const d = gantt.date.parseDate(String(iso).slice(0, 10), \"%Y-%m-%d\");\n  return d instanceof Date && !isNaN(+d) ? d : null;\n}\nfunction expandTimelineRangeFromReal(tasks, marginDays = 30) {\n  let minD = null;\n  let maxD = null;\n  (tasks || []).forEach(t => {\n    const ps = parseIsoToDate(t.start_date);\n    const pe = parseIsoToDate(t.end_date);\n    const rs = parseIsoToDate(t.real_start || t.real_end);\n    const re = parseIsoToDate(t.real_end);\n    [ps, pe, rs, re].forEach(d => {\n      if (!d) return;\n      if (!minD || d < minD) minD = d;\n      if (!maxD || d > maxD) maxD = d;\n    });\n  });\n  if (!minD || !maxD) return;\n  const start = new Date(minD);\n  start.setDate(start.getDate() - marginDays);\n  const end = new Date(maxD);\n  end.setDate(end.getDate() + marginDays);\n  gantt.config.start_date = start;\n  gantt.config.end_date = end;\n}\n\n// Ramène une date (YYYY-MM-DD) au dernier jour ouvré si elle tombe le week-end\nfunction normalizeToBusinessEnd(endIso) {\n  if (!endIso) return null;\n  const d = new Date(endIso + \"T00:00:00Z\");\n  const day = d.getUTCDay(); // 0 dim, 6 sam\n  if (day === 0) d.setUTCDate(d.getUTCDate() - 2);else if (day === 6) d.setUTCDate(d.getUTCDate() - 1);\n  return d.toISOString().slice(0, 10);\n}\n\n// Ramène une date (YYYY-MM-DD) au prochain jour ouvré si elle tombe le week-end\nfunction normalizeToBusinessStart(startIso) {\n  if (!startIso) return null;\n  const d = new Date(startIso + \"T00:00:00Z\");\n  const day = d.getUTCDay();\n  if (day === 6) d.setUTCDate(d.getUTCDate() + 2);else if (day === 0) d.setUTCDate(d.getUTCDate() + 1);\n  return d.toISOString().slice(0, 10);\n}\n\n// -------- Overlay \"réel\" --------\nfunction ensureRealOverlayContainer() {\n  // ✅ IMPORTANT : conteneur où getTaskPosition calcule pos.top/left\n  const taskData = gantt && gantt.$task_data;\n  if (!taskData) return null;\n  let c = taskData.querySelector(\":scope > .real-overlay\");\n  if (!c) {\n    c = document.createElement(\"div\");\n    c.className = \"real-overlay\";\n    taskData.appendChild(c);\n  }\n  return c;\n}\nfunction renderRealOverlays() {\n  const container = ensureRealOverlayContainer();\n  if (!container) return;\n\n  // reset\n  container.innerHTML = \"\";\n  const barH = 6;\n  const taskH = gantt.config.task_height || 18;\n\n  // on parcourt toutes les tâches (inclut celles hors écran, mais OK)\n  gantt.eachTask(function (task) {\n    if (task.type === \"project\" || task.isDeadline) return;\n    if (!task.real_end) return;\n    const startIso = task.real_start || task.real_end; // jalon => start=end\n    const endIso = task.real_end;\n    const sIso = normalizeToBusinessStart(String(startIso).slice(0, 10));\n    const eIso = normalizeToBusinessEnd(String(endIso).slice(0, 10));\n    if (!sIso || !eIso) return;\n    const s = gantt.date.parseDate(sIso, \"%Y-%m-%d\");\n    const eInc = gantt.date.parseDate(eIso, \"%Y-%m-%d\");\n    if (!(s instanceof Date) || isNaN(+s)) return;\n    if (!(eInc instanceof Date) || isNaN(+eInc)) return;\n\n    // end exclusive (+1 jour)\n    const e = new Date(eInc);\n    e.setDate(e.getDate() + 1);\n\n    // ✅ position du \"réel\" dans la timeline\n    const pos = gantt.getTaskPosition(task, s, e);\n    if (!pos) return;\n    const el = document.createElement(\"div\");\n    el.className = \"real-bar-layer\";\n    el.style.left = pos.left + \"px\";\n\n    // ✅ SOUS la barre prévue, MAIS dans la même ligne\n    const gap = 20; // espace entre vert et noir (mets 0 si tu veux collé)\n    el.style.top = pos.top + taskH - barH + gap + \"px\";\n    el.style.width = Math.max(pos.width, 10) + \"px\";\n    el.style.height = barH + \"px\";\n    container.appendChild(el);\n  });\n}\n\n// -------- UI helpers --------\nfunction computeTaskColumnWidth(tasks) {\n  let maxChars = 10;\n  (tasks || []).forEach(t => {\n    const label = t.type === \"project\" ? t.nom_appareil || t.text || \"\" : t.text || \"\";\n    if (label.length > maxChars) maxChars = label.length;\n  });\n  return Math.min(maxChars * 7 + 40, 600);\n}\nfunction ensureGanttLoaded() {\n  if (window.gantt) return Promise.resolve();\n  if (window.ganttLoading) return window.ganttLoading;\n  window.ganttLoading = new Promise((resolve, reject) => {\n    const script = document.createElement(\"script\");\n    script.src = \"https://cdn.dhtmlx.com/gantt/edge/dhtmlxgantt.js\";\n    script.onload = () => resolve();\n    script.onerror = reject;\n    document.head.appendChild(script);\n  });\n  return window.ganttLoading;\n}\nfunction formatDateFr(isoStr) {\n  if (!isoStr) return \"\";\n  const s = String(isoStr).slice(0, 10);\n  const [y, m, d] = s.split(\"-\");\n  if (!y || !m || !d) return s;\n  return `${d}-${m}-${y}`;\n}\n\n// -------- Helpers jours ouvrés --------\nfunction parsePositiveInt(val) {\n  const n = parseInt(val, 10);\n  return Number.isFinite(n) && n > 0 ? n : null;\n}\nfunction subtractBusinessDays(endIso, nbDays) {\n  if (!endIso) return null;\n  const d = new Date(endIso + \"T00:00:00Z\");\n  let remaining = Math.max(nbDays - 1, 0);\n  while (remaining > 0) {\n    d.setUTCDate(d.getUTCDate() - 1);\n    const day = d.getUTCDay();\n    if (day !== 0 && day !== 6) remaining--;\n  }\n  return d.toISOString().slice(0, 10);\n}\nfunction computeChildTaskDates(etape) {\n  const code = etape.groupe_code;\n  if (code === \"FABRICATION\") {\n    const rawStart = etape.date_debut;\n    const rawEnd = etape.date_objectif || etape.date_fin;\n    if (!rawStart || !rawEnd) return null;\n    const startIso = String(rawStart).slice(0, 10);\n    const endIso = String(rawEnd).slice(0, 10);\n    const endBusiness = normalizeToBusinessEnd(endIso);\n    if (!endBusiness) return null;\n    const dEnd = new Date(endBusiness + \"T00:00:00Z\");\n    dEnd.setUTCDate(dEnd.getUTCDate() + 1);\n    return {\n      startStr: startIso,\n      endStr: dEnd.toISOString().slice(0, 10)\n    };\n  }\n  const rawEnd = etape.date_objectif || etape.date_fin;\n  if (!rawEnd) return null;\n  const endBusiness = normalizeToBusinessEnd(String(rawEnd).slice(0, 10));\n  if (!endBusiness) return null;\n  const nbJours = parsePositiveInt(etape.nombre_jours) || 1;\n  const startStr = subtractBusinessDays(endBusiness, nbJours);\n  const dEnd = new Date(endBusiness + \"T00:00:00Z\");\n  dEnd.setUTCDate(dEnd.getUTCDate() + 1);\n  return {\n    startStr,\n    endStr: dEnd.toISOString().slice(0, 10)\n  };\n}\n\n// -------- Zoom --------\nfunction setScale(level) {\n  if (!window.gantt) return;\n  switch (level) {\n    case \"day\":\n      gantt.config.scales = [{\n        unit: \"month\",\n        step: 1,\n        format: \"%F %Y\"\n      }, {\n        unit: \"day\",\n        step: 1,\n        format: \"%d\"\n      }];\n      break;\n    case \"month\":\n      gantt.config.scales = [{\n        unit: \"year\",\n        step: 1,\n        format: \"%Y\"\n      }, {\n        unit: \"month\",\n        step: 1,\n        format: \"%M\"\n      }];\n      break;\n    case \"week\":\n    default:\n      gantt.config.scales = [{\n        unit: \"year\",\n        step: 1,\n        format: \"%Y\"\n      }, {\n        unit: \"week\",\n        step: 1,\n        format: date => \"S\" + gantt.date.date_to_str(\"%W\")(date)\n      }, {\n        unit: \"day\",\n        step: 1,\n        format: \"%d\"\n      }];\n      break;\n  }\n  gantt.render();\n}\n\n// ----- Marqueur \"aujourd'hui\" -----\nfunction refreshTodayMarker() {\n  if (!window.gantt || !gantt.addMarker) return;\n  const today = new Date();\n  if (window.todayMarkerId) gantt.deleteMarker(window.todayMarkerId);\n  window.todayMarkerId = gantt.addMarker({\n    start_date: today,\n    css: \"today-marker\",\n    text: \"\",\n    title: \"\"\n  });\n  gantt.renderMarkers();\n}\nfunction centerOnToday(offsetRatio = 0.5) {\n  if (!window.gantt) return;\n  const today = new Date();\n  const posX = gantt.posFromDate(today);\n  const viewWidth = gantt.$task.offsetWidth;\n  gantt.scrollTo(posX - Math.floor(viewWidth * offsetRatio), null);\n}\n\n// -------- Mapping data --------\nfunction mapRowsToGantt(rows) {\n  const tasks = [];\n  const links = [];\n  rows.forEach(r => {\n    const appareilId = String(r.numero_appareil);\n    const etapes = Array.isArray(r.etapes) ? r.etapes : [];\n    const delaiStr = r.delai ? String(r.delai).slice(0, 10) : null;\n    const today = new Date().toISOString().slice(0, 10);\n    const preparedEtapes = [];\n    etapes.forEach((e, idx) => {\n      const dates = computeChildTaskDates(e);\n      if (!dates) return;\n      preparedEtapes.push({\n        e,\n        idx,\n        startStr: dates.startStr,\n        endStr: dates.endStr\n      });\n    });\n    let firstStepStart = null;\n    let lastStepEnd = null;\n    preparedEtapes.forEach(p => {\n      if (!firstStepStart || p.startStr < firstStepStart) firstStepStart = p.startStr;\n      if (!lastStepEnd || p.endStr > lastStepEnd) lastStepEnd = p.endStr;\n    });\n    const projectStart = firstStepStart || delaiStr || today;\n    const projectEnd = delaiStr || lastStepEnd || projectStart;\n    tasks.push({\n      id: appareilId,\n      text: r.nom_appareil || \"\",\n      nom_appareil: r.nom_appareil,\n      start_date: projectStart,\n      end_date: projectEnd,\n      delai: delaiStr,\n      type: \"project\",\n      open: true\n    });\n    const stepIdByCode = {};\n    preparedEtapes.forEach(p => {\n      const e = p.e;\n      const idx = p.idx;\n      const code = e.groupe_code || `ETAPE_${idx}`;\n      const libelle = e.groupe_libelle || code;\n      const childId = `${appareilId}_${code}_${idx}`;\n      const isAppro = code === \"BESOINS\";\n      const isAchats = code === \"ACHATS\";\n      tasks.push({\n        id: childId,\n        text: libelle,\n        start_date: p.startStr,\n        end_date: p.endStr,\n        parent: appareilId,\n        progress: 0,\n        status: e.statut_code,\n        date_objectif: e.date_objectif ? String(e.date_objectif).slice(0, 10) : null,\n        nombre_jours: e.nombre_jours,\n        groupe_code: e.groupe_code,\n        groupe_appareil_id: e.groupe_appareil_id,\n        isStepMilestone: isAppro || isAchats,\n        // ✅ réel\n        real_start: e.date_debut_reel ? String(e.date_debut_reel).slice(0, 10) : null,\n        real_end: e.date_fin_reel ? String(e.date_fin_reel).slice(0, 10) : null\n      });\n      stepIdByCode[code] = childId;\n    });\n    function addLink(srcCode, tgtCode) {\n      const source = stepIdByCode[srcCode];\n      const target = stepIdByCode[tgtCode];\n      if (!source || !target) return;\n      links.push({\n        id: `${source}->${target}`,\n        source,\n        target,\n        type: 0\n      });\n    }\n    addLink(\"NOTE_CALCUL\", \"PLAN\");\n    addLink(\"PLAN\", \"CAHIER_SOUDAGE\");\n    addLink(\"PLAN\", \"PREPARATION\");\n    addLink(\"PREPARATION\", \"BESOINS\");\n    addLink(\"PREPARATION\", \"ACHATS\");\n    addLink(\"BESOINS\", \"FABRICATION\");\n    addLink(\"ACHATS\", \"FABRICATION\");\n    if (delaiStr) {\n      tasks.push({\n        id: appareilId + \"_deadline\",\n        text: \"Délai\",\n        start_date: delaiStr,\n        parent: appareilId,\n        isDeadline: true,\n        date_objectif: delaiStr\n      });\n    }\n  });\n  return {\n    data: tasks,\n    links\n  };\n}\n\n// -------- Initialisation + rendu --------\nasync function renderGantt() {\n  const rows = appsmith.model && appsmith.model.rows || [];\n  if (!Array.isArray(rows) || !rows.length) return;\n  await ensureGanttLoaded();\n  const ganttData = mapRowsToGantt(rows);\n  const idealWidth = computeTaskColumnWidth(ganttData.data);\n  if (!window.ganttInitialized) {\n    if (gantt.plugins) gantt.plugins({\n      marker: true\n    });\n    gantt.config.show_markers = true;\n    gantt.config.readonly = true;\n    gantt.config.date_format = \"%Y-%m-%d\";\n    gantt.config.min_column_width = 30;\n    gantt.config.grid_resize = true;\n    gantt.config.row_height = 42;\n    gantt.config.task_height = 18;\n    gantt.config.columns = [{\n      name: \"text\",\n      label: \"Désignation\",\n      tree: true,\n      width: idealWidth,\n      min_width: 120,\n      template: task => task.type === \"project\" ? task.nom_appareil || task.text : task.text\n    }, {\n      name: \"start_custom\",\n      label: \"Date obj.\",\n      align: \"center\",\n      width: 100,\n      template: task => {\n        if (task.type === \"project\") return formatDateFr(task.delai || task.start_date);\n        return formatDateFr(task.date_objectif || task.start_date);\n      }\n    }];\n\n    // styles cellules (weekend + today)\n    const todayStr = new Date().toISOString().slice(0, 10);\n    const fmtIso = gantt.date.date_to_str(\"%Y-%m-%d\");\n    gantt.templates.scale_cell_class = function (date) {\n      const day = date.getDay();\n      const dStr = fmtIso(date);\n      const classes = [];\n      if (day === 0 || day === 6) classes.push(\"weekend\");\n      if (dStr === todayStr) classes.push(\"today-scale\");\n      return classes.join(\" \");\n    };\n    gantt.templates.timeline_cell_class = function (task, date) {\n      const day = date.getDay();\n      const dStr = fmtIso(date);\n      const classes = [];\n      if (day === 0 || day === 6) classes.push(\"weekend\");\n      if (dStr === todayStr) classes.push(\"today-cell\");\n      return classes.join(\" \");\n    };\n    gantt.templates.task_class = function (start, end, task) {\n      const classes = [];\n      if (task.type === \"project\") classes.push(\"appareil-group\");\n      if (task.isDeadline) classes.push(\"deadline-milestone\");\n      if (task.isStepMilestone) classes.push(\"step-milestone\");\n      if (task.status) classes.push(\"status-\" + task.status);\n      return classes.join(\" \");\n    };\n    gantt.init(\"gantt_here\");\n    window.ganttInitialized = true;\n\n    // ✅ redraw overlay à chaque rendu + scroll\n    gantt.attachEvent(\"onGanttRender\", function () {\n      renderRealOverlays();\n      return true;\n    });\n    gantt.attachEvent(\"onTaskScroll\", function () {\n      renderRealOverlays();\n      return true;\n    });\n    setScale(\"week\");\n    const toolbar = document.querySelector(\".planning-toolbar\");\n    if (toolbar) {\n      toolbar.addEventListener(\"click\", function (e) {\n        const btn = e.target.closest(\"button[data-zoom]\");\n        if (!btn) return;\n        setScale(btn.getAttribute(\"data-zoom\"));\n      });\n    }\n  } else {\n    if (gantt.config.columns && gantt.config.columns.length > 0) {\n      gantt.config.columns[0].width = idealWidth;\n    }\n  }\n  gantt.clearAll();\n\n  // ✅ IMPORTANT : étendre la plage AVANT parse/render\n  expandTimelineRangeFromReal(ganttData.data, 30);\n  gantt.parse(ganttData);\n  gantt.render();\n  refreshTodayMarker();\n  setTimeout(centerOnToday, 50);\n}\nappsmith.onReady(renderGantt);\nappsmith.onModelChange(renderGantt);"
  },
  "theme": "{{appsmith.theme}}",
  "topRow": 0,
  "type": "CUSTOM_WIDGET",
  "uncompiledSrcDoc": {
    "css": "/* Toolbar zoom */\n.planning-toolbar {\n  display: flex;\n  gap: 8px;\n  margin-bottom: 6px;\n}\n\n.planning-toolbar button {\n  font-size: 11px;\n  padding: 4px 8px;\n  border-radius: 4px;\n  border: 1px solid #d1d5db;\n  background: #f9fafb;\n  cursor: pointer;\n}\n\n.planning-toolbar button:hover {\n  background: #e5e7eb;\n}\n\n/* Le Gantt occupe tout l'espace du widget */\n#gantt_here {\n  width: 100%;\n  min-height: 1000px; /* hauteur minimum visible */\n}\n\n/* Couleurs des tâches suivant le statut */\n.gantt_task_line.status-A_FAIRE {\n  background-color: #cdd5df;\n  border-color: #b91c1c;\n}\n\n.gantt_task_line.status-EN_COURS {\n  background-color: #eab308;\n  border-color: #a16207;\n}\n\n.gantt_task_line.status-COMMENTAIRE_A_TRAITER {\n  background-color: #fc9c62;\n  border-color: #a16207;\n}\n\n.gantt_task_line.status-ATTENTE_CLIENT {\n  background-color: #7ac2f0;\n  border-color: #a16207;\n}\n\n.gantt_task_line.status-TERMINE,\n.gantt_task_line.status-VALIDE_CLIENT {\n  background-color: #22c55e;\n  border-color: #15803d;\n}\n\n/* Week-end légèrement grisé */\n.gantt_scale_cell.weekend,\n.gantt_task_cell.weekend {\n  background-color: #f3f4f6;\n}\n\n/* ===== Fond rouge léger pour le jour courant ===== */\n\n/* En-tête (échelle) */\n.gantt_scale_cell.today-scale {\n  background-color: #fee2e2; /* rouge très clair */\n}\n\n/* Cellules de la timeline */\n.gantt_task_cell.today-cell {\n  background-color: #fee2e2;\n}\n\n/* ===== Ligne rouge \"aujourd'hui\" ===== */\n\n.gantt_marker.today-marker {\n  z-index: 3; /* au-dessus des barres */\n}\n\n/* La vraie ligne rouge verticale */\n.gantt_marker.today-marker .gantt_marker_content {\n  background-color: #ef4444; /* rouge */\n  width: 2px;\n  margin-left: -1px; /* pour la centrer sur la date */\n}\n\n\n/* ===== JALON DELAI EN LOSANGE ===== */\n/* ===== JALON DELAI EN LOSANGE (corrigé) ===== */\n\n/* On neutralise la barre pour le jalon */\n.gantt_task_line.deadline-milestone {\n  background: transparent !important;\n  border: none !important;\n}\n\n/* On masque contenu & progression : on ne garde que le losange */\n.gantt_task_line.deadline-milestone .gantt_task_content,\n.gantt_task_line.deadline-milestone .gantt_task_progress {\n  display: none !important;\n}\n\n/* Losange centré sur la ligne (vert. & horiz.) */\n.gantt_task_line.deadline-milestone::before {\n  content: \"\";\n  position: absolute;\n\n  /* centre horizontalement sur la barre (donc sur le jour du délai) */\n  left: 50%;\n  margin-left: -5px;\n\n  /* centre verticalement sur la ligne */\n  top: 50%;\n  margin-top: -5px;\n\n  width: 10px;\n  height: 10px;\n\n  transform: rotate(45deg);\n  background: #cf3232;   /* couleur du jalon */\n  border-radius: 2px;\n}\n\n/* ===== Jalons pour APPRO & ACHATS ===== */\n\n/* On supprime complètement la barre */\n.gantt_task_line.step-milestone {\n  background: transparent !important;\n  border: none !important;\n}\n\n/* On masque tout contenu interne */\n.gantt_task_line.step-milestone .gantt_task_content,\n.gantt_task_line.step-milestone .gantt_task_progress {\n  display: none !important;\n}\n\n/* On dessine un losange coloré selon statut */\n.gantt_task_line.step-milestone::before {\n  content: \"\";\n  position: absolute;\n\n  left: 50%;\n  top: 50%;\n  margin-left: -5px;\n  margin-top: -5px;\n\n  width: 10px;\n  height: 10px;\n\n  transform: rotate(45deg);\n  border-radius: 2px;\n\n  /* couleur via classe \"status-XXX\" */\n}\n\n/* Couleur via statut */\n.gantt_task_line.step-milestone.status-A_FAIRE::before {\n  background: #cdd5df;\n}\n.gantt_task_line.step-milestone.status-EN_COURS::before,\n.gantt_task_line.step-milestone.status-ATTENTE_CLIENT::before {\n  background: #eab308;\n}\n.gantt_task_line.step-milestone.status-TERMINE::before,\n.gantt_task_line.step-milestone.status-VALIDE_CLIENT::before {\n  background: #22c55e;\n}\n\n\n/* ===== Taille des textes ===== */\n\n/* Réduction taille du texte dans la grille (tableau à gauche) */\n.gantt_grid,\n.gantt_grid * {\n  font-size: 10px !important;\n}\n\n/* Réduction taille du texte dans la timeline */\n.gantt_task,\n.gantt_task * {\n  font-size: 10px !important;\n}\n\n/* Réduction taille du header grille */\n.gantt_grid_head_cell {\n  font-size: 11px !important;\n}\n\n/* Réduction taille du header timeline */\n.gantt_scale_cell {\n  font-size: 11px !important;\n}\n\n/* Barre de regroupement (ligne appareil) */\n.gantt_task_line.appareil-group {\n  background: #111 !important;\n  border-color: #111 !important;\n  border-radius: 6px !important;\n  height: 16px !important;          /* barre plus \"fine\" */\n  margin-top: 6px !important;       /* centre visuellement dans la ligne */\n}\n\n/* Texte à l'intérieur de la barre project (si affiché) */\n.gantt_task_line.appareil-group .gantt_task_content {\n  color: #fff !important;\n  font-weight: 600 !important;\n  font-size: 12px !important;\n}\n\n/* Optionnel : enlever le \"progress\" des projects */\n.gantt_task_line.appareil-group .gantt_task_progress {\n  display: none !important;\n}\n\n.gantt_task_line.appareil-group .gantt_task_content {\n  display: none !important;\n}\n.real-bar-layer{\n  position:absolute;\n  background:#10b981;     /* vert */\n  border-radius:3px;\n  pointer-events:none;\n  opacity:0.95;\n}\n.gantt_task_line { overflow: visible !important; }\n.real-bar-layer { z-index: 9999 !important; }\n\n\n/* IMPORTANT : le layer est dans ces conteneurs, pas dans gantt_task_line */\n.gantt_task_data,\n.gantt_task_bars {\n  overflow: visible !important;\n}\n.task-wrap{\n  position:relative;\n  width:100%;\n  height:100%;\n  display:flex;\n  align-items:center;\n  justify-content:center;\n}\n\n.task-label{\n  position:relative;\n  z-index:2;\n}\n\n.real-point{\n  position:absolute;\n  bottom:2px;\n  transform:translateX(-1px);\n  width:2px;\n  height:10px;\n  background:#000;\n  z-index:3;\n  border-radius:1px;\n  opacity:0.95;\n}\n\n.real-range{\n  position:absolute;\n  bottom:2px;\n  height:6px;\n  background:#000;\n  z-index:3;\n  border-radius:3px;\n  opacity:0.95;\n}\n\n.real-overlay{\n  position:absolute;\n  left:0;\n  top:0;\n  width:100%;\n  height:100%;\n  pointer-events:none;\n  z-index:9999;\n}\n\n.real-bar-layer{\n  position:absolute;\n  background:#000;\n  border-radius:3px;\n  opacity:0.95;\n}\n\n",
    "html": "<link\n  rel=\"stylesheet\"\n  href=\"https://cdn.dhtmlx.com/gantt/edge/dhtmlxgantt.css\"\n/>\n\n<div class=\"planning-toolbar\">\n  <button data-zoom=\"day\">Jour</button>\n  <button data-zoom=\"week\">Semaine</button>\n  <button data-zoom=\"month\">Mois</button>\n</div>\n\n<div id=\"gantt_here\"></div>\n",
    "js": "// -------- Helpers généraux --------\nfunction parseIsoToDate(iso) {\n  if (!iso || !window.gantt) return null;\n  const d = gantt.date.parseDate(String(iso).slice(0, 10), \"%Y-%m-%d\");\n  return d instanceof Date && !isNaN(+d) ? d : null;\n}\n\nfunction expandTimelineRangeFromReal(tasks, marginDays = 30) {\n  let minD = null;\n  let maxD = null;\n\n  (tasks || []).forEach((t) => {\n    const ps = parseIsoToDate(t.start_date);\n    const pe = parseIsoToDate(t.end_date);\n    const rs = parseIsoToDate(t.real_start || t.real_end);\n    const re = parseIsoToDate(t.real_end);\n\n    [ps, pe, rs, re].forEach((d) => {\n      if (!d) return;\n      if (!minD || d < minD) minD = d;\n      if (!maxD || d > maxD) maxD = d;\n    });\n  });\n\n  if (!minD || !maxD) return;\n\n  const start = new Date(minD);\n  start.setDate(start.getDate() - marginDays);\n\n  const end = new Date(maxD);\n  end.setDate(end.getDate() + marginDays);\n\n  gantt.config.start_date = start;\n  gantt.config.end_date = end;\n}\n\n// Ramène une date (YYYY-MM-DD) au dernier jour ouvré si elle tombe le week-end\nfunction normalizeToBusinessEnd(endIso) {\n  if (!endIso) return null;\n  const d = new Date(endIso + \"T00:00:00Z\");\n  const day = d.getUTCDay(); // 0 dim, 6 sam\n  if (day === 0) d.setUTCDate(d.getUTCDate() - 2);\n  else if (day === 6) d.setUTCDate(d.getUTCDate() - 1);\n  return d.toISOString().slice(0, 10);\n}\n\n// Ramène une date (YYYY-MM-DD) au prochain jour ouvré si elle tombe le week-end\nfunction normalizeToBusinessStart(startIso) {\n  if (!startIso) return null;\n  const d = new Date(startIso + \"T00:00:00Z\");\n  const day = d.getUTCDay();\n  if (day === 6) d.setUTCDate(d.getUTCDate() + 2);\n  else if (day === 0) d.setUTCDate(d.getUTCDate() + 1);\n  return d.toISOString().slice(0, 10);\n}\n\n// -------- Overlay \"réel\" --------\nfunction ensureRealOverlayContainer() {\n  // ✅ IMPORTANT : conteneur où getTaskPosition calcule pos.top/left\n  const taskData = gantt && gantt.$task_data;\n  if (!taskData) return null;\n\n  let c = taskData.querySelector(\":scope > .real-overlay\");\n  if (!c) {\n    c = document.createElement(\"div\");\n    c.className = \"real-overlay\";\n    taskData.appendChild(c);\n  }\n  return c;\n}\n\nfunction renderRealOverlays() {\n  const container = ensureRealOverlayContainer();\n  if (!container) return;\n\n  // reset\n  container.innerHTML = \"\";\n\n  const barH = 6;\n  const taskH = gantt.config.task_height || 18;\n\n  // on parcourt toutes les tâches (inclut celles hors écran, mais OK)\n  gantt.eachTask(function (task) {\n    if (task.type === \"project\" || task.isDeadline) return;\n    if (!task.real_end) return;\n\n    const startIso = task.real_start || task.real_end; // jalon => start=end\n    const endIso = task.real_end;\n\n    const sIso = normalizeToBusinessStart(String(startIso).slice(0, 10));\n    const eIso = normalizeToBusinessEnd(String(endIso).slice(0, 10));\n    if (!sIso || !eIso) return;\n\n    const s = gantt.date.parseDate(sIso, \"%Y-%m-%d\");\n    const eInc = gantt.date.parseDate(eIso, \"%Y-%m-%d\");\n    if (!(s instanceof Date) || isNaN(+s)) return;\n    if (!(eInc instanceof Date) || isNaN(+eInc)) return;\n\n    // end exclusive (+1 jour)\n    const e = new Date(eInc);\n    e.setDate(e.getDate() + 1);\n\n    // ✅ position du \"réel\" dans la timeline\n    const pos = gantt.getTaskPosition(task, s, e);\n    if (!pos) return;\n\n    const el = document.createElement(\"div\");\n    el.className = \"real-bar-layer\";\n    el.style.left = pos.left + \"px\";\n\n    // ✅ SOUS la barre prévue, MAIS dans la même ligne\n   \tconst gap = 20; // espace entre vert et noir (mets 0 si tu veux collé)\n\t\tel.style.top = (pos.top + taskH - barH + gap) + \"px\";\n\n    el.style.width = Math.max(pos.width, 10) + \"px\";\n    el.style.height = barH + \"px\";\n    container.appendChild(el);\n  });\n}\n\n// -------- UI helpers --------\nfunction computeTaskColumnWidth(tasks) {\n  let maxChars = 10;\n  (tasks || []).forEach((t) => {\n    const label = t.type === \"project\" ? (t.nom_appareil || t.text || \"\") : (t.text || \"\");\n    if (label.length > maxChars) maxChars = label.length;\n  });\n  return Math.min(maxChars * 7 + 40, 600);\n}\n\nfunction ensureGanttLoaded() {\n  if (window.gantt) return Promise.resolve();\n  if (window.ganttLoading) return window.ganttLoading;\n\n  window.ganttLoading = new Promise((resolve, reject) => {\n    const script = document.createElement(\"script\");\n    script.src = \"https://cdn.dhtmlx.com/gantt/edge/dhtmlxgantt.js\";\n    script.onload = () => resolve();\n    script.onerror = reject;\n    document.head.appendChild(script);\n  });\n\n  return window.ganttLoading;\n}\n\nfunction formatDateFr(isoStr) {\n  if (!isoStr) return \"\";\n  const s = String(isoStr).slice(0, 10);\n  const [y, m, d] = s.split(\"-\");\n  if (!y || !m || !d) return s;\n  return `${d}-${m}-${y}`;\n}\n\n// -------- Helpers jours ouvrés --------\nfunction parsePositiveInt(val) {\n  const n = parseInt(val, 10);\n  return Number.isFinite(n) && n > 0 ? n : null;\n}\n\nfunction subtractBusinessDays(endIso, nbDays) {\n  if (!endIso) return null;\n  const d = new Date(endIso + \"T00:00:00Z\");\n  let remaining = Math.max(nbDays - 1, 0);\n\n  while (remaining > 0) {\n    d.setUTCDate(d.getUTCDate() - 1);\n    const day = d.getUTCDay();\n    if (day !== 0 && day !== 6) remaining--;\n  }\n  return d.toISOString().slice(0, 10);\n}\n\nfunction computeChildTaskDates(etape) {\n  const code = etape.groupe_code;\n\n  if (code === \"FABRICATION\") {\n    const rawStart = etape.date_debut;\n    const rawEnd = etape.date_objectif || etape.date_fin;\n    if (!rawStart || !rawEnd) return null;\n\n    const startIso = String(rawStart).slice(0, 10);\n    const endIso = String(rawEnd).slice(0, 10);\n\n    const endBusiness = normalizeToBusinessEnd(endIso);\n    if (!endBusiness) return null;\n\n    const dEnd = new Date(endBusiness + \"T00:00:00Z\");\n    dEnd.setUTCDate(dEnd.getUTCDate() + 1);\n\n    return { startStr: startIso, endStr: dEnd.toISOString().slice(0, 10) };\n  }\n\n  const rawEnd = etape.date_objectif || etape.date_fin;\n  if (!rawEnd) return null;\n\n  const endBusiness = normalizeToBusinessEnd(String(rawEnd).slice(0, 10));\n  if (!endBusiness) return null;\n\n  const nbJours = parsePositiveInt(etape.nombre_jours) || 1;\n  const startStr = subtractBusinessDays(endBusiness, nbJours);\n\n  const dEnd = new Date(endBusiness + \"T00:00:00Z\");\n  dEnd.setUTCDate(dEnd.getUTCDate() + 1);\n\n  return { startStr, endStr: dEnd.toISOString().slice(0, 10) };\n}\n\n// -------- Zoom --------\nfunction setScale(level) {\n  if (!window.gantt) return;\n\n  switch (level) {\n    case \"day\":\n      gantt.config.scales = [\n        { unit: \"month\", step: 1, format: \"%F %Y\" },\n        { unit: \"day\", step: 1, format: \"%d\" },\n      ];\n      break;\n    case \"month\":\n      gantt.config.scales = [\n        { unit: \"year\", step: 1, format: \"%Y\" },\n        { unit: \"month\", step: 1, format: \"%M\" },\n      ];\n      break;\n    case \"week\":\n    default:\n      gantt.config.scales = [\n        { unit: \"year\", step: 1, format: \"%Y\" },\n        { unit: \"week\", step: 1, format: (date) => \"S\" + gantt.date.date_to_str(\"%W\")(date) },\n        { unit: \"day\", step: 1, format: \"%d\" },\n      ];\n      break;\n  }\n  gantt.render();\n}\n\n// ----- Marqueur \"aujourd'hui\" -----\nfunction refreshTodayMarker() {\n  if (!window.gantt || !gantt.addMarker) return;\n  const today = new Date();\n  if (window.todayMarkerId) gantt.deleteMarker(window.todayMarkerId);\n  window.todayMarkerId = gantt.addMarker({ start_date: today, css: \"today-marker\", text: \"\", title: \"\" });\n  gantt.renderMarkers();\n}\n\nfunction centerOnToday(offsetRatio = 0.5) {\n  if (!window.gantt) return;\n  const today = new Date();\n  const posX = gantt.posFromDate(today);\n  const viewWidth = gantt.$task.offsetWidth;\n  gantt.scrollTo(posX - Math.floor(viewWidth * offsetRatio), null);\n}\n\n// -------- Mapping data --------\nfunction mapRowsToGantt(rows) {\n  const tasks = [];\n  const links = [];\n\n  rows.forEach((r) => {\n    const appareilId = String(r.numero_appareil);\n    const etapes = Array.isArray(r.etapes) ? r.etapes : [];\n\n    const delaiStr = r.delai ? String(r.delai).slice(0, 10) : null;\n    const today = new Date().toISOString().slice(0, 10);\n\n    const preparedEtapes = [];\n    etapes.forEach((e, idx) => {\n      const dates = computeChildTaskDates(e);\n      if (!dates) return;\n      preparedEtapes.push({ e, idx, startStr: dates.startStr, endStr: dates.endStr });\n    });\n\n    let firstStepStart = null;\n    let lastStepEnd = null;\n    preparedEtapes.forEach((p) => {\n      if (!firstStepStart || p.startStr < firstStepStart) firstStepStart = p.startStr;\n      if (!lastStepEnd || p.endStr > lastStepEnd) lastStepEnd = p.endStr;\n    });\n\n    const projectStart = firstStepStart || delaiStr || today;\n    const projectEnd = delaiStr || lastStepEnd || projectStart;\n\n    tasks.push({\n      id: appareilId,\n      text: r.nom_appareil || \"\",\n      nom_appareil: r.nom_appareil,\n      start_date: projectStart,\n      end_date: projectEnd,\n      delai: delaiStr,\n      type: \"project\",\n      open: true,\n    });\n\n    const stepIdByCode = {};\n\n    preparedEtapes.forEach((p) => {\n      const e = p.e;\n      const idx = p.idx;\n      const code = e.groupe_code || `ETAPE_${idx}`;\n      const libelle = e.groupe_libelle || code;\n      const childId = `${appareilId}_${code}_${idx}`;\n\n      const isAppro = code === \"BESOINS\";\n      const isAchats = code === \"ACHATS\";\n\n      tasks.push({\n        id: childId,\n        text: libelle,\n        start_date: p.startStr,\n        end_date: p.endStr,\n        parent: appareilId,\n        progress: 0,\n        status: e.statut_code,\n        date_objectif: e.date_objectif ? String(e.date_objectif).slice(0, 10) : null,\n        nombre_jours: e.nombre_jours,\n        groupe_code: e.groupe_code,\n        groupe_appareil_id: e.groupe_appareil_id,\n        isStepMilestone: isAppro || isAchats,\n\n        // ✅ réel\n        real_start: e.date_debut_reel ? String(e.date_debut_reel).slice(0, 10) : null,\n        real_end: e.date_fin_reel ? String(e.date_fin_reel).slice(0, 10) : null,\n      });\n\n      stepIdByCode[code] = childId;\n    });\n\n    function addLink(srcCode, tgtCode) {\n      const source = stepIdByCode[srcCode];\n      const target = stepIdByCode[tgtCode];\n      if (!source || !target) return;\n      links.push({ id: `${source}->${target}`, source, target, type: 0 });\n    }\n\n    addLink(\"NOTE_CALCUL\", \"PLAN\");\n    addLink(\"PLAN\", \"CAHIER_SOUDAGE\");\n    addLink(\"PLAN\", \"PREPARATION\");\n    addLink(\"PREPARATION\", \"BESOINS\");\n    addLink(\"PREPARATION\", \"ACHATS\");\n    addLink(\"BESOINS\", \"FABRICATION\");\n    addLink(\"ACHATS\", \"FABRICATION\");\n\n    if (delaiStr) {\n      tasks.push({\n        id: appareilId + \"_deadline\",\n        text: \"Délai\",\n        start_date: delaiStr,\n        parent: appareilId,\n        isDeadline: true,\n        date_objectif: delaiStr,\n      });\n    }\n  });\n\n  return { data: tasks, links };\n}\n\n// -------- Initialisation + rendu --------\nasync function renderGantt() {\n  const rows = (appsmith.model && appsmith.model.rows) || [];\n  if (!Array.isArray(rows) || !rows.length) return;\n\n  await ensureGanttLoaded();\n\n  const ganttData = mapRowsToGantt(rows);\n  const idealWidth = computeTaskColumnWidth(ganttData.data);\n\n  if (!window.ganttInitialized) {\n    if (gantt.plugins) gantt.plugins({ marker: true });\n    gantt.config.show_markers = true;\n\n    gantt.config.readonly = true;\n    gantt.config.date_format = \"%Y-%m-%d\";\n    gantt.config.min_column_width = 30;\n    gantt.config.grid_resize = true;\n\n    gantt.config.row_height = 42;\n    gantt.config.task_height = 18;\n\n    gantt.config.columns = [\n      {\n        name: \"text\",\n        label: \"Désignation\",\n        tree: true,\n        width: idealWidth,\n        min_width: 120,\n        template: (task) => (task.type === \"project\" ? (task.nom_appareil || task.text) : task.text),\n      },\n      {\n        name: \"start_custom\",\n        label: \"Date obj.\",\n        align: \"center\",\n        width: 100,\n        template: (task) => {\n          if (task.type === \"project\") return formatDateFr(task.delai || task.start_date);\n          return formatDateFr(task.date_objectif || task.start_date);\n        },\n      },\n    ];\n\n    // styles cellules (weekend + today)\n    const todayStr = new Date().toISOString().slice(0, 10);\n    const fmtIso = gantt.date.date_to_str(\"%Y-%m-%d\");\n\n    gantt.templates.scale_cell_class = function (date) {\n      const day = date.getDay();\n      const dStr = fmtIso(date);\n      const classes = [];\n      if (day === 0 || day === 6) classes.push(\"weekend\");\n      if (dStr === todayStr) classes.push(\"today-scale\");\n      return classes.join(\" \");\n    };\n\n    gantt.templates.timeline_cell_class = function (task, date) {\n      const day = date.getDay();\n      const dStr = fmtIso(date);\n      const classes = [];\n      if (day === 0 || day === 6) classes.push(\"weekend\");\n      if (dStr === todayStr) classes.push(\"today-cell\");\n      return classes.join(\" \");\n    };\n\n    gantt.templates.task_class = function (start, end, task) {\n      const classes = [];\n      if (task.type === \"project\") classes.push(\"appareil-group\");\n      if (task.isDeadline) classes.push(\"deadline-milestone\");\n      if (task.isStepMilestone) classes.push(\"step-milestone\");\n      if (task.status) classes.push(\"status-\" + task.status);\n      return classes.join(\" \");\n    };\n\n    gantt.init(\"gantt_here\");\n    window.ganttInitialized = true;\n\n    // ✅ redraw overlay à chaque rendu + scroll\n    gantt.attachEvent(\"onGanttRender\", function () {\n      renderRealOverlays();\n      return true;\n    });\n    gantt.attachEvent(\"onTaskScroll\", function () {\n      renderRealOverlays();\n      return true;\n    });\n\n    setScale(\"week\");\n\n    const toolbar = document.querySelector(\".planning-toolbar\");\n    if (toolbar) {\n      toolbar.addEventListener(\"click\", function (e) {\n        const btn = e.target.closest(\"button[data-zoom]\");\n        if (!btn) return;\n        setScale(btn.getAttribute(\"data-zoom\"));\n      });\n    }\n  } else {\n    if (gantt.config.columns && gantt.config.columns.length > 0) {\n      gantt.config.columns[0].width = idealWidth;\n    }\n  }\n\n  gantt.clearAll();\n\n  // ✅ IMPORTANT : étendre la plage AVANT parse/render\n  expandTimelineRangeFromReal(ganttData.data, 30);\n\n  gantt.parse(ganttData);\n  gantt.render();\n\n  refreshTodayMarker();\n  setTimeout(centerOnToday, 50);\n}\n\nappsmith.onReady(renderGantt);\nappsmith.onModelChange(renderGantt);\n"
  },
  "version": 1,
  "widgetId": "thmgta5mcr",
  "widgetName": "CustomPlanningCopy"
}