{
  "backgroundColor": "",
  "borderColor": "#E0DEDE",
  "borderRadius": "{{appsmith.theme.borderRadius.appBorderRadius}}",
  "borderWidth": "",
  "bottomRow": 94,
  "boxShadow": "none",
  "defaultModel": "{{\n  {\n    items: QryClientEmails.data ?? [],\n    selected: null,\n    selected_id: null,\n    debug: {\n      count: (QryClientEmails.data ?? []).length,\n      first: (QryClientEmails.data ?? [])[0] ?? null\n    }\n  }\n}}\n",
  "dynamicBindingPathList": [
    {
      "key": "theme"
    },
    {
      "key": "borderRadius"
    },
    {
      "key": "defaultModel"
    }
  ],
  "dynamicHeight": "FIXED",
  "dynamicTriggerPathList": [
    {
      "key": "onResetClick"
    }
  ],
  "events": [
    "onResetClick"
  ],
  "isCanvas": false,
  "isLoading": false,
  "isSearchWildcard": true,
  "isVisible": true,
  "key": "sa4go0ue6p",
  "leftColumn": 0,
  "maxDynamicHeight": 9000,
  "minDynamicHeight": 4,
  "mobileBottomRow": 20,
  "mobileLeftColumn": 1,
  "mobileRightColumn": 24,
  "mobileTopRow": 0,
  "needsErrorInfo": false,
  "onResetClick": "{{showAlert('Successfully reset!!', '');}}",
  "parentColumnSpace": 22.4833984375,
  "parentId": "mi05gvsqv3",
  "parentRowSpace": 10,
  "renderMode": "CANVAS",
  "rightColumn": 64,
  "srcDoc": {
    "css": "@charset \"UTF-8\";\n:root {\n  --panel:#fff;\n  --border: rgba(15,23,42,.10);\n  --muted: rgba(15,23,42,.62);\n  --text: rgba(15,23,42,.92);\n  --soft: rgba(15,23,42,.05);\n  --soft2: rgba(15,23,42,.08);\n  --shadow: 0 10px 26px rgba(15,23,42,.08);\n  --radius:14px;\n  --line: rgba(15,23,42,.16);\n  --dot: rgba(15,23,42,.60);\n  --focus: rgba(15,23,42,.18);\n}\n\n* {\n  box-sizing: border-box;\n}\n\nbody {\n  margin: 0;\n  font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;\n  color: var(--text);\n  background: transparent;\n}\n\n.wrap {\n  height: 100%;\n  min-height: 0;\n  display: flex;\n  flex-direction: column;\n  gap: 10px;\n}\n\n.toolbar {\n  background: var(--panel);\n  border: 1px solid var(--border);\n  border-radius: var(--radius);\n  padding: 12px;\n  display: flex;\n  flex-direction: column;\n  gap: 10px;\n}\n\n.title-row {\n  display: flex;\n  justify-content: space-between;\n  align-items: baseline;\n  gap: 10px;\n}\n\n.title {\n  font-size: 14px;\n  font-weight: 750;\n  letter-spacing: 0.2px;\n}\n\n.meta {\n  font-size: 12px;\n  color: var(--muted);\n  white-space: nowrap;\n}\n\n.search {\n  width: 100%;\n  border: 1px solid var(--border);\n  background: rgba(255, 255, 255, 0.75);\n  padding: 10px 12px;\n  border-radius: 12px;\n  outline: none;\n}\n\n.search:focus {\n  border-color: var(--focus);\n  box-shadow: 0 0 0 3px rgba(15, 23, 42, 0.08);\n}\n\n/* ===== Split View ===== */\n.content {\n  flex: 1;\n  min-height: 0;\n  display: grid;\n  grid-template-columns: 1.05fr 0.95fr;\n  gap: 10px;\n}\n\n.left, .right {\n  min-height: 0;\n  display: flex;\n}\n\n.list, .detail {\n  flex: 1;\n  min-height: 0;\n  background: var(--panel);\n  border: 1px solid var(--border);\n  border-radius: var(--radius);\n  overflow: auto;\n}\n\n/* Timeline list padding */\n.list {\n  padding: 10px;\n}\n\n/* ===== Timeline ===== */\n.t-group {\n  padding: 4px 0 12px;\n}\n\n.t-day {\n  position: sticky;\n  top: 0;\n  z-index: 2;\n  display: inline-flex;\n  padding: 6px 10px;\n  border-radius: 999px;\n  background: rgba(255, 255, 255, 0.92);\n  border: 1px solid rgba(15, 23, 42, 0.1);\n  box-shadow: 0 6px 18px rgba(15, 23, 42, 0.06);\n  font-size: 12px;\n  color: rgba(15, 23, 42, 0.72);\n  text-transform: capitalize;\n  margin: 6px 0 10px;\n}\n\n.t-item {\n  width: 100%;\n  text-align: left;\n  border: 0;\n  background: transparent;\n  padding: 10px 8px;\n  border-radius: 12px;\n  cursor: pointer;\n  display: grid;\n  grid-template-columns: 26px 1fr;\n  gap: 12px;\n  transition: background 0.15s ease, transform 0.05s ease;\n}\n\n.t-item:hover {\n  background: var(--soft);\n}\n\n.t-item:active {\n  transform: translateY(1px);\n}\n\n.t-item.selected {\n  background: var(--soft2);\n  outline: 1px solid rgba(15, 23, 42, 0.14);\n}\n\n.t-rail {\n  position: relative;\n  width: 26px;\n  display: flex;\n  justify-content: center;\n}\n\n.t-rail::before {\n  content: \"\";\n  position: absolute;\n  top: -12px;\n  bottom: -12px;\n  width: 2px;\n  background: var(--line);\n  border-radius: 2px;\n}\n\n.t-dot {\n  width: 10px;\n  height: 10px;\n  border-radius: 999px;\n  background: var(--dot);\n  margin-top: 6px;\n  box-shadow: 0 0 0 5px rgba(15, 23, 42, 0.06);\n}\n\n.t-card {\n  min-width: 0;\n  display: flex;\n  flex-direction: column;\n  gap: 6px;\n}\n\n.t-top {\n  display: flex;\n  justify-content: space-between;\n  align-items: center;\n  gap: 10px;\n}\n\n.t-when {\n  font-size: 12px;\n  color: var(--muted);\n  white-space: nowrap;\n}\n\n.t-pill {\n  font-size: 12px;\n  color: rgba(15, 23, 42, 0.72);\n  background: rgba(15, 23, 42, 0.04);\n  border: 1px solid rgba(15, 23, 42, 0.08);\n  padding: 4px 8px;\n  border-radius: 999px;\n  white-space: nowrap;\n  max-width: 55%;\n  overflow: hidden;\n  text-overflow: ellipsis;\n}\n\n.t-subject {\n  font-size: 13px;\n  font-weight: 720;\n  overflow: hidden;\n  text-overflow: ellipsis;\n  white-space: nowrap;\n}\n\n.t-preview {\n  font-size: 12px;\n  color: var(--muted);\n  display: -webkit-box;\n  -webkit-line-clamp: 2;\n  -webkit-box-orient: vertical;\n  overflow: hidden;\n}\n\n/* ===== Detail pane ===== */\n.detail {\n  padding: 12px;\n}\n\n.detail-empty {\n  border: 1px dashed rgba(15, 23, 42, 0.18);\n  border-radius: 12px;\n  padding: 14px;\n  color: rgba(15, 23, 42, 0.65);\n  background: rgba(15, 23, 42, 0.02);\n}\n\n.detail-empty-title {\n  font-weight: 750;\n  margin-bottom: 4px;\n}\n\n.detail-empty-sub {\n  font-size: 12px;\n  color: rgba(15, 23, 42, 0.55);\n}\n\n.d-head {\n  display: flex;\n  flex-direction: column;\n  gap: 8px;\n  padding-bottom: 10px;\n  border-bottom: 1px solid rgba(15, 23, 42, 0.08);\n  margin-bottom: 10px;\n}\n\n.d-subject {\n  font-size: 14px;\n  font-weight: 800;\n  letter-spacing: 0.2px;\n}\n\n.d-meta {\n  display: flex;\n  flex-wrap: wrap;\n  gap: 8px;\n  font-size: 12px;\n  color: rgba(15, 23, 42, 0.72);\n}\n\n.d-chip {\n  display: inline-flex;\n  gap: 6px;\n  align-items: center;\n  padding: 5px 9px;\n  border-radius: 999px;\n  background: rgba(15, 23, 42, 0.04);\n  border: 1px solid rgba(15, 23, 42, 0.08);\n  max-width: 100%;\n}\n\n.d-chip span {\n  overflow: hidden;\n  text-overflow: ellipsis;\n  white-space: nowrap;\n  max-width: 340px;\n}\n\n.d-body {\n  font-size: 13px;\n  line-height: 1.45;\n  color: rgba(15, 23, 42, 0.88);\n  white-space: pre-wrap;\n}\n\n/* Rendu HTML mail (optionnel) */\n.d-html {\n  border: 1px solid rgba(15, 23, 42, 0.1);\n  border-radius: 12px;\n  overflow: hidden;\n}\n\n.d-html iframe {\n  width: 100%;\n  height: 52vh;\n  border: 0;\n  background: white;\n}\n\n/* --- Fix rognage dans les chips (header dﾃｩtail) --- */\n.d-chip {\n  line-height: 1.25; /* ﾃｩvite le cut vertical */\n  padding: 6px 10px; /* un poil plus d'air */\n  min-height: 28px; /* garantit la hauteur */\n}\n\n.d-chip b {\n  line-height: 1; /* emoji/icﾃｴne centrﾃｩe */\n  display: inline-flex;\n  align-items: center;\n}\n\n/* Evite que le header soit contraint par un parent */\n.d-head {\n  height: auto;\n  overflow: visible;\n}\n\n/* Iframe: ﾃｩvite le cut / scroll bizarre sur certains contenus */\n.d-html iframe {\n  display: block; /* supprime l'espace baseline */\n}\n\n.d-meta {\n  align-items: flex-start; /* au lieu de center si jamais c'ﾃｩtait \"forcﾃｩ\" ailleurs */\n}\n\n/* Responsive : empile */\n@media (max-width: 900px) {\n  .content {\n    grid-template-columns: 1fr;\n  }\n  .d-html iframe {\n    height: 55vh;\n  }\n}",
    "html": "<div class=\"wrap\">\n  <div class=\"toolbar\">\n    <div class=\"title-row\">\n      <div class=\"title\">ﾃ営hanges client</div>\n      <div class=\"meta\" id=\"meta\"></div>\n    </div>\n\n    <input id=\"search\" class=\"search\" placeholder=\"Rechercher (objet, destinataire, aperﾃｧu)窶ｦ\" />\n  </div>\n\n  <div class=\"content\">\n    <!-- Colonne gauche : timeline -->\n    <div class=\"left\">\n      <div id=\"list\" class=\"list\" role=\"list\" aria-label=\"Timeline des ﾃｩchanges client\"></div>\n    </div>\n\n    <!-- Colonne droite : lecteur -->\n    <div class=\"right\" aria-label=\"Dﾃｩtail du message\">\n      <div id=\"detail\" class=\"detail\">\n        <div class=\"detail-empty\">\n          <div class=\"detail-empty-title\">Sﾃｩlectionne un message</div>\n          <div class=\"detail-empty-sub\">Clique sur un ﾃｩlﾃｩment de la timeline pour afficher le dﾃｩtail ici.</div>\n        </div>\n      </div>\n    </div>\n  </div>\n</div>\n",
    "js": "const $ = id => document.getElementById(id);\nconst state = {\n  items: [],\n  filtered: [],\n  selectedId: null,\n  query: \"\",\n  lastPushedSelectedId: null\n};\nconst safeText = v => (v ?? \"\").toString();\nconst escapeHtml = s => safeText(s).replace(/&/g, \"&amp;\").replace(/</g, \"&lt;\").replace(/>/g, \"&gt;\").replace(/\"/g, \"&quot;\").replace(/'/g, \"&#039;\");\nfunction parseReceivedAt(v) {\n  if (!v) return null;\n  const d = new Date(v);\n  return Number.isNaN(d.getTime()) ? null : d;\n}\nfunction fmtFRDayKey(received_at) {\n  const d = parseReceivedAt(received_at);\n  if (!d) return \"Sans date\";\n  return d.toLocaleDateString(\"fr-FR\", {\n    weekday: \"long\",\n    day: \"2-digit\",\n    month: \"long\",\n    year: \"numeric\"\n  });\n}\nfunction fmtFRDate(received_at) {\n  const d = parseReceivedAt(received_at);\n  if (!d) return \"窶能";\n  return d.toLocaleDateString(\"fr-FR\", {\n    day: \"2-digit\",\n    month: \"2-digit\",\n    year: \"numeric\"\n  });\n}\nfunction fmtFRTime(sent_at) {\n  if (!sent_at) return \"\";\n  const d = new Date(sent_at);\n  if (Number.isNaN(d.getTime())) return \"\";\n  return d.toLocaleTimeString(\"fr-FR\", {\n    hour: \"2-digit\",\n    minute: \"2-digit\"\n  });\n}\nfunction normalize(items) {\n  const arr = Array.isArray(items) ? items : [];\n  const norm = arr.map((m, idx) => {\n    const id = String(m?.id ?? idx);\n    const rd = parseReceivedAt(m?.received_at);\n    const ts = rd ? rd.getTime() : 0;\n    return {\n      ...m,\n      _id: id,\n      _ts: ts,\n      _dayKey: fmtFRDayKey(m?.received_at),\n      _date: fmtFRDate(m?.received_at),\n      _time: fmtFRTime(m?.sent_at),\n      _to: safeText(m?.from_email) || \"窶能",\n      // 笨 \"destinataire\" selon toi\n      _mailbox: safeText(m?.mailbox) || \"\",\n      _subject: safeText(m?.subject) || \"(sans objet)\",\n      _preview: safeText(m?.body_preview) || \"\",\n      _html: safeText(m?.body_html) || \"\"\n    };\n  });\n  norm.sort((a, b) => b._ts - a._ts);\n  return norm;\n}\nfunction groupByDay(list) {\n  const groups = [];\n  let currentKey = null;\n  let current = null;\n  for (const m of list) {\n    if (m._dayKey !== currentKey) {\n      currentKey = m._dayKey;\n      current = {\n        day: currentKey,\n        items: []\n      };\n      groups.push(current);\n    }\n    current.items.push(m);\n  }\n  return groups;\n}\nfunction renderDetail(item) {\n  const el = $(\"detail\");\n  if (!el) return;\n  if (!item) {\n    el.innerHTML = `\n      <div class=\"detail-empty\">\n        <div class=\"detail-empty-title\">Sﾃｩlectionne un message</div>\n        <div class=\"detail-empty-sub\">Clique sur un ﾃｩlﾃｩment de la timeline pour afficher le dﾃｩtail ici.</div>\n      </div>`;\n    return;\n  }\n  const date = item._time ? `${item._date} ﾂｷ ${item._time}` : item._date;\n  const rawHtml = (item._html || \"\").trim();\n  const hasHtml = rawHtml.length > 30 && rawHtml.includes(\"<\");\n\n  // fallback texte propre\n  const fallbackText = escapeHtml(item._preview || \"窶能").replace(/\\n/g, \"<br/>\");\n\n  // 笨 IMPORTANT: srcdoc doit recevoir du HTML BRUT (pas escapeHtml)\n  // On encapsule dans un document minimal pour ﾃｩviter HTML tronquﾃｩ.\n  const wrappedSrcdoc = hasHtml ? `\n<!doctype html>\n<html>\n<head>\n  <meta charset=\"utf-8\">\n  <meta name=\"viewport\" content=\"width=device-width, initial-scale=1\">\n  <style>\n    body{ margin:0; padding:12px; font-family: ui-sans-serif, system-ui, Segoe UI, Roboto, Arial; line-height:1.45; color: rgba(15,23,42,.92); }\n    img{ max-width:100%; height:auto; }\n    table{ max-width:100%; }\n  </style>\n</head>\n<body>\n  ${rawHtml}\n</body>\n</html>` : `\n<!doctype html>\n<html><head><meta charset=\"utf-8\"></head>\n<body style=\"margin:0;padding:12px;font-family:ui-sans-serif,system-ui,Segoe UI,Roboto,Arial;line-height:1.45;color:rgba(15,23,42,.92)\">\n  ${fallbackText}\n</body></html>`;\n  el.innerHTML = `\n    <div class=\"d-head\">\n      <div class=\"d-subject\">${escapeHtml(item._subject)}</div>\n\n      <div class=\"d-meta\">\n        <div class=\"d-chip\" title=\"Date\"><b>沒</b><span>${escapeHtml(date)}</span></div>\n        <div class=\"d-chip\" title=\"Destinataire\"><b>汨､</b><span>${escapeHtml(item._to)}</span></div>\n      </div>\n    </div>\n\n    <div class=\"d-html\">\n      <iframe\n        referrerpolicy=\"no-referrer\"\n        sandbox=\"allow-forms allow-popups allow-popups-to-escape-sandbox\"\n        srcdoc=\"${wrappedSrcdoc.replace(/\"/g, \"&quot;\")}\"\n      ></iframe>\n    </div>\n  `;\n}\nfunction renderTimeline() {\n  const elList = $(\"list\");\n  const elMeta = $(\"meta\");\n  const total = state.items.length;\n  const shown = state.filtered.length;\n  if (elMeta) elMeta.textContent = total ? `${shown} / ${total} message(s)` : \"Aucun message\";\n  if (!elList) return;\n  if (!shown) {\n    elList.innerHTML = `\n      <div class=\"empty\">\n        <div class=\"empty-title\">Aucun ﾃｩchange</div>\n        <div class=\"empty-sub\">Essaie une autre recherche.</div>\n      </div>`;\n    return;\n  }\n  const groups = groupByDay(state.filtered);\n  elList.innerHTML = groups.map(g => {\n    const itemsHtml = g.items.map(m => {\n      const selected = m._id === state.selectedId ? \"selected\" : \"\";\n      const when = m._time ? `${m._date} ﾂｷ ${m._time}` : m._date;\n      return `\n            <button class=\"t-item ${selected}\" type=\"button\" data-id=\"${escapeHtml(m._id)}\">\n              <div class=\"t-rail\" aria-hidden=\"true\"><div class=\"t-dot\"></div></div>\n\n              <div class=\"t-card\">\n                <div class=\"t-top\">\n                  <div class=\"t-when\">${escapeHtml(when)}</div>\n                  <div class=\"t-pill\" title=\"Destinataire\">De :&nbsp;${escapeHtml(m._to)}</div>\n                </div>\n\n                <div class=\"t-subject\" title=\"${escapeHtml(m._subject)}\">${escapeHtml(m._subject)}</div>\n                <div class=\"t-preview\">${escapeHtml(m._preview || \"窶能")}</div>\n              </div>\n            </button>\n          `;\n    }).join(\"\");\n    return `\n        <div class=\"t-group\">\n          <div class=\"t-day\">${escapeHtml(g.day)}</div>\n          <div class=\"t-group-body\">${itemsHtml}</div>\n        </div>\n      `;\n  }).join(\"\");\n}\nfunction applyFilter() {\n  const q = (state.query || \"\").trim().toLowerCase();\n  if (!q) state.filtered = state.items;else {\n    state.filtered = state.items.filter(m => {\n      const hay = [m._to, m._subject, m._preview, m.numero_affaire, m.numero_appareil].map(x => safeText(x).toLowerCase()).join(\" | \");\n      return hay.includes(q);\n    });\n  }\n  renderTimeline();\n}\nfunction pushSelectionToModelIfNeeded(item, model) {\n  if (!item) return;\n  const modelSelectedId = model?.selected_id != null ? String(model.selected_id) : null;\n  const nextId = String(item._id);\n  if (modelSelectedId === nextId) return;\n  if (state.lastPushedSelectedId === nextId) return;\n  state.lastPushedSelectedId = nextId;\n  appsmith.updateModel({\n    selected: item,\n    selected_id: nextId\n  });\n}\nfunction selectId(id, model) {\n  state.selectedId = String(id);\n  renderTimeline();\n  const item = state.items.find(m => m._id === state.selectedId) || null;\n  renderDetail(item);\n  pushSelectionToModelIfNeeded(item, model);\n}\nfunction setData(items, selected_id_from_model, model) {\n  state.items = normalize(items);\n  state.filtered = state.items;\n  const wanted = selected_id_from_model != null ? String(selected_id_from_model) : null;\n  const first = state.items[0]?._id ?? null;\n  state.selectedId = wanted && state.items.some(m => m._id === wanted) ? wanted : state.selectedId && state.items.some(m => m._id === state.selectedId) ? state.selectedId : first;\n  applyFilter();\n  const sel = state.items.find(m => m._id === state.selectedId) || null;\n  renderDetail(sel);\n\n  // auto-push seulement si le model est vide\n  if (wanted == null && sel) pushSelectionToModelIfNeeded(sel, model);\n}\nfunction initFromModel(model) {\n  const items = model?.items || [];\n  const selected_id = model?.selected_id || null;\n  setData(items, selected_id, model);\n}\nappsmith.onReady(() => {\n  const elSearch = $(\"search\");\n  const elList = $(\"list\");\n  if (elSearch) {\n    elSearch.addEventListener(\"input\", () => {\n      state.query = elSearch.value || \"\";\n      applyFilter();\n    });\n  }\n  if (elList) {\n    elList.addEventListener(\"click\", e => {\n      const btn = e.target.closest(\".t-item\");\n      if (!btn) return;\n      const id = btn.getAttribute(\"data-id\");\n      if (id) selectId(id, appsmith.model);\n    });\n  }\n  initFromModel(appsmith.model);\n  appsmith.onModelChange(m => initFromModel(m));\n});"
  },
  "theme": "{{appsmith.theme}}",
  "topRow": 0,
  "type": "CUSTOM_WIDGET",
  "uncompiledSrcDoc": {
    "css": ":root{\n  --panel:#fff;\n  --border: rgba(15,23,42,.10);\n  --muted: rgba(15,23,42,.62);\n  --text: rgba(15,23,42,.92);\n  --soft: rgba(15,23,42,.05);\n  --soft2: rgba(15,23,42,.08);\n  --shadow: 0 10px 26px rgba(15,23,42,.08);\n  --radius:14px;\n\n  --line: rgba(15,23,42,.16);\n  --dot: rgba(15,23,42,.60);\n  --focus: rgba(15,23,42,.18);\n}\n\n*{ box-sizing:border-box; }\nbody{ margin:0; font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial; color:var(--text); background:transparent; }\n\n.wrap{\n  height: 100%;\n  min-height: 0;\n  display:flex;\n  flex-direction:column;\n  gap:10px;\n}\n\n.toolbar{\n  background:var(--panel);\n  border:1px solid var(--border);\n  border-radius:var(--radius);\n  padding:12px;\n  display:flex;\n  flex-direction:column;\n  gap:10px;\n}\n\n.title-row{ display:flex; justify-content:space-between; align-items:baseline; gap:10px; }\n.title{ font-size:14px; font-weight:750; letter-spacing:.2px; }\n.meta{ font-size:12px; color:var(--muted); white-space:nowrap; }\n\n.search{\n  width:100%;\n  border:1px solid var(--border);\n  background: rgba(255,255,255,.75);\n  padding:10px 12px;\n  border-radius:12px;\n  outline:none;\n}\n.search:focus{ border-color: var(--focus); box-shadow:0 0 0 3px rgba(15,23,42,.08); }\n\n/* ===== Split View ===== */\n.content{\n  flex: 1;\n  min-height: 0;\n  display: grid;\n  grid-template-columns: 1.05fr .95fr;\n  gap: 10px;\n}\n\n.left, .right{\n  min-height: 0;\n  display:flex;\n}\n\n.list, .detail{\n  flex:1;\n  min-height:0;\n  background:var(--panel);\n  border:1px solid var(--border);\n  border-radius:var(--radius);\n  overflow:auto;\n}\n\n/* Timeline list padding */\n.list{ padding:10px; }\n\n/* ===== Timeline ===== */\n.t-group{ padding: 4px 0 12px; }\n.t-day{\n  position: sticky;\n  top: 0;\n  z-index: 2;\n  display:inline-flex;\n  padding:6px 10px;\n  border-radius:999px;\n  background: rgba(255,255,255,.92);\n  border:1px solid rgba(15,23,42,.10);\n  box-shadow:0 6px 18px rgba(15,23,42,.06);\n  font-size:12px;\n  color: rgba(15,23,42,.72);\n  text-transform: capitalize;\n  margin: 6px 0 10px;\n}\n\n.t-item{\n  width:100%;\n  text-align:left;\n  border:0;\n  background:transparent;\n  padding:10px 8px;\n  border-radius:12px;\n  cursor:pointer;\n  display:grid;\n  grid-template-columns: 26px 1fr;\n  gap:12px;\n  transition: background .15s ease, transform .05s ease;\n}\n.t-item:hover{ background: var(--soft); }\n.t-item:active{ transform: translateY(1px); }\n.t-item.selected{ background: var(--soft2); outline:1px solid rgba(15,23,42,.14); }\n\n.t-rail{ position:relative; width:26px; display:flex; justify-content:center; }\n.t-rail::before{\n  content:\"\";\n  position:absolute;\n  top:-12px; bottom:-12px;\n  width:2px;\n  background: var(--line);\n  border-radius:2px;\n}\n.t-dot{\n  width:10px; height:10px;\n  border-radius:999px;\n  background: var(--dot);\n  margin-top:6px;\n  box-shadow: 0 0 0 5px rgba(15,23,42,.06);\n}\n\n.t-card{ min-width:0; display:flex; flex-direction:column; gap:6px; }\n.t-top{ display:flex; justify-content:space-between; align-items:center; gap:10px; }\n.t-when{ font-size:12px; color:var(--muted); white-space:nowrap; }\n\n.t-pill{\n  font-size:12px;\n  color: rgba(15,23,42,.72);\n  background: rgba(15,23,42,.04);\n  border:1px solid rgba(15,23,42,.08);\n  padding:4px 8px;\n  border-radius:999px;\n  white-space:nowrap;\n  max-width: 55%;\n  overflow:hidden;\n  text-overflow: ellipsis;\n}\n\n.t-subject{\n  font-size:13px;\n  font-weight:720;\n  overflow:hidden;\n  text-overflow: ellipsis;\n  white-space: nowrap;\n}\n\n.t-preview{\n  font-size:12px;\n  color:var(--muted);\n  display:-webkit-box;\n  -webkit-line-clamp: 2;\n  -webkit-box-orient: vertical;\n  overflow:hidden;\n}\n\n/* ===== Detail pane ===== */\n.detail{ padding: 12px; }\n\n.detail-empty{\n  border: 1px dashed rgba(15,23,42,.18);\n  border-radius: 12px;\n  padding: 14px;\n  color: rgba(15,23,42,.65);\n  background: rgba(15,23,42,.02);\n}\n.detail-empty-title{\n  font-weight: 750;\n  margin-bottom: 4px;\n}\n.detail-empty-sub{\n  font-size: 12px;\n  color: rgba(15,23,42,.55);\n}\n\n.d-head{\n  display:flex;\n  flex-direction:column;\n  gap:8px;\n  padding-bottom: 10px;\n  border-bottom: 1px solid rgba(15,23,42,.08);\n  margin-bottom: 10px;\n}\n\n.d-subject{\n  font-size: 14px;\n  font-weight: 800;\n  letter-spacing: .2px;\n}\n\n.d-meta{\n  display:flex;\n  flex-wrap: wrap;\n  gap: 8px;\n  font-size: 12px;\n  color: rgba(15,23,42,.72);\n}\n\n.d-chip{\n  display:inline-flex;\n  gap: 6px;\n  align-items:center;\n  padding: 5px 9px;\n  border-radius: 999px;\n  background: rgba(15,23,42,.04);\n  border: 1px solid rgba(15,23,42,.08);\n  max-width: 100%;\n}\n.d-chip span{\n  overflow:hidden;\n  text-overflow: ellipsis;\n  white-space: nowrap;\n  max-width: 340px;\n}\n\n.d-body{\n  font-size: 13px;\n  line-height: 1.45;\n  color: rgba(15,23,42,.88);\n  white-space: pre-wrap;\n}\n\n/* Rendu HTML mail (optionnel) */\n.d-html{\n  border: 1px solid rgba(15,23,42,.10);\n  border-radius: 12px;\n  overflow: hidden;\n}\n.d-html iframe{\n  width: 100%;\n  height: 52vh;\n  border: 0;\n  background: white;\n}\n\n/* --- Fix rognage dans les chips (header dﾃｩtail) --- */\n.d-chip{\n  line-height: 1.25;          /* ﾃｩvite le cut vertical */\n  padding: 6px 10px;          /* un poil plus d'air */\n  min-height: 28px;           /* garantit la hauteur */\n}\n\n.d-chip b{\n  line-height: 1;             /* emoji/icﾃｴne centrﾃｩe */\n  display: inline-flex;\n  align-items: center;\n}\n\n/* Evite que le header soit contraint par un parent */\n.d-head{\n  height: auto;\n  overflow: visible;\n}\n\n/* Iframe: ﾃｩvite le cut / scroll bizarre sur certains contenus */\n.d-html iframe{\n  display: block;             /* supprime l'espace baseline */\n}\n.d-meta{\n  align-items: flex-start;    /* au lieu de center si jamais c'ﾃｩtait \"forcﾃｩ\" ailleurs */\n}\n\n\n/* Responsive : empile */\n@media (max-width: 900px){\n  .content{ grid-template-columns: 1fr; }\n  .d-html iframe{ height: 55vh; }\n}\n",
    "html": "<div class=\"wrap\">\n  <div class=\"toolbar\">\n    <div class=\"title-row\">\n      <div class=\"title\">ﾃ営hanges client</div>\n      <div class=\"meta\" id=\"meta\"></div>\n    </div>\n\n    <input id=\"search\" class=\"search\" placeholder=\"Rechercher (objet, destinataire, aperﾃｧu)窶ｦ\" />\n  </div>\n\n  <div class=\"content\">\n    <!-- Colonne gauche : timeline -->\n    <div class=\"left\">\n      <div id=\"list\" class=\"list\" role=\"list\" aria-label=\"Timeline des ﾃｩchanges client\"></div>\n    </div>\n\n    <!-- Colonne droite : lecteur -->\n    <div class=\"right\" aria-label=\"Dﾃｩtail du message\">\n      <div id=\"detail\" class=\"detail\">\n        <div class=\"detail-empty\">\n          <div class=\"detail-empty-title\">Sﾃｩlectionne un message</div>\n          <div class=\"detail-empty-sub\">Clique sur un ﾃｩlﾃｩment de la timeline pour afficher le dﾃｩtail ici.</div>\n        </div>\n      </div>\n    </div>\n  </div>\n</div>\n",
    "js": "const $ = (id) => document.getElementById(id);\n\nconst state = {\n  items: [],\n  filtered: [],\n  selectedId: null,\n  query: \"\",\n  lastPushedSelectedId: null,\n};\n\nconst safeText = (v) => (v ?? \"\").toString();\nconst escapeHtml = (s) =>\n  safeText(s)\n    .replace(/&/g, \"&amp;\")\n    .replace(/</g, \"&lt;\")\n    .replace(/>/g, \"&gt;\")\n    .replace(/\"/g, \"&quot;\")\n    .replace(/'/g, \"&#039;\");\n\nfunction parseReceivedAt(v) {\n  if (!v) return null;\n  const d = new Date(v);\n  return Number.isNaN(d.getTime()) ? null : d;\n}\n\nfunction fmtFRDayKey(received_at) {\n  const d = parseReceivedAt(received_at);\n  if (!d) return \"Sans date\";\n  return d.toLocaleDateString(\"fr-FR\", {\n    weekday: \"long\",\n    day: \"2-digit\",\n    month: \"long\",\n    year: \"numeric\",\n  });\n}\n\nfunction fmtFRDate(received_at) {\n  const d = parseReceivedAt(received_at);\n  if (!d) return \"窶能";\n  return d.toLocaleDateString(\"fr-FR\", { day: \"2-digit\", month: \"2-digit\", year: \"numeric\" });\n}\n\nfunction fmtFRTime(sent_at) {\n  if (!sent_at) return \"\";\n  const d = new Date(sent_at);\n  if (Number.isNaN(d.getTime())) return \"\";\n  return d.toLocaleTimeString(\"fr-FR\", { hour: \"2-digit\", minute: \"2-digit\" });\n}\n\nfunction normalize(items) {\n  const arr = Array.isArray(items) ? items : [];\n  const norm = arr.map((m, idx) => {\n    const id = String(m?.id ?? idx);\n    const rd = parseReceivedAt(m?.received_at);\n    const ts = rd ? rd.getTime() : 0;\n\n    return {\n      ...m,\n      _id: id,\n      _ts: ts,\n      _dayKey: fmtFRDayKey(m?.received_at),\n      _date: fmtFRDate(m?.received_at),\n      _time: fmtFRTime(m?.sent_at),\n      _to: safeText(m?.from_email) || \"窶能",  // 笨 \"destinataire\" selon toi\n      _mailbox: safeText(m?.mailbox) || \"\",\n      _subject: safeText(m?.subject) || \"(sans objet)\",\n      _preview: safeText(m?.body_preview) || \"\",\n      _html: safeText(m?.body_html) || \"\",\n    };\n  });\n\n  norm.sort((a, b) => b._ts - a._ts);\n  return norm;\n}\n\nfunction groupByDay(list) {\n  const groups = [];\n  let currentKey = null;\n  let current = null;\n\n  for (const m of list) {\n    if (m._dayKey !== currentKey) {\n      currentKey = m._dayKey;\n      current = { day: currentKey, items: [] };\n      groups.push(current);\n    }\n    current.items.push(m);\n  }\n  return groups;\n}\n\nfunction renderDetail(item) {\n  const el = $(\"detail\");\n  if (!el) return;\n\n  if (!item) {\n    el.innerHTML = `\n      <div class=\"detail-empty\">\n        <div class=\"detail-empty-title\">Sﾃｩlectionne un message</div>\n        <div class=\"detail-empty-sub\">Clique sur un ﾃｩlﾃｩment de la timeline pour afficher le dﾃｩtail ici.</div>\n      </div>`;\n    return;\n  }\n\n  const date = item._time ? `${item._date} ﾂｷ ${item._time}` : item._date;\n\n  const rawHtml = (item._html || \"\").trim();\n  const hasHtml = rawHtml.length > 30 && rawHtml.includes(\"<\");\n\n  // fallback texte propre\n  const fallbackText = escapeHtml(item._preview || \"窶能").replace(/\\n/g, \"<br/>\");\n\n  // 笨 IMPORTANT: srcdoc doit recevoir du HTML BRUT (pas escapeHtml)\n  // On encapsule dans un document minimal pour ﾃｩviter HTML tronquﾃｩ.\n  const wrappedSrcdoc = hasHtml\n    ? `\n<!doctype html>\n<html>\n<head>\n  <meta charset=\"utf-8\">\n  <meta name=\"viewport\" content=\"width=device-width, initial-scale=1\">\n  <style>\n    body{ margin:0; padding:12px; font-family: ui-sans-serif, system-ui, Segoe UI, Roboto, Arial; line-height:1.45; color: rgba(15,23,42,.92); }\n    img{ max-width:100%; height:auto; }\n    table{ max-width:100%; }\n  </style>\n</head>\n<body>\n  ${rawHtml}\n</body>\n</html>`\n    : `\n<!doctype html>\n<html><head><meta charset=\"utf-8\"></head>\n<body style=\"margin:0;padding:12px;font-family:ui-sans-serif,system-ui,Segoe UI,Roboto,Arial;line-height:1.45;color:rgba(15,23,42,.92)\">\n  ${fallbackText}\n</body></html>`;\n\n  el.innerHTML = `\n    <div class=\"d-head\">\n      <div class=\"d-subject\">${escapeHtml(item._subject)}</div>\n\n      <div class=\"d-meta\">\n        <div class=\"d-chip\" title=\"Date\"><b>沒</b><span>${escapeHtml(date)}</span></div>\n        <div class=\"d-chip\" title=\"Destinataire\"><b>汨､</b><span>${escapeHtml(item._to)}</span></div>\n      </div>\n    </div>\n\n    <div class=\"d-html\">\n      <iframe\n        referrerpolicy=\"no-referrer\"\n        sandbox=\"allow-forms allow-popups allow-popups-to-escape-sandbox\"\n        srcdoc=\"${wrappedSrcdoc.replace(/\"/g, \"&quot;\")}\"\n      ></iframe>\n    </div>\n  `;\n}\n\n\n\nfunction renderTimeline() {\n  const elList = $(\"list\");\n  const elMeta = $(\"meta\");\n\n  const total = state.items.length;\n  const shown = state.filtered.length;\n  if (elMeta) elMeta.textContent = total ? `${shown} / ${total} message(s)` : \"Aucun message\";\n\n  if (!elList) return;\n\n  if (!shown) {\n    elList.innerHTML = `\n      <div class=\"empty\">\n        <div class=\"empty-title\">Aucun ﾃｩchange</div>\n        <div class=\"empty-sub\">Essaie une autre recherche.</div>\n      </div>`;\n    return;\n  }\n\n  const groups = groupByDay(state.filtered);\n\n  elList.innerHTML = groups\n    .map((g) => {\n      const itemsHtml = g.items\n        .map((m) => {\n          const selected = m._id === state.selectedId ? \"selected\" : \"\";\n          const when = m._time ? `${m._date} ﾂｷ ${m._time}` : m._date;\n\n          return `\n            <button class=\"t-item ${selected}\" type=\"button\" data-id=\"${escapeHtml(m._id)}\">\n              <div class=\"t-rail\" aria-hidden=\"true\"><div class=\"t-dot\"></div></div>\n\n              <div class=\"t-card\">\n                <div class=\"t-top\">\n                  <div class=\"t-when\">${escapeHtml(when)}</div>\n                  <div class=\"t-pill\" title=\"Destinataire\">De :&nbsp;${escapeHtml(m._to)}</div>\n                </div>\n\n                <div class=\"t-subject\" title=\"${escapeHtml(m._subject)}\">${escapeHtml(m._subject)}</div>\n                <div class=\"t-preview\">${escapeHtml(m._preview || \"窶能")}</div>\n              </div>\n            </button>\n          `;\n        })\n        .join(\"\");\n\n      return `\n        <div class=\"t-group\">\n          <div class=\"t-day\">${escapeHtml(g.day)}</div>\n          <div class=\"t-group-body\">${itemsHtml}</div>\n        </div>\n      `;\n    })\n    .join(\"\");\n}\n\nfunction applyFilter() {\n  const q = (state.query || \"\").trim().toLowerCase();\n  if (!q) state.filtered = state.items;\n  else {\n    state.filtered = state.items.filter((m) => {\n      const hay = [m._to, m._subject, m._preview, m.numero_affaire, m.numero_appareil]\n        .map((x) => safeText(x).toLowerCase())\n        .join(\" | \");\n      return hay.includes(q);\n    });\n  }\n  renderTimeline();\n}\n\nfunction pushSelectionToModelIfNeeded(item, model) {\n  if (!item) return;\n  const modelSelectedId = model?.selected_id != null ? String(model.selected_id) : null;\n  const nextId = String(item._id);\n\n  if (modelSelectedId === nextId) return;\n  if (state.lastPushedSelectedId === nextId) return;\n\n  state.lastPushedSelectedId = nextId;\n  appsmith.updateModel({ selected: item, selected_id: nextId });\n}\n\nfunction selectId(id, model) {\n  state.selectedId = String(id);\n  renderTimeline();\n\n  const item = state.items.find((m) => m._id === state.selectedId) || null;\n  renderDetail(item);\n  pushSelectionToModelIfNeeded(item, model);\n}\n\nfunction setData(items, selected_id_from_model, model) {\n  state.items = normalize(items);\n  state.filtered = state.items;\n\n  const wanted = selected_id_from_model != null ? String(selected_id_from_model) : null;\n  const first = state.items[0]?._id ?? null;\n\n  state.selectedId =\n    (wanted && state.items.some((m) => m._id === wanted)) ? wanted :\n    (state.selectedId && state.items.some((m) => m._id === state.selectedId)) ? state.selectedId :\n    first;\n\n  applyFilter();\n\n  const sel = state.items.find((m) => m._id === state.selectedId) || null;\n  renderDetail(sel);\n\n  // auto-push seulement si le model est vide\n  if (wanted == null && sel) pushSelectionToModelIfNeeded(sel, model);\n}\n\nfunction initFromModel(model) {\n  const items = model?.items || [];\n  const selected_id = model?.selected_id || null;\n  setData(items, selected_id, model);\n}\n\nappsmith.onReady(() => {\n  const elSearch = $(\"search\");\n  const elList = $(\"list\");\n\n  if (elSearch) {\n    elSearch.addEventListener(\"input\", () => {\n      state.query = elSearch.value || \"\";\n      applyFilter();\n    });\n  }\n\n  if (elList) {\n    elList.addEventListener(\"click\", (e) => {\n      const btn = e.target.closest(\".t-item\");\n      if (!btn) return;\n      const id = btn.getAttribute(\"data-id\");\n      if (id) selectId(id, appsmith.model);\n    });\n  }\n\n  initFromModel(appsmith.model);\n\n  appsmith.onModelChange((m) => initFromModel(m));\n});\n"
  },
  "version": 1,
  "widgetId": "067syd1a54",
  "widgetName": "Custom1"
}