{
  "backgroundColor": "#FFFFFF",
  "borderColor": "#E0DEDE",
  "borderRadius": "{{appsmith.theme.borderRadius.appBorderRadius}}",
  "borderWidth": "1",
  "bottomRow": 104,
  "boxShadow": "{{appsmith.theme.boxShadow.appBoxShadow}}",
  "defaultModel": "{{ { rows: QryDashboardSuiviFabrication.data || [] } }}",
  "dynamicBindingPathList": [
    {
      "key": "theme"
    },
    {
      "key": "borderRadius"
    },
    {
      "key": "boxShadow"
    },
    {
      "key": "defaultModel"
    }
  ],
  "dynamicHeight": "AUTO_HEIGHT",
  "dynamicPropertyPathList": [],
  "dynamicTriggerPathList": [],
  "events": [],
  "isCanvas": false,
  "isLoading": false,
  "isSearchWildcard": true,
  "isVisible": true,
  "key": "ctx98s9hxm",
  "leftColumn": 0,
  "maxDynamicHeight": 9000,
  "minDynamicHeight": 4,
  "mobileBottomRow": 40,
  "mobileLeftColumn": 19,
  "mobileRightColumn": 42,
  "mobileTopRow": 10,
  "needsErrorInfo": false,
  "originalBottomRow": 104,
  "originalTopRow": 0,
  "parentColumnSpace": 20.25,
  "parentId": "5d9mv378b8",
  "parentRowSpace": 10,
  "renderMode": "CANVAS",
  "rightColumn": 64,
  "shouldScrollContents": true,
  "srcDoc": {
    "css": "@charset \"UTF-8\";\n/* Toolbar zoom */\n.planning-toolbar {\n  display: flex;\n  gap: 8px;\n  margin-bottom: 6px;\n}\n\n.planning-toolbar button {\n  font-size: 11px;\n  padding: 4px 8px;\n  border-radius: 4px;\n  border: 1px solid #d1d5db;\n  background: #f9fafb;\n  cursor: pointer;\n}\n\n.planning-toolbar button:hover {\n  background: #e5e7eb;\n}\n\n/* Le Gantt occupe tout l'espace du widget */\n#gantt_here {\n  width: 100%;\n  min-height: 1000px; /* hauteur minimum visible */\n}\n\n/* Couleurs des tâches suivant le statut */\n.gantt_task_line.status-A_FAIRE {\n  background-color: #ef4444;\n  border-color: #b91c1c;\n}\n\n.gantt_task_line.status-EN_COURS,\n.gantt_task_line.status-ATTENTE_CLIENT {\n  background-color: #eab308;\n  border-color: #a16207;\n}\n\n.gantt_task_line.status-TERMINE,\n.gantt_task_line.status-VALIDE_CLIENT {\n  background-color: #22c55e;\n  border-color: #15803d;\n}\n\n/* Week-end légèrement grisé */\n.gantt_scale_cell.weekend,\n.gantt_task_cell.weekend {\n  background-color: #f3f4f6;\n}\n\n/* ===== Fond rouge léger pour le jour courant ===== */\n/* En-tête (échelle) */\n.gantt_scale_cell.today-scale {\n  background-color: #fee2e2; /* rouge très clair */\n}\n\n/* Cellules de la timeline */\n.gantt_task_cell.today-cell {\n  background-color: #fee2e2;\n}\n\n/* ===== Ligne rouge \"aujourd'hui\" ===== */\n.gantt_marker.today-marker {\n  z-index: 3; /* au-dessus des barres */\n}\n\n/* La vraie ligne rouge verticale */\n.gantt_marker.today-marker .gantt_marker_content {\n  background-color: #ef4444; /* rouge */\n  width: 2px;\n  margin-left: -1px; /* pour la centrer sur la date */\n}\n\n/* ===== JALON DELAI EN LOSANGE ===== */\n/* ===== JALON DELAI EN LOSANGE (corrigé) ===== */\n/* On neutralise la barre pour le jalon */\n.gantt_task_line.deadline-milestone {\n  background: transparent !important;\n  border: none !important;\n}\n\n/* On masque contenu & progression : on ne garde que le losange */\n.gantt_task_line.deadline-milestone .gantt_task_content,\n.gantt_task_line.deadline-milestone .gantt_task_progress {\n  display: none !important;\n}\n\n/* Losange centré sur la ligne (vert. & horiz.) */\n.gantt_task_line.deadline-milestone::before {\n  content: \"\";\n  position: absolute;\n  /* centre horizontalement sur la barre (donc sur le jour du délai) */\n  left: 50%;\n  margin-left: -5px;\n  /* centre verticalement sur la ligne */\n  top: 50%;\n  margin-top: -5px;\n  width: 10px;\n  height: 10px;\n  transform: rotate(45deg);\n  background: #cf3232; /* couleur du jalon */\n  border-radius: 2px;\n}\n\n/* ===== Jalons pour APPRO & ACHATS ===== */\n/* On supprime complètement la barre */\n.gantt_task_line.step-milestone {\n  background: transparent !important;\n  border: none !important;\n}\n\n/* On masque tout contenu interne */\n.gantt_task_line.step-milestone .gantt_task_content,\n.gantt_task_line.step-milestone .gantt_task_progress {\n  display: none !important;\n}\n\n/* On dessine un losange coloré selon statut */\n.gantt_task_line.step-milestone::before {\n  content: \"\";\n  position: absolute;\n  left: 50%;\n  top: 50%;\n  margin-left: -5px;\n  margin-top: -5px;\n  width: 10px;\n  height: 10px;\n  transform: rotate(45deg);\n  border-radius: 2px;\n  /* couleur via classe \"status-XXX\" */\n}\n\n/* Couleur via statut */\n.gantt_task_line.step-milestone.status-A_FAIRE::before {\n  background: #bdbbbb;\n}\n\n.gantt_task_line.step-milestone.status-EN_COURS::before,\n.gantt_task_line.step-milestone.status-ATTENTE_CLIENT::before {\n  background: #eab308;\n}\n\n.gantt_task_line.step-milestone.status-TERMINE::before,\n.gantt_task_line.step-milestone.status-VALIDE_CLIENT::before {\n  background: #22c55e;\n}\n\n/* ===== Taille des textes ===== */\n/* Réduction taille du texte dans la grille (tableau à gauche) */\n.gantt_grid,\n.gantt_grid * {\n  font-size: 10px !important;\n}\n\n/* Réduction taille du texte dans la timeline */\n.gantt_task,\n.gantt_task * {\n  font-size: 10px !important;\n}\n\n/* Réduction taille du header grille */\n.gantt_grid_head_cell {\n  font-size: 11px !important;\n}\n\n/* Réduction taille du header timeline */\n.gantt_scale_cell {\n  font-size: 11px !important;\n}",
    "html": "<link\n  rel=\"stylesheet\"\n  href=\"https://cdn.dhtmlx.com/gantt/edge/dhtmlxgantt.css\"\n/>\n\n<div class=\"planning-toolbar\">\n  <button data-zoom=\"day\">Jour</button>\n  <button data-zoom=\"week\">Semaine</button>\n  <button data-zoom=\"month\">Mois</button>\n</div>\n\n<div id=\"gantt_here\"></div>\n",
    "js": "// -------- Helpers généraux --------\n// Ramène une date (YYYY-MM-DD) au dernier jour ouvré si elle tombe le week-end\nfunction normalizeToBusinessEnd(endIso) {\n  if (!endIso) return null;\n  const d = new Date(endIso + \"T00:00:00Z\");\n  let day = d.getUTCDay(); // 0 = dimanche, 6 = samedi\n\n  if (day === 0) {\n    // dimanche -> vendredi\n    d.setUTCDate(d.getUTCDate() - 2);\n  } else if (day === 6) {\n    // samedi -> vendredi\n    d.setUTCDate(d.getUTCDate() - 1);\n  }\n  return d.toISOString().slice(0, 10);\n}\n\n// Calcule automatiquement la largeur idéale de la colonne Task name\nfunction computeTaskColumnWidth(tasks) {\n  let maxChars = 10; // nombre minimal de caractères\n\n  (tasks || []).forEach(t => {\n    const label = t.type === \"project\" ? t.nom_appareil || t.text || \"\" : t.text || \"\";\n    if (label.length > maxChars) {\n      maxChars = label.length;\n    }\n  });\n\n  // approx : 7 px par caractère + padding\n  return Math.min(maxChars * 7 + 40, 600); // limite max 600px\n}\n\n// Charge dhtmlxGantt une seule fois\nfunction ensureGanttLoaded() {\n  if (window.gantt) return Promise.resolve();\n  if (window.ganttLoading) return window.ganttLoading;\n  window.ganttLoading = new Promise((resolve, reject) => {\n    const script = document.createElement(\"script\");\n    script.src = \"https://cdn.dhtmlx.com/gantt/edge/dhtmlxgantt.js\";\n    script.onload = () => resolve();\n    script.onerror = reject;\n    document.head.appendChild(script);\n  });\n  return window.ganttLoading;\n}\n\n// Format YYYY-MM-DD -> DD-MM-YYYY\nfunction formatDateFr(isoStr) {\n  if (!isoStr) return \"\";\n  const s = String(isoStr).slice(0, 10); // garde que AAAA-MM-JJ\n  const parts = s.split(\"-\");\n  if (parts.length !== 3) return s;\n  const [y, m, d] = parts;\n  return `${d}-${m}-${y}`;\n}\n\n// -------- Helpers pour jours ouvrés / nombre_jours --------\n\nfunction parsePositiveInt(val) {\n  const n = parseInt(val, 10);\n  return Number.isFinite(n) && n > 0 ? n : null;\n}\n\n// endIso = \"YYYY-MM-DD\", nbDays = nombre de jours ouvrés (>=1)\n// On recule nbDays-1 jours ouvrés pour avoir la date de début incluse\nfunction subtractBusinessDays(endIso, nbDays) {\n  if (!endIso) return null;\n  const d = new Date(endIso + \"T00:00:00Z\");\n\n  // si nbDays vaut 1 -> on ne recule pas (début = fin)\n  let remaining = Math.max(nbDays - 1, 0);\n  while (remaining > 0) {\n    d.setUTCDate(d.getUTCDate() - 1);\n    const day = d.getUTCDay(); // 0 = dimanche, 6 = samedi\n    if (day !== 0 && day !== 6) {\n      remaining--;\n    }\n  }\n  return d.toISOString().slice(0, 10);\n}\n\n// Calcule start/end d'une étape à partir de date_objectif (fin) et nombre_jours\n// - date_objectif peut tomber le week-end : on la ramène au vendredi\n// - nombre_jours = nb de jours ouvrés\n// Retourne { startStr, endStr } pour Gantt (endStr exclusive)\nfunction computeChildTaskDates(etape) {\n  const rawEnd = etape.date_objectif || etape.date_fin;\n  if (!rawEnd) return null;\n\n  // 1) fin ouvrée = date objectif ramenée au dernier jour ouvré\n  const rawEndIso = String(rawEnd).slice(0, 10); // YYYY-MM-DD\n  const endBusiness = normalizeToBusinessEnd(rawEndIso);\n  if (!endBusiness) return null;\n\n  // 2) nombre de jours ouvrés (min 1)\n  const nbJours = parsePositiveInt(etape.nombre_jours) || 1;\n\n  // 3) début = fin ouvrée - (nbJours - 1) jours ouvrés\n  const startStr = subtractBusinessDays(endBusiness, nbJours);\n\n  // 4) pour Gantt : end_date EXCLUSIVE = fin ouvrée + 1 jour\n  const dEnd = new Date(endBusiness + \"T00:00:00Z\");\n  dEnd.setUTCDate(dEnd.getUTCDate() + 1);\n  const endStr = dEnd.toISOString().slice(0, 10);\n  return {\n    startStr,\n    endStr\n  };\n}\n\n// Gestion du zoom (échelles jour / semaine / mois)\nfunction setScale(level) {\n  if (!window.gantt) return;\n  switch (level) {\n    case \"day\":\n      gantt.config.scales = [{\n        unit: \"month\",\n        step: 1,\n        format: \"%F %Y\"\n      }, {\n        unit: \"day\",\n        step: 1,\n        format: \"%d-%m\"\n      }];\n      break;\n    case \"month\":\n      gantt.config.scales = [{\n        unit: \"year\",\n        step: 1,\n        format: \"%Y\"\n      }, {\n        unit: \"month\",\n        step: 1,\n        format: \"%M\"\n      }];\n      break;\n    case \"week\":\n    default:\n      gantt.config.scales = [{\n        unit: \"year\",\n        step: 1,\n        format: \"%Y\"\n      }, {\n        unit: \"week\",\n        step: 1,\n        format: function (date) {\n          const weekStr = gantt.date.date_to_str(\"%W\")(date);\n          return \"S\" + weekStr;\n        }\n      }, {\n        unit: \"day\",\n        step: 1,\n        format: \"%d\"\n      }];\n      break;\n  }\n  gantt.render();\n}\n\n// ----- Marqueur \"aujourd'hui\" (ligne rouge) -----\nfunction refreshTodayMarker() {\n  if (!window.gantt || !gantt.addMarker) return;\n  const today = new Date();\n\n  // Supprimer l'ancien marqueur si besoin\n  if (window.todayMarkerId) {\n    gantt.deleteMarker(window.todayMarkerId);\n  }\n\n  // Ajouter un nouveau marqueur\n  window.todayMarkerId = gantt.addMarker({\n    start_date: today,\n    css: \"today-marker\",\n    text: \"\",\n    title: \"\"\n  });\n  gantt.renderMarkers();\n}\n\n// ----- Centrer le planning sur la date du jour -----\nfunction centerOnToday() {\n  if (!window.gantt) return;\n  const today = new Date();\n  gantt.showDate(today); // Gantt gère le scroll horizontal\n}\n\n// -------- Mapping des données Appsmith -> Gantt --------\n\n// Transforme QryDashboardSuiviFabrication.data -> { data: tasks, links }\nfunction mapRowsToGantt(rows) {\n  const tasks = [];\n  const links = [];\n  rows.forEach(r => {\n    const appareilId = String(r.numero_appareil);\n    const appareilLabel = `${r.nom_appareil}`;\n    const etapes = Array.isArray(r.etapes) ? r.etapes : [];\n    const delaiStr = r.delai ? String(r.delai).slice(0, 10) : null;\n    const today = new Date().toISOString().slice(0, 10);\n\n    // --- préparation des étapes avec dates calculées (jours ouvrés) ---\n    const preparedEtapes = [];\n    etapes.forEach((e, idx) => {\n      const dates = computeChildTaskDates(e);\n      if (!dates) return;\n      preparedEtapes.push({\n        e,\n        idx,\n        startStr: dates.startStr,\n        endStr: dates.endStr\n      });\n    });\n\n    // --- bornes min/max pour la barre projet ---\n    let firstStepStart = null;\n    let lastStepEnd = null;\n    preparedEtapes.forEach(p => {\n      if (!firstStepStart || p.startStr < firstStepStart) {\n        firstStepStart = p.startStr;\n      }\n      if (!lastStepEnd || p.endStr > lastStepEnd) {\n        lastStepEnd = p.endStr;\n      }\n    });\n    const projectStart = firstStepStart || delaiStr || today;\n    const projectEnd = delaiStr || lastStepEnd || projectStart;\n\n    // --- tâche \"projet\" pour l'appareil ---\n    tasks.push({\n      id: appareilId,\n      text: appareilLabel,\n      nom_appareil: r.nom_appareil,\n      start_date: projectStart,\n      end_date: projectEnd,\n      delai: delaiStr,\n      type: \"project\",\n      open: false\n    });\n\n    // --- étapes enfants ---\n    let prevChildId = null;\n    preparedEtapes.forEach(p => {\n      const e = p.e;\n      const idx = p.idx;\n      const code = e.groupe_code || `ETAPE_${idx}`;\n      const libelle = e.groupe_libelle || code;\n      const childId = `${appareilId}_${code}_${idx}`;\n\n      // Flags jalons pour APPRO et ACHATS\n      const isAppro = code === \"APPRO\";\n      const isAchats = code === \"ACHATS\"; // adapte si besoin\n\n      tasks.push({\n        id: childId,\n        text: libelle,\n        start_date: p.startStr,\n        end_date: p.endStr,\n        parent: appareilId,\n        progress: 0,\n        status: e.statut_code,\n        date_objectif: e.date_objectif ? String(e.date_objectif).slice(0, 10) : null,\n        nombre_jours: e.nombre_jours,\n        groupe_code: e.groupe_code,\n        groupe_appareil_id: e.groupe_appareil_id,\n        // tâche affichée comme jalon, PAS comme une barre pour APPRO / ACHATS\n        isStepMilestone: isAppro || isAchats\n      });\n      if (prevChildId) {\n        links.push({\n          id: `${prevChildId}->${childId}`,\n          source: prevChildId,\n          target: childId,\n          type: 0\n        });\n      }\n      prevChildId = childId;\n    });\n\n    // --- JALON DELAI : toujours en dernier enfant ---\n    if (delaiStr) {\n      tasks.push({\n        id: appareilId + \"_deadline\",\n        text: \"Délai\",\n        start_date: delaiStr,\n        // pour le positionnement sur le planning\n        parent: appareilId,\n        isDeadline: true,\n        date_objectif: delaiStr // pour l'affichage dans \"Date obj.\"\n      });\n    }\n  });\n  return {\n    data: tasks,\n    links\n  };\n}\n\n// -------- Initialisation + rendu Gantt --------\n\nasync function renderGantt() {\n  const rows = appsmith.model && appsmith.model.rows || [];\n  if (!Array.isArray(rows) || !rows.length) return;\n  await ensureGanttLoaded();\n\n  // on mappe D'ABORD les données -> tasks + links\n  const ganttData = mapRowsToGantt(rows);\n\n  // on calcule la largeur idéale de la colonne \"Désignation\"\n  const idealWidth = computeTaskColumnWidth(ganttData.data);\n\n  // Init une seule fois\n  if (!window.ganttInitialized) {\n    // activer le plugin \"marker\" pour la ligne rouge aujourd'hui\n    if (gantt.plugins) {\n      gantt.plugins({\n        marker: true\n      });\n    }\n    gantt.config.show_markers = true;\n\n    // lecture seule\n    gantt.config.readonly = true;\n    gantt.config.date_format = \"%Y-%m-%d\";\n    gantt.config.min_column_width = 30; // taille des cases \"Jour\"\n    gantt.config.grid_resize = true;\n\n    // Colonnes du tableau à gauche\n    gantt.config.columns = [{\n      name: \"text\",\n      label: \"Désignation\",\n      tree: true,\n      width: idealWidth,\n      min_width: 120,\n      template: function (task) {\n        // Pour les appareils : uniquement le nom_appareil\n        if (task.type === \"project\") {\n          return task.nom_appareil || task.text;\n        }\n        // Pour les étapes : libellé normal\n        return task.text;\n      }\n    }, {\n      // Colonne date objectif :\n      // appareil  -> délai de l'appareil\n      // étape     -> date objectif de l'étape\n      name: \"start_custom\",\n      label: \"Date obj.\",\n      align: \"center\",\n      width: 100,\n      template: function (task) {\n        if (task.type === \"project\") {\n          const d = task.delai || task.start_date;\n          return formatDateFr(d);\n        }\n        const d = task.date_objectif || task.start_date;\n        return formatDateFr(d);\n      }\n    }];\n\n    // Week-end en gris + jour courant en rouge clair\n    const todayStr = new Date().toISOString().slice(0, 10); // \"YYYY-MM-DD\"\n    const fmtIso = gantt.date.date_to_str(\"%Y-%m-%d\");\n    gantt.templates.scale_cell_class = function (date) {\n      const day = date.getDay();\n      const dStr = fmtIso(date);\n      const classes = [];\n      if (day === 0 || day === 6) classes.push(\"weekend\");\n      if (dStr === todayStr) classes.push(\"today-scale\");\n      return classes.join(\" \");\n    };\n    gantt.templates.timeline_cell_class = function (task, date) {\n      const day = date.getDay();\n      const dStr = fmtIso(date);\n      const classes = [];\n      if (day === 0 || day === 6) classes.push(\"weekend\");\n      if (dStr === todayStr) classes.push(\"today-cell\");\n      return classes.join(\" \");\n    };\n\n    // Classe CSS selon le statut + jalons\n    gantt.templates.task_class = function (start, end, task) {\n      const classes = [];\n\n      // jalon délai (ligne \"Délai\")\n      if (task.isDeadline) classes.push(\"deadline-milestone\");\n\n      // jalon pour APPRO / ACHATS\n      if (task.isStepMilestone) classes.push(\"step-milestone\");\n\n      // statut (couleur)\n      if (task.status) classes.push(\"status-\" + task.status);\n      return classes.join(\" \");\n    };\n\n    // Init gantt\n    gantt.init(\"gantt_here\");\n    window.ganttInitialized = true;\n\n    // Zoom par défaut : vue semaine\n    setScale(\"week\");\n\n    // Gestion des boutons de zoom dans la toolbar HTML\n    const toolbar = document.querySelector(\".planning-toolbar\");\n    if (toolbar) {\n      toolbar.addEventListener(\"click\", function (e) {\n        const btn = e.target.closest(\"button[data-zoom]\");\n        if (!btn) return;\n        const level = btn.getAttribute(\"data-zoom\");\n        setScale(level);\n      });\n    }\n  } else {\n    // si déjà initialisé, on met simplement à jour la largeur de la 1ère colonne\n    if (gantt.config.columns && gantt.config.columns.length > 0) {\n      gantt.config.columns[0].width = idealWidth;\n    }\n  }\n\n  // on applique les données\n  gantt.clearAll();\n  gantt.parse(ganttData);\n\n  // Marqueur \"aujourd'hui\" + centrage\n  refreshTodayMarker();\n  setTimeout(centerOnToday, 50); // petit délai pour que le DOM ait sa largeur définitive\n}\n\n// Initialisation et rafraîchissements\nappsmith.onReady(renderGantt);\nappsmith.onModelChange(renderGantt);"
  },
  "theme": "{{appsmith.theme}}",
  "topRow": 0,
  "type": "CUSTOM_WIDGET",
  "uncompiledSrcDoc": {
    "css": "/* Toolbar zoom */\n.planning-toolbar {\n  display: flex;\n  gap: 8px;\n  margin-bottom: 6px;\n}\n\n.planning-toolbar button {\n  font-size: 11px;\n  padding: 4px 8px;\n  border-radius: 4px;\n  border: 1px solid #d1d5db;\n  background: #f9fafb;\n  cursor: pointer;\n}\n\n.planning-toolbar button:hover {\n  background: #e5e7eb;\n}\n\n/* Le Gantt occupe tout l'espace du widget */\n#gantt_here {\n  width: 100%;\n  min-height: 1000px; /* hauteur minimum visible */\n}\n\n/* Couleurs des tâches suivant le statut */\n.gantt_task_line.status-A_FAIRE {\n  background-color: #ef4444;\n  border-color: #b91c1c;\n}\n\n.gantt_task_line.status-EN_COURS,\n.gantt_task_line.status-ATTENTE_CLIENT {\n  background-color: #eab308;\n  border-color: #a16207;\n}\n\n.gantt_task_line.status-TERMINE,\n.gantt_task_line.status-VALIDE_CLIENT {\n  background-color: #22c55e;\n  border-color: #15803d;\n}\n\n/* Week-end légèrement grisé */\n.gantt_scale_cell.weekend,\n.gantt_task_cell.weekend {\n  background-color: #f3f4f6;\n}\n\n/* ===== Fond rouge léger pour le jour courant ===== */\n\n/* En-tête (échelle) */\n.gantt_scale_cell.today-scale {\n  background-color: #fee2e2; /* rouge très clair */\n}\n\n/* Cellules de la timeline */\n.gantt_task_cell.today-cell {\n  background-color: #fee2e2;\n}\n\n/* ===== Ligne rouge \"aujourd'hui\" ===== */\n\n.gantt_marker.today-marker {\n  z-index: 3; /* au-dessus des barres */\n}\n\n/* La vraie ligne rouge verticale */\n.gantt_marker.today-marker .gantt_marker_content {\n  background-color: #ef4444; /* rouge */\n  width: 2px;\n  margin-left: -1px; /* pour la centrer sur la date */\n}\n\n\n/* ===== JALON DELAI EN LOSANGE ===== */\n/* ===== JALON DELAI EN LOSANGE (corrigé) ===== */\n\n/* On neutralise la barre pour le jalon */\n.gantt_task_line.deadline-milestone {\n  background: transparent !important;\n  border: none !important;\n}\n\n/* On masque contenu & progression : on ne garde que le losange */\n.gantt_task_line.deadline-milestone .gantt_task_content,\n.gantt_task_line.deadline-milestone .gantt_task_progress {\n  display: none !important;\n}\n\n/* Losange centré sur la ligne (vert. & horiz.) */\n.gantt_task_line.deadline-milestone::before {\n  content: \"\";\n  position: absolute;\n\n  /* centre horizontalement sur la barre (donc sur le jour du délai) */\n  left: 50%;\n  margin-left: -5px;\n\n  /* centre verticalement sur la ligne */\n  top: 50%;\n  margin-top: -5px;\n\n  width: 10px;\n  height: 10px;\n\n  transform: rotate(45deg);\n  background: #cf3232;   /* couleur du jalon */\n  border-radius: 2px;\n}\n\n/* ===== Jalons pour APPRO & ACHATS ===== */\n\n/* On supprime complètement la barre */\n.gantt_task_line.step-milestone {\n  background: transparent !important;\n  border: none !important;\n}\n\n/* On masque tout contenu interne */\n.gantt_task_line.step-milestone .gantt_task_content,\n.gantt_task_line.step-milestone .gantt_task_progress {\n  display: none !important;\n}\n\n/* On dessine un losange coloré selon statut */\n.gantt_task_line.step-milestone::before {\n  content: \"\";\n  position: absolute;\n\n  left: 50%;\n  top: 50%;\n  margin-left: -5px;\n  margin-top: -5px;\n\n  width: 10px;\n  height: 10px;\n\n  transform: rotate(45deg);\n  border-radius: 2px;\n\n  /* couleur via classe \"status-XXX\" */\n}\n\n/* Couleur via statut */\n.gantt_task_line.step-milestone.status-A_FAIRE::before {\n  background: #bdbbbb;\n}\n.gantt_task_line.step-milestone.status-EN_COURS::before,\n.gantt_task_line.step-milestone.status-ATTENTE_CLIENT::before {\n  background: #eab308;\n}\n.gantt_task_line.step-milestone.status-TERMINE::before,\n.gantt_task_line.step-milestone.status-VALIDE_CLIENT::before {\n  background: #22c55e;\n}\n\n\n/* ===== Taille des textes ===== */\n\n/* Réduction taille du texte dans la grille (tableau à gauche) */\n.gantt_grid,\n.gantt_grid * {\n  font-size: 10px !important;\n}\n\n/* Réduction taille du texte dans la timeline */\n.gantt_task,\n.gantt_task * {\n  font-size: 10px !important;\n}\n\n/* Réduction taille du header grille */\n.gantt_grid_head_cell {\n  font-size: 11px !important;\n}\n\n/* Réduction taille du header timeline */\n.gantt_scale_cell {\n  font-size: 11px !important;\n}\n",
    "html": "<link\n  rel=\"stylesheet\"\n  href=\"https://cdn.dhtmlx.com/gantt/edge/dhtmlxgantt.css\"\n/>\n\n<div class=\"planning-toolbar\">\n  <button data-zoom=\"day\">Jour</button>\n  <button data-zoom=\"week\">Semaine</button>\n  <button data-zoom=\"month\">Mois</button>\n</div>\n\n<div id=\"gantt_here\"></div>\n",
    "js": "// -------- Helpers généraux --------\n// Ramène une date (YYYY-MM-DD) au dernier jour ouvré si elle tombe le week-end\nfunction normalizeToBusinessEnd(endIso) {\n  if (!endIso) return null;\n  const d = new Date(endIso + \"T00:00:00Z\");\n  let day = d.getUTCDay(); // 0 = dimanche, 6 = samedi\n\n  if (day === 0) {\n    // dimanche -> vendredi\n    d.setUTCDate(d.getUTCDate() - 2);\n  } else if (day === 6) {\n    // samedi -> vendredi\n    d.setUTCDate(d.getUTCDate() - 1);\n  }\n  return d.toISOString().slice(0, 10);\n}\n\n// Calcule automatiquement la largeur idéale de la colonne Task name\nfunction computeTaskColumnWidth(tasks) {\n  let maxChars = 10; // nombre minimal de caractères\n\n  (tasks || []).forEach((t) => {\n    const label =\n      t.type === \"project\"\n        ? (t.nom_appareil || t.text || \"\")\n        : (t.text || \"\");\n\n    if (label.length > maxChars) {\n      maxChars = label.length;\n    }\n  });\n\n  // approx : 7 px par caractère + padding\n  return Math.min(maxChars * 7 + 40, 600); // limite max 600px\n}\n\n// Charge dhtmlxGantt une seule fois\nfunction ensureGanttLoaded() {\n  if (window.gantt) return Promise.resolve();\n\n  if (window.ganttLoading) return window.ganttLoading;\n\n  window.ganttLoading = new Promise((resolve, reject) => {\n    const script = document.createElement(\"script\");\n    script.src = \"https://cdn.dhtmlx.com/gantt/edge/dhtmlxgantt.js\";\n    script.onload = () => resolve();\n    script.onerror = reject;\n    document.head.appendChild(script);\n  });\n\n  return window.ganttLoading;\n}\n\n// Format YYYY-MM-DD -> DD-MM-YYYY\nfunction formatDateFr(isoStr) {\n  if (!isoStr) return \"\";\n  const s = String(isoStr).slice(0, 10); // garde que AAAA-MM-JJ\n  const parts = s.split(\"-\");\n  if (parts.length !== 3) return s;\n  const [y, m, d] = parts;\n  return `${d}-${m}-${y}`;\n}\n\n// -------- Helpers pour jours ouvrés / nombre_jours --------\n\nfunction parsePositiveInt(val) {\n  const n = parseInt(val, 10);\n  return Number.isFinite(n) && n > 0 ? n : null;\n}\n\n// endIso = \"YYYY-MM-DD\", nbDays = nombre de jours ouvrés (>=1)\n// On recule nbDays-1 jours ouvrés pour avoir la date de début incluse\nfunction subtractBusinessDays(endIso, nbDays) {\n  if (!endIso) return null;\n  const d = new Date(endIso + \"T00:00:00Z\");\n\n  // si nbDays vaut 1 -> on ne recule pas (début = fin)\n  let remaining = Math.max(nbDays - 1, 0);\n\n  while (remaining > 0) {\n    d.setUTCDate(d.getUTCDate() - 1);\n    const day = d.getUTCDay(); // 0 = dimanche, 6 = samedi\n    if (day !== 0 && day !== 6) {\n      remaining--;\n    }\n  }\n\n  return d.toISOString().slice(0, 10);\n}\n\n// Calcule start/end d'une étape à partir de date_objectif (fin) et nombre_jours\n// - date_objectif peut tomber le week-end : on la ramène au vendredi\n// - nombre_jours = nb de jours ouvrés\n// Retourne { startStr, endStr } pour Gantt (endStr exclusive)\nfunction computeChildTaskDates(etape) {\n  const rawEnd = etape.date_objectif || etape.date_fin;\n  if (!rawEnd) return null;\n\n  // 1) fin ouvrée = date objectif ramenée au dernier jour ouvré\n  const rawEndIso = String(rawEnd).slice(0, 10); // YYYY-MM-DD\n  const endBusiness = normalizeToBusinessEnd(rawEndIso);\n  if (!endBusiness) return null;\n\n  // 2) nombre de jours ouvrés (min 1)\n  const nbJours = parsePositiveInt(etape.nombre_jours) || 1;\n\n  // 3) début = fin ouvrée - (nbJours - 1) jours ouvrés\n  const startStr = subtractBusinessDays(endBusiness, nbJours);\n\n  // 4) pour Gantt : end_date EXCLUSIVE = fin ouvrée + 1 jour\n  const dEnd = new Date(endBusiness + \"T00:00:00Z\");\n  dEnd.setUTCDate(dEnd.getUTCDate() + 1);\n  const endStr = dEnd.toISOString().slice(0, 10);\n\n  return { startStr, endStr };\n}\n\n// Gestion du zoom (échelles jour / semaine / mois)\nfunction setScale(level) {\n  if (!window.gantt) return;\n\n  switch (level) {\n    case \"day\":\n      gantt.config.scales = [\n        { unit: \"month\", step: 1, format: \"%F %Y\" },\n        { unit: \"day\", step: 1, format: \"%d-%m\" },\n      ];\n      break;\n\n    case \"month\":\n      gantt.config.scales = [\n        { unit: \"year\", step: 1, format: \"%Y\" },\n        { unit: \"month\", step: 1, format: \"%M\" },\n      ];\n      break;\n\n    case \"week\":\n    default:\n      gantt.config.scales = [\n        { unit: \"year\", step: 1, format: \"%Y\" },\n        {\n          unit: \"week\",\n          step: 1,\n          format: function (date) {\n            const weekStr = gantt.date.date_to_str(\"%W\")(date);\n            return \"S\" + weekStr;\n          },\n        },\n        { unit: \"day\", step: 1, format: \"%d\" },\n      ];\n      break;\n  }\n\n  gantt.render();\n}\n\n// ----- Marqueur \"aujourd'hui\" (ligne rouge) -----\nfunction refreshTodayMarker() {\n  if (!window.gantt || !gantt.addMarker) return;\n\n  const today = new Date();\n\n  // Supprimer l'ancien marqueur si besoin\n  if (window.todayMarkerId) {\n    gantt.deleteMarker(window.todayMarkerId);\n  }\n\n  // Ajouter un nouveau marqueur\n  window.todayMarkerId = gantt.addMarker({\n    start_date: today,\n    css: \"today-marker\",\n    text: \"\",\n    title: \"\",\n  });\n\n  gantt.renderMarkers();\n}\n\n// ----- Centrer le planning sur la date du jour -----\nfunction centerOnToday() {\n  if (!window.gantt) return;\n  const today = new Date();\n  gantt.showDate(today); // Gantt gère le scroll horizontal\n}\n\n\n// -------- Mapping des données Appsmith -> Gantt --------\n\n// Transforme QryDashboardSuiviFabrication.data -> { data: tasks, links }\nfunction mapRowsToGantt(rows) {\n  const tasks = [];\n  const links = [];\n\n  rows.forEach((r) => {\n    const appareilId = String(r.numero_appareil);\n    const appareilLabel = `${r.nom_appareil}`;\n    const etapes = Array.isArray(r.etapes) ? r.etapes : [];\n\n    const delaiStr = r.delai ? String(r.delai).slice(0, 10) : null;\n    const today = new Date().toISOString().slice(0, 10);\n\n    // --- préparation des étapes avec dates calculées (jours ouvrés) ---\n    const preparedEtapes = [];\n    etapes.forEach((e, idx) => {\n      const dates = computeChildTaskDates(e);\n      if (!dates) return;\n      preparedEtapes.push({\n        e,\n        idx,\n        startStr: dates.startStr,\n        endStr: dates.endStr,\n      });\n    });\n\n    // --- bornes min/max pour la barre projet ---\n    let firstStepStart = null;\n    let lastStepEnd = null;\n\n    preparedEtapes.forEach((p) => {\n      if (!firstStepStart || p.startStr < firstStepStart) {\n        firstStepStart = p.startStr;\n      }\n      if (!lastStepEnd || p.endStr > lastStepEnd) {\n        lastStepEnd = p.endStr;\n      }\n    });\n\n    const projectStart = firstStepStart || delaiStr || today;\n    const projectEnd = delaiStr || lastStepEnd || projectStart;\n\n    // --- tâche \"projet\" pour l'appareil ---\n    tasks.push({\n      id: appareilId,\n      text: appareilLabel,\n      nom_appareil: r.nom_appareil,\n      start_date: projectStart,\n      end_date: projectEnd,\n      delai: delaiStr,\n      type: \"project\",\n      open: false,\n    });\n\n    // --- étapes enfants ---\n    let prevChildId = null;\n\n    preparedEtapes.forEach((p) => {\n      const e = p.e;\n      const idx = p.idx;\n      const code = e.groupe_code || `ETAPE_${idx}`;\n      const libelle = e.groupe_libelle || code;\n\n      const childId = `${appareilId}_${code}_${idx}`;\n\n      // Flags jalons pour APPRO et ACHATS\n      const isAppro = code === \"APPRO\";\n      const isAchats = code === \"ACHATS\"; // adapte si besoin\n\n      tasks.push({\n        id: childId,\n        text: libelle,\n        start_date: p.startStr,\n        end_date: p.endStr,\n        parent: appareilId,\n        progress: 0,\n        status: e.statut_code,\n\n        date_objectif: e.date_objectif\n          ? String(e.date_objectif).slice(0, 10)\n          : null,\n\n        nombre_jours: e.nombre_jours,\n        groupe_code: e.groupe_code,\n        groupe_appareil_id: e.groupe_appareil_id,\n\n        // tâche affichée comme jalon, PAS comme une barre pour APPRO / ACHATS\n        isStepMilestone: isAppro || isAchats,\n      });\n\n      if (prevChildId) {\n        links.push({\n          id: `${prevChildId}->${childId}`,\n          source: prevChildId,\n          target: childId,\n          type: 0,\n        });\n      }\n      prevChildId = childId;\n    });\n\n    // --- JALON DELAI : toujours en dernier enfant ---\n    if (delaiStr) {\n      tasks.push({\n        id: appareilId + \"_deadline\",\n        text: \"Délai\",\n        start_date: delaiStr, // pour le positionnement sur le planning\n        parent: appareilId,\n        isDeadline: true,\n        date_objectif: delaiStr, // pour l'affichage dans \"Date obj.\"\n      });\n    }\n  });\n\n  return { data: tasks, links };\n}\n\n// -------- Initialisation + rendu Gantt --------\n\nasync function renderGantt() {\n  const rows = (appsmith.model && appsmith.model.rows) || [];\n  if (!Array.isArray(rows) || !rows.length) return;\n\n  await ensureGanttLoaded();\n\n  // on mappe D'ABORD les données -> tasks + links\n  const ganttData = mapRowsToGantt(rows);\n\n  // on calcule la largeur idéale de la colonne \"Désignation\"\n  const idealWidth = computeTaskColumnWidth(ganttData.data);\n\n  // Init une seule fois\n  if (!window.ganttInitialized) {\n    // activer le plugin \"marker\" pour la ligne rouge aujourd'hui\n    if (gantt.plugins) {\n      gantt.plugins({\n        marker: true,\n      });\n    }\n    gantt.config.show_markers = true;\n\n    // lecture seule\n    gantt.config.readonly = true;\n    gantt.config.date_format = \"%Y-%m-%d\";\n    gantt.config.min_column_width = 30; // taille des cases \"Jour\"\n    gantt.config.grid_resize = true;\n\n    // Colonnes du tableau à gauche\n    gantt.config.columns = [\n      {\n        name: \"text\",\n        label: \"Désignation\",\n        tree: true,\n        width: idealWidth,\n        min_width: 120,\n        template: function (task) {\n          // Pour les appareils : uniquement le nom_appareil\n          if (task.type === \"project\") {\n            return task.nom_appareil || task.text;\n          }\n          // Pour les étapes : libellé normal\n          return task.text;\n        },\n      },\n      {\n        // Colonne date objectif :\n        // appareil  -> délai de l'appareil\n        // étape     -> date objectif de l'étape\n        name: \"start_custom\",\n        label: \"Date obj.\",\n        align: \"center\",\n        width: 100,\n        template: function (task) {\n          if (task.type === \"project\") {\n            const d = task.delai || task.start_date;\n            return formatDateFr(d);\n          }\n          const d = task.date_objectif || task.start_date;\n          return formatDateFr(d);\n        },\n      },\n    ];\n\n    // Week-end en gris + jour courant en rouge clair\n\t\tconst todayStr = new Date().toISOString().slice(0, 10); // \"YYYY-MM-DD\"\n\t\tconst fmtIso = gantt.date.date_to_str(\"%Y-%m-%d\");\n\n\t\tgantt.templates.scale_cell_class = function (date) {\n\t\t\tconst day = date.getDay();\n\t\t\tconst dStr = fmtIso(date);\n\t\t\tconst classes = [];\n\n\t\t\tif (day === 0 || day === 6) classes.push(\"weekend\");\n\t\t\tif (dStr === todayStr) classes.push(\"today-scale\");\n\n\t\t\treturn classes.join(\" \");\n\t\t};\n\n\t\tgantt.templates.timeline_cell_class = function (task, date) {\n\t\t\tconst day = date.getDay();\n\t\t\tconst dStr = fmtIso(date);\n\t\t\tconst classes = [];\n\n\t\t\tif (day === 0 || day === 6) classes.push(\"weekend\");\n\t\t\tif (dStr === todayStr) classes.push(\"today-cell\");\n\n\t\t\treturn classes.join(\" \");\n\t\t};\n\n\n    // Classe CSS selon le statut + jalons\n    gantt.templates.task_class = function (start, end, task) {\n      const classes = [];\n\n      // jalon délai (ligne \"Délai\")\n      if (task.isDeadline) classes.push(\"deadline-milestone\");\n\n      // jalon pour APPRO / ACHATS\n      if (task.isStepMilestone) classes.push(\"step-milestone\");\n\n      // statut (couleur)\n      if (task.status) classes.push(\"status-\" + task.status);\n\n      return classes.join(\" \");\n    };\n\n    // Init gantt\n    gantt.init(\"gantt_here\");\n    window.ganttInitialized = true;\n\n    // Zoom par défaut : vue semaine\n    setScale(\"week\");\n\n    // Gestion des boutons de zoom dans la toolbar HTML\n    const toolbar = document.querySelector(\".planning-toolbar\");\n    if (toolbar) {\n      toolbar.addEventListener(\"click\", function (e) {\n        const btn = e.target.closest(\"button[data-zoom]\");\n        if (!btn) return;\n        const level = btn.getAttribute(\"data-zoom\");\n        setScale(level);\n      });\n    }\n  } else {\n    // si déjà initialisé, on met simplement à jour la largeur de la 1ère colonne\n    if (gantt.config.columns && gantt.config.columns.length > 0) {\n      gantt.config.columns[0].width = idealWidth;\n    }\n  }\n\n  // on applique les données\n  gantt.clearAll();\n  gantt.parse(ganttData);\n\n  // Marqueur \"aujourd'hui\" + centrage\n  refreshTodayMarker();\n  setTimeout(centerOnToday, 50); // petit délai pour que le DOM ait sa largeur définitive\n}\n\n// Initialisation et rafraîchissements\nappsmith.onReady(renderGantt);\nappsmith.onModelChange(renderGantt);\n"
  },
  "version": 1,
  "widgetId": "thmgta5mcr",
  "widgetName": "CustomPlanningCopy"
}