SELECT
  a.numero_appareil,
  a.numero_affaire,
  ca.nom_appareil,
  a.delai,
  aff.nom_client AS client,

  -- Stats globales par appareil (à adapter si tu veux d'autres règles)
  COUNT(wga.*) AS total_etapes,
  COUNT(*) FILTER (
    WHERE ws.code IN ('TERMINE', 'VALIDE_CLIENT')
  ) AS etapes_faites,
  COUNT(*) FILTER (
    WHERE ws.code IN ('EN_COURS', 'ATTENTE_CLIENT')
  ) AS etapes_en_cours,
  COUNT(*) FILTER (
    WHERE ws.code IN ('A_FAIRE')
  ) AS etapes_a_faire,
  COUNT(*) FILTER (
    WHERE ws.code = 'ATTENTE_CLIENT'
  ) AS nb_en_attente_client,

  -- Détail des grandes étapes pour l'appareil (utilisé dans l'UI)
  jsonb_agg(
    jsonb_build_object(
      -- Groupe (grande étape)
      'groupe_id',          wge.id,
      'groupe_code',        wge.code,        -- NOTE_CALCUL, PLAN, APPRO, ...
      'groupe_libelle',     wge.libelle,

      -- Statut
      'statut_id',          ws.id,
      'statut_code',        ws.code,         -- EN_COURS, TERMINE, ATTENTE_CLIENT, ...
      'statut_libelle',     ws.libelle,
      'statut_couleur',     ws.couleur,

      -- Données de suivi
      'date_debut',         wga.date_debut,
      'date_fin',           wga.date_fin,
      'date_envoi_client',  wga.date_envoi_client,
      'date_retour_client', wga.date_retour_client,
      'responsable',        wga.responsable,
      'commentaire',        wga.commentaire,
      'meta',               wga.meta,

      -- Id technique pour UPDATE
      'groupe_appareil_id', wga.id,

      -- Couleur directe pour l'UI (également = couleur du statut)
      'color',              ws.couleur
    )
    ORDER BY wge.ordre
  ) AS etapes

FROM public.appareils a
LEFT JOIN public.affaires aff
       ON aff.numero_affaire = a.numero_affaire
LEFT JOIN public.caracteristiques_appareils ca
       ON ca.numero_appareil = a.numero_appareil

LEFT JOIN public.workflow_groupe_appareil wga
       ON wga.numero_appareil = a.numero_appareil
LEFT JOIN public.workflow_groupe_etape wge
       ON wge.id = wga.groupe_id
LEFT JOIN public.workflow_statut ws
       ON ws.id = wga.statut_id

GROUP BY
  a.numero_appareil,
  a.numero_affaire,
  ca.nom_appareil,
  a.delai,
  aff.nom_client

ORDER BY a.numero_appareil DESC;
