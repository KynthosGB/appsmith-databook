{
  "backgroundColor": "#FFFFFF",
  "borderColor": "#E0DEDE",
  "borderRadius": "{{appsmith.theme.borderRadius.appBorderRadius}}",
  "borderWidth": "1",
  "bottomRow": 188,
  "boxShadow": "{{appsmith.theme.boxShadow.appBoxShadow}}",
  "defaultModel": "{{JSPlanningSuivi.getModel()}}",
  "dynamicBindingPathList": [
    {
      "key": "theme"
    },
    {
      "key": "borderRadius"
    },
    {
      "key": "boxShadow"
    },
    {
      "key": "defaultModel"
    }
  ],
  "dynamicHeight": "FIXED",
  "dynamicPropertyPathList": [
    {
      "key": "onAppareilClick"
    }
  ],
  "dynamicTriggerPathList": [
    {
      "key": "onAppareilClick"
    }
  ],
  "events": [
    "onAppareilClick"
  ],
  "isCanvas": false,
  "isLoading": false,
  "isSearchWildcard": true,
  "isVisible": true,
  "key": "ctx98s9hxm",
  "leftColumn": 3,
  "maxDynamicHeight": 9000,
  "minDynamicHeight": 4,
  "mobileBottomRow": 40,
  "mobileLeftColumn": 19,
  "mobileRightColumn": 42,
  "mobileTopRow": 10,
  "needsErrorInfo": false,
  "onAppareilClick": "{{ navigateTo(\n    \"Suivi fabrication appareil\",\n    {\n      numero_appareil: CustomPlanning.model.selectedNumeroAppareil,\n\t\t\tnumero_affaire: CustomPlanning.model.selectedNumeroAffaire\n    },\n    \"NEW_WINDOW\"\n) }}\n",
  "originalBottomRow": 188,
  "originalTopRow": 158,
  "parentColumnSpace": 20.25,
  "parentId": "0",
  "parentRowSpace": 10,
  "renderMode": "CANVAS",
  "rightColumn": 49,
  "shouldScrollContents": true,
  "srcDoc": {
    "css": "@charset \"UTF-8\";\n#root {\n  font-family: system-ui, -apple-system, BlinkMacSystemFont, \"Segoe UI\", sans-serif;\n  font-size: 11px;\n  color: #111827;\n  padding: 8px;\n  /* On √©vite tout scroll interne au root, c'est le container Appsmith qui g√®re */\n  overflow-x: hidden;\n  overflow-y: hidden;\n}\n\n/* L√©gende en haut (reste fixe) */\n.planning-legend {\n  margin-bottom: 6px;\n  display: flex;\n  gap: 12px;\n  font-size: 11px;\n  color: #4b5563;\n}\n\n.planning-legend-item {\n  display: flex;\n  align-items: center;\n  gap: 4px;\n}\n\n.planning-legend-color {\n  width: 10px;\n  height: 10px;\n  border-radius: 2px;\n  border: 1px solid #d1d5db;\n}\n\n/* Bloc principal du planning */\n.planning-root {\n  border: 1px solid #d1d5db;\n  border-radius: 6px;\n  background: #ffffff;\n  overflow: hidden; /* pas de scroll interne ici */\n}\n\n/* Deux colonnes : labels √† gauche, calendrier √† droite */\n.planning-main {\n  display: flex;\n  align-items: stretch;\n}\n\n/* Colonne gauche : appareils */\n.planning-col-labels {\n  flex: 0 0 220px; /* largeur fixe */\n}\n\n/* Colonne droite : jours (scroll horizontal uniquement) */\n.planning-col-days {\n  flex: 1;\n  overflow-x: auto;\n  overflow-y: hidden;\n  padding-bottom: 12px; /* espace pour la barre de scroll horizontale */\n  box-sizing: content-box;\n}\n\n/* En-t√™te \"Appareil\" */\n.planning-header-label {\n  padding: 19px 6px;\n  font-weight: 600;\n  background: #f3f4f6;\n  border-right: 1px solid #d1d5db;\n  border-bottom: 1px solid #d1d5db;\n}\n\n/* Libell√© appareil ligne */\n.planning-row-label {\n  padding: 3px 6px;\n  border-right: 1px solid #d1d5db;\n  border-bottom: 1px solid #e5e7eb;\n  background: #f9fafb;\n  white-space: nowrap;\n  overflow: hidden;\n  text-overflow: ellipsis;\n}\n\n/* --- EN-T√äTES CALENDRIER --- */\n.planning-years-header,\n.planning-weeks-header {\n  display: flex;\n}\n\n.planning-header-year {\n  text-align: center;\n  padding: 2px 0;\n  font-weight: 500;\n  border-right: 1px solid #c5cde6;\n  background: #eef2ff;\n  box-sizing: border-box;\n}\n\n.planning-header-week {\n  text-align: center;\n  padding: 2px 0;\n  font-weight: 500;\n  border-right: 1px solid #e5e7eb;\n  background: #e5e7eb;\n  border: 1px solid #d7d9db;\n  box-sizing: border-box;\n}\n\n.planning-days-header {\n  display: grid;\n  grid-auto-flow: column;\n  grid-auto-columns: 24px; /* largeur d'un jour */\n}\n\n/* cellules Jour (derni√®re ligne d'ent√™te) */\n.planning-header-day {\n  text-align: center;\n  padding: 3px 0;\n  font-weight: 500;\n  border-right: 1px solid #e5e7eb;\n  border-bottom: 1px solid #d1d5db;\n  background: #f9fafb;\n  box-sizing: border-box;\n}\n\n/* --- LIGNES CALENDRIER --- */\n.planning-days-row {\n  display: grid;\n  grid-auto-flow: column;\n  grid-auto-columns: 24px;\n}\n\n.planning-day-cell {\n  border-right: 1px solid #e5e7eb;\n  border-bottom: 1px solid #e5e7eb;\n  text-align: center;\n  box-sizing: border-box;\n  position: relative;\n  padding: 2px;\n  font-size: 13px;\n}\n\n.planning-letter {\n  display: inline-flex;\n  align-items: center;\n  justify-content: center;\n  width: 100%;\n  height: 100%;\n  font-weight: 600;\n  border-radius: 2px;\n}\n\n.planning-flag {\n  position: absolute;\n  top: 1px;\n  right: 1px;\n  font-size: 11px;\n}",
    "html": "<div id=\"root\"></div>",
    "js": "import React from \"https://cdn.jsdelivr.net/npm/react@18.2.0/+esm\";\nimport ReactDOM from \"https://cdn.jsdelivr.net/npm/react-dom@18.2.0/+esm\";\nconst DAY_WIDTH = 24; // largeur d'un jour en px\n\n// Calcule la semaine ISO (S01..S53) pour une Date en UTC\nfunction getISOWeek(date) {\n  const tmp = new Date(date.getTime());\n  tmp.setUTCHours(0, 0, 0, 0);\n  // Jeudi de la semaine en cours\n  tmp.setUTCDate(tmp.getUTCDate() + 3 - (tmp.getUTCDay() + 6) % 7);\n  const week1 = new Date(Date.UTC(tmp.getUTCFullYear(), 0, 4));\n  return 1 + Math.round(((tmp.getTime() - week1.getTime()) / 86400000 - 3 + (week1.getUTCDay() + 6) % 7) / 7);\n}\nfunction buildDays(startDateStr, daysCount, todayStr) {\n  const out = [];\n  if (!startDateStr) return out;\n  const [y, m, d] = startDateStr.split(\"-\").map(Number);\n  const start = new Date(Date.UTC(y, m - 1, d));\n  for (let i = 0; i < daysCount; i++) {\n    const day = new Date(start);\n    day.setUTCDate(start.getUTCDate() + i);\n    const yyyy = day.getUTCFullYear();\n    const mm = String(day.getUTCMonth() + 1).padStart(2, \"0\");\n    const dd = String(day.getUTCDate()).toString().padStart(2, 0);\n    const iso = `${yyyy}-${mm}-${dd}`;\n    const week = getISOWeek(day);\n    const weekLabel = \"S\" + String(week).padStart(2, \"0\");\n    const dow = day.getUTCDay(); // 0 = dimanche, 6 = samedi\n    const isWeekend = dow === 0 || dow === 6;\n    out.push({\n      key: iso,\n      label: dd,\n      // jour\n      isToday: iso === todayStr,\n      isWeekend,\n      // üëà nouveau\n      year: yyyy,\n      weekLabel // S40, S41...\n    });\n  }\n  return out;\n}\n\n// Construit des \"bandes\" continues (valeur + nbJours cons√©cutifs)\nfunction buildBands(dayList, getKey) {\n  const bands = [];\n  if (!dayList.length) return bands;\n  let current = {\n    value: getKey(dayList[0]),\n    span: 1\n  };\n  for (let i = 1; i < dayList.length; i++) {\n    const v = getKey(dayList[i]);\n    if (v === current.value) {\n      current.span += 1;\n    } else {\n      bands.push(current);\n      current = {\n        value: v,\n        span: 1\n      };\n    }\n  }\n  bands.push(current);\n  return bands;\n}\nfunction App() {\n  const {\n    rows = [],\n    startDate,\n    days = 30,\n    today,\n    legend = []\n  } = appsmith.model || {};\n  const dayList = buildDays(startDate, days, today);\n\n  // largeur totale de la bande de jours\n  const daysWidth = dayList.length * DAY_WIDTH;\n  const yearBands = buildBands(dayList, d => d.year);\n  const weekBands = buildBands(dayList, d => d.weekLabel);\n\n  // üëá ref sur la zone scrollable + flag \"d√©j√† scroll√©\"\n  const scrollRef = React.useRef(null);\n  const hasAutoScrolledRef = React.useRef(false);\n\n  // üëá au premier rendu, on centre la date du jour\n  React.useEffect(() => {\n    const container = scrollRef.current;\n    if (!container) return;\n    if (hasAutoScrolledRef.current) return; // √©viter de recentrer apr√®s scroll manuel\n\n    const idxToday = dayList.findIndex(d => d.isToday);\n    if (idxToday === -1) return;\n    const visibleWidth = container.clientWidth || 0;\n    const totalWidth = dayList.length * DAY_WIDTH;\n\n    // position de la colonne du jour\n    let target = idxToday * DAY_WIDTH - visibleWidth / 2 + DAY_WIDTH / 2;\n\n    // bornes\n    if (target < 0) target = 0;\n    if (target > totalWidth - visibleWidth) {\n      target = totalWidth - visibleWidth;\n    }\n    container.scrollLeft = target;\n    hasAutoScrolledRef.current = true;\n  }, [dayList.length, today]);\n\n  // üëá fonction appel√©e au clic sur un appareil\n  const handleAppareilClick = row => {\n    if (!row) return;\n\n    // 1) on stocke les infos dans le model du widget\n    appsmith.updateModel({\n      selectedNumeroAppareil: row.appareil,\n      // adapte si c'est row.numero_appareil\n      selectedNumeroAffaire: row.affaire\n    });\n\n    // 2) on d√©clenche l'event (sans payload, ce n'est pas n√©cessaire)\n    appsmith.triggerEvent(\"onAppareilClick\");\n  };\n  return /*#__PURE__*/React.createElement(\"div\", null, /*#__PURE__*/React.createElement(\"div\", {\n    className: \"planning-legend\"\n  }, legend.map(st => /*#__PURE__*/React.createElement(\"div\", {\n    key: st.id,\n    className: \"planning-legend-item\"\n  }, /*#__PURE__*/React.createElement(\"span\", {\n    className: \"planning-legend-color\",\n    style: {\n      backgroundColor: st.couleur\n    }\n  }), /*#__PURE__*/React.createElement(\"span\", null, st.libelle)))), /*#__PURE__*/React.createElement(\"div\", {\n    className: \"planning-root\"\n  }, /*#__PURE__*/React.createElement(\"div\", {\n    className: \"planning-main\"\n  }, /*#__PURE__*/React.createElement(\"div\", {\n    className: \"planning-col-labels\"\n  }, /*#__PURE__*/React.createElement(\"div\", {\n    className: \"planning-header-label\"\n  }, \"Appareil\"), rows.map(row => /*#__PURE__*/React.createElement(\"div\", {\n    key: row.appareil,\n    className: \"planning-row-label\",\n    onClick: () => handleAppareilClick(row),\n    style: {\n      cursor: \"pointer\",\n      textDecoration: \"underline\"\n    }\n  }, row.label))), /*#__PURE__*/React.createElement(\"div\", {\n    className: \"planning-col-days\",\n    ref: scrollRef\n  }, /*#__PURE__*/React.createElement(\"div\", {\n    className: \"planning-years-header\",\n    style: {\n      width: daysWidth\n    }\n  }, yearBands.map((b, idx) => /*#__PURE__*/React.createElement(\"div\", {\n    key: `year-${idx}`,\n    className: \"planning-header-year\",\n    style: {\n      width: b.span * DAY_WIDTH\n    }\n  }, b.value))), /*#__PURE__*/React.createElement(\"div\", {\n    className: \"planning-weeks-header\",\n    style: {\n      width: daysWidth\n    }\n  }, weekBands.map((b, idx) => /*#__PURE__*/React.createElement(\"div\", {\n    key: `week-${idx}`,\n    className: \"planning-header-week\",\n    style: {\n      width: b.span * DAY_WIDTH\n    }\n  }, b.value))), /*#__PURE__*/React.createElement(\"div\", {\n    className: \"planning-days-header\",\n    style: {\n      width: daysWidth\n    }\n  }, dayList.map(d => {\n    const borderLeft = d.isToday ? \"2px solid #ef4444\" : \"1px solid #e5e7eb\";\n    let backgroundColor;\n    if (d.isToday) {\n      backgroundColor = \"#fee2e2\"; // aujourd'hui\n    } else if (d.isWeekend) {\n      backgroundColor = \"#e5e7eb\"; // samedi/dimanche\n    } else {\n      backgroundColor = \"#f9fafb\"; // jour normal\n    }\n    return /*#__PURE__*/React.createElement(\"div\", {\n      key: \"day-\" + d.key,\n      className: \"planning-header-day\",\n      \"data-today\": d.isToday ? \"1\" : \"0\",\n      style: {\n        borderLeft,\n        backgroundColor\n      }\n    }, d.label);\n  })), rows.map(row => {\n    const eventMap = {};\n    (row.events || []).forEach(ev => {\n      eventMap[ev.date] = ev;\n    });\n    const delaiStr = row.delai ? String(row.delai).slice(0, 10) : null;\n    return /*#__PURE__*/React.createElement(\"div\", {\n      key: row.appareil,\n      className: \"planning-days-row\",\n      style: {\n        width: daysWidth\n      }\n    }, dayList.map(d => {\n      const ev = eventMap[d.key];\n      const borderLeft = d.isToday ? \"2px solid #ef4444\" : \"1px solid #e5e7eb\";\n      const isDelai = delaiStr && d.key === delaiStr;\n      const backgroundColor = d.isWeekend ? \"#f3f4f6\" : undefined;\n      return /*#__PURE__*/React.createElement(\"div\", {\n        key: d.key,\n        className: \"planning-day-cell\",\n        style: {\n          borderLeft,\n          backgroundColor\n        }\n      }, ev && /*#__PURE__*/React.createElement(\"div\", {\n        className: \"planning-letter\",\n        style: {\n          backgroundColor: ev.color\n        },\n        title: `${ev.lettre} - ${ev.statut}`\n      }, ev.lettre), isDelai && /*#__PURE__*/React.createElement(\"div\", {\n        className: \"planning-flag\",\n        title: \"D\\xE9lai\"\n      }, \"\\uD83D\\uDEA9\"));\n    }));\n  }), /*#__PURE__*/React.createElement(\"div\", {\n    className: \"planning-days-row planning-days-row-ghost\",\n    style: {\n      width: daysWidth\n    }\n  }, dayList.map(d => /*#__PURE__*/React.createElement(\"div\", {\n    key: d.key,\n    className: \"planning-day-cell\"\n  })))))));\n}\n\n// essaie une fois de centrer la date du jour, retourne true si OK\nfunction centerTodayOnce() {\n  const rootEl = document.getElementById(\"root\");\n  if (!rootEl) return false;\n  const container = rootEl.querySelector(\".planning-col-days\");\n  if (!container) return false;\n  const todayCell = container.querySelector('.planning-header-day[data-today=\"1\"]');\n  if (!todayCell) return false;\n  const cellWidth = todayCell.offsetWidth || 0;\n  const cellLeft = todayCell.offsetLeft || 0;\n  const visibleWidth = container.clientWidth || 0;\n  const scrollWidth = container.scrollWidth || 0;\n  if (!visibleWidth || !scrollWidth) return false;\n  let target = cellLeft - visibleWidth / 2 + cellWidth / 2;\n  if (target < 0) target = 0;\n  const maxScroll = scrollWidth - visibleWidth;\n  if (target > maxScroll) target = maxScroll;\n  container.scrollLeft = target;\n  return true;\n}\n\n// lance plusieurs tentatives espac√©es (donn√©es qui arrivent en retard, redraw Appsmith, etc.)\nfunction centerTodayWithRetry() {\n  let attempts = 0;\n  const maxAttempts = 20; // ~2s si interval = 100ms\n\n  const timer = setInterval(() => {\n    attempts += 1;\n    const ok = centerTodayOnce();\n    if (ok || attempts >= maxAttempts) {\n      clearInterval(timer);\n    }\n  }, 100);\n}\nfunction render() {\n  const rootEl = document.getElementById(\"root\");\n  if (!rootEl) return;\n  ReactDOM.render(/*#__PURE__*/React.createElement(App, null), rootEl);\n  centerTodayWithRetry();\n}\nappsmith.onReady(render);\nappsmith.onModelChange(render);"
  },
  "theme": "{{appsmith.theme}}",
  "topRow": 158,
  "type": "CUSTOM_WIDGET",
  "uncompiledSrcDoc": {
    "css": "#root {\n  font-family: system-ui, -apple-system, BlinkMacSystemFont, \"Segoe UI\",\n    sans-serif;\n  font-size: 11px;\n  color: #111827;\n  padding: 8px;\n  /* On √©vite tout scroll interne au root, c'est le container Appsmith qui g√®re */\n  overflow-x: hidden;\n  overflow-y: hidden;\n}\n\n/* L√©gende en haut (reste fixe) */\n.planning-legend {\n  margin-bottom: 6px;\n  display: flex;\n  gap: 12px;\n  font-size: 11px;\n  color: #4b5563;\n}\n.planning-legend-item {\n  display: flex;\n  align-items: center;\n  gap: 4px;\n}\n.planning-legend-color {\n  width: 10px;\n  height: 10px;\n  border-radius: 2px;\n  border: 1px solid #d1d5db;\n}\n\n/* Bloc principal du planning */\n.planning-root {\n  border: 1px solid #d1d5db;\n  border-radius: 6px;\n  background: #ffffff;\n  overflow: hidden; /* pas de scroll interne ici */\n}\n\n/* Deux colonnes : labels √† gauche, calendrier √† droite */\n.planning-main {\n  display: flex;\n  align-items: stretch;\n}\n\n/* Colonne gauche : appareils */\n.planning-col-labels {\n  flex: 0 0 220px; /* largeur fixe */\n}\n\n/* Colonne droite : jours (scroll horizontal uniquement) */\n.planning-col-days {\n  flex: 1;\n  overflow-x: auto;\n  overflow-y: hidden;\n  padding-bottom: 12px;   /* espace pour la barre de scroll horizontale */\n  box-sizing: content-box;\n}\n\n/* En-t√™te \"Appareil\" */\n.planning-header-label {\n  padding: 19px 6px;\n  font-weight: 600;\n  background: #f3f4f6;\n  border-right: 1px solid #d1d5db;\n  border-bottom: 1px solid #d1d5db;\n}\n\n/* Libell√© appareil ligne */\n.planning-row-label {\n  padding: 3px 6px;\n  border-right: 1px solid #d1d5db;\n  border-bottom: 1px solid #e5e7eb;\n  background: #f9fafb;\n  white-space: nowrap;\n  overflow: hidden;\n  text-overflow: ellipsis;\n}\n\n/* --- EN-T√äTES CALENDRIER --- */\n\n.planning-years-header,\n.planning-weeks-header {\n  display: flex;\n}\n\n.planning-header-year {\n  text-align: center;\n  padding: 2px 0;\n  font-weight: 500;\n  border-right: 1px solid #c5cde6;\n  background: #eef2ff;\n  box-sizing: border-box;\n}\n\n.planning-header-week {\n  text-align: center;\n  padding: 2px 0;\n  font-weight: 500;\n  border-right: 1px solid #e5e7eb;\n  background: #e5e7eb;\n  border: 1px solid #d7d9db;\n  box-sizing: border-box;\n}\n\n.planning-days-header {\n  display: grid;\n  grid-auto-flow: column;\n  grid-auto-columns: 24px; /* largeur d'un jour */\n}\n\n/* cellules Jour (derni√®re ligne d'ent√™te) */\n.planning-header-day {\n  text-align: center;\n  padding: 3px 0;\n  font-weight: 500;\n  border-right: 1px solid #e5e7eb;\n  border-bottom: 1px solid #d1d5db;\n  background: #f9fafb;\n  box-sizing: border-box;\n}\n\n/* --- LIGNES CALENDRIER --- */\n\n.planning-days-row {\n  display: grid;\n  grid-auto-flow: column;\n  grid-auto-columns: 24px;\n}\n\n.planning-day-cell {\n  border-right: 1px solid #e5e7eb;\n  border-bottom: 1px solid #e5e7eb;\n  text-align: center;\n  box-sizing: border-box;\n  position: relative;\n  padding: 2px;\n  font-size: 13px;\n}\n\n.planning-letter {\n  display: inline-flex;\n  align-items: center;\n  justify-content: center;\n  width: 100%;\n  height: 100%;\n  font-weight: 600;\n  border-radius: 2px;\n}\n\n.planning-flag {\n  position: absolute;\n  top: 1px;\n  right: 1px;\n  font-size: 11px;\n}\n",
    "html": "<div id=\"root\"></div>",
    "js": "import React from \"https://cdn.jsdelivr.net/npm/react@18.2.0/+esm\";\nimport ReactDOM from \"https://cdn.jsdelivr.net/npm/react-dom@18.2.0/+esm\";\n\nconst DAY_WIDTH = 24; // largeur d'un jour en px\n\n// Calcule la semaine ISO (S01..S53) pour une Date en UTC\nfunction getISOWeek(date) {\n  const tmp = new Date(date.getTime());\n  tmp.setUTCHours(0, 0, 0, 0);\n  // Jeudi de la semaine en cours\n  tmp.setUTCDate(tmp.getUTCDate() + 3 - ((tmp.getUTCDay() + 6) % 7));\n  const week1 = new Date(Date.UTC(tmp.getUTCFullYear(), 0, 4));\n  return (\n    1 +\n    Math.round(\n      ((tmp.getTime() - week1.getTime()) / 86400000 -\n        3 +\n        ((week1.getUTCDay() + 6) % 7)) /\n        7\n    )\n  );\n}\n\nfunction buildDays(startDateStr, daysCount, todayStr) {\n  const out = [];\n  if (!startDateStr) return out;\n\n  const [y, m, d] = startDateStr.split(\"-\").map(Number);\n  const start = new Date(Date.UTC(y, m - 1, d));\n\n  for (let i = 0; i < daysCount; i++) {\n    const day = new Date(start);\n    day.setUTCDate(start.getUTCDate() + i);\n\n    const yyyy = day.getUTCFullYear();\n    const mm = String(day.getUTCMonth() + 1).padStart(2, \"0\");\n    const dd = String(day.getUTCDate()).toString().padStart(2, 0);\n    const iso = `${yyyy}-${mm}-${dd}`;\n\n    const week = getISOWeek(day);\n    const weekLabel = \"S\" + String(week).padStart(2, \"0\");\n\n    const dow = day.getUTCDay();              // 0 = dimanche, 6 = samedi\n    const isWeekend = dow === 0 || dow === 6;\n\n    out.push({\n      key: iso,\n      label: dd,             // jour\n      isToday: iso === todayStr,\n      isWeekend,             // üëà nouveau\n      year: yyyy,\n      weekLabel,             // S40, S41...\n    });\n  }\n\n  return out;\n}\n\n\n// Construit des \"bandes\" continues (valeur + nbJours cons√©cutifs)\nfunction buildBands(dayList, getKey) {\n  const bands = [];\n  if (!dayList.length) return bands;\n\n  let current = {\n    value: getKey(dayList[0]),\n    span: 1,\n  };\n\n  for (let i = 1; i < dayList.length; i++) {\n    const v = getKey(dayList[i]);\n    if (v === current.value) {\n      current.span += 1;\n    } else {\n      bands.push(current);\n      current = { value: v, span: 1 };\n    }\n  }\n  bands.push(current);\n  return bands;\n}\n\nfunction App() {\n  const { rows = [], startDate, days = 30, today, legend = [] } = appsmith.model || {};\n  const dayList = buildDays(startDate, days, today);\n\n  // largeur totale de la bande de jours\n  const daysWidth = dayList.length * DAY_WIDTH;\n\n  const yearBands = buildBands(dayList, (d) => d.year);\n  const weekBands = buildBands(dayList, (d) => d.weekLabel);\n\t\n\t// üëá ref sur la zone scrollable + flag \"d√©j√† scroll√©\"\n  const scrollRef = React.useRef(null);\n  const hasAutoScrolledRef = React.useRef(false);\n\n  // üëá au premier rendu, on centre la date du jour\n  React.useEffect(() => {\n    const container = scrollRef.current;\n    if (!container) return;\n    if (hasAutoScrolledRef.current) return; // √©viter de recentrer apr√®s scroll manuel\n\n    const idxToday = dayList.findIndex((d) => d.isToday);\n    if (idxToday === -1) return;\n\n    const visibleWidth = container.clientWidth || 0;\n    const totalWidth = dayList.length * DAY_WIDTH;\n\n    // position de la colonne du jour\n    let target =\n      idxToday * DAY_WIDTH - visibleWidth / 2 + DAY_WIDTH / 2;\n\n    // bornes\n    if (target < 0) target = 0;\n    if (target > totalWidth - visibleWidth) {\n      target = totalWidth - visibleWidth;\n    }\n\n    container.scrollLeft = target;\n    hasAutoScrolledRef.current = true;\n  }, [dayList.length, today]);\n\t\n\t// üëá fonction appel√©e au clic sur un appareil\n\tconst handleAppareilClick = (row) => {\n\t\tif (!row) return;\n\n\t\t// 1) on stocke les infos dans le model du widget\n\t\tappsmith.updateModel({\n\t\t\tselectedNumeroAppareil: row.appareil,   // adapte si c'est row.numero_appareil\n\t\t\tselectedNumeroAffaire: row.affaire,\n\t\t});\n\n\t\t// 2) on d√©clenche l'event (sans payload, ce n'est pas n√©cessaire)\n\t\tappsmith.triggerEvent(\"onAppareilClick\");\n\t};\n\n\n  return (\n    <div>\n      {/* L√©gende en haut (ne bouge pas au scroll) */}\n            {/* L√©gende en haut (ne bouge pas au scroll) */}\n      <div className=\"planning-legend\">\n        {legend.map((st) => (\n          <div key={st.id} className=\"planning-legend-item\">\n            <span\n              className=\"planning-legend-color\"\n              style={{ backgroundColor: st.couleur }}\n            ></span>\n            <span>{st.libelle}</span>\n          </div>\n        ))}\n      </div>\n\n\n      {/* Planning */}\n      <div className=\"planning-root\">\n        <div className=\"planning-main\">\n          {/* Colonne fixe : Appareils */}\n          <div className=\"planning-col-labels\">\n            <div className=\"planning-header-label\">Appareil</div>\n            {rows.map((row) => (\n              <div key={row.appareil} className=\"planning-row-label\" onClick={() => handleAppareilClick(row)} style={{ cursor: \"pointer\", textDecoration: \"underline\" }}>\n                {row.label}\n              </div>\n            ))}\n          </div>\n\n          {/* Colonne scrollable : calendrier */}\n          <div className=\"planning-col-days\" ref={scrollRef}>\n            {/* --- En-t√™tes ann√©es / semaines / jours --- */}\n\n            {/* Ann√©es regroup√©es */}\n            <div className=\"planning-years-header\" style={{ width: daysWidth }}>\n              {yearBands.map((b, idx) => (\n                <div\n                  key={`year-${idx}`}\n                  className=\"planning-header-year\"\n                  style={{ width: b.span * DAY_WIDTH }}\n                >\n                  {b.value}\n                </div>\n              ))}\n            </div>\n\n            {/* Semaines regroup√©es */}\n            <div className=\"planning-weeks-header\" style={{ width: daysWidth }}>\n              {weekBands.map((b, idx) => (\n                <div\n                  key={`week-${idx}`}\n                  className=\"planning-header-week\"\n                  style={{ width: b.span * DAY_WIDTH }}\n                >\n                  {b.value}\n                </div>\n              ))}\n            </div>\n\n            {/* Jours (1 cellule par jour) */}\n            <div className=\"planning-days-header\" style={{ width: daysWidth }}>\n\t\t\t\t\t\t{dayList.map((d) => {\n\t\t\t\t\t\t\tconst borderLeft = d.isToday\n\t\t\t\t\t\t\t\t? \"2px solid #ef4444\"\n\t\t\t\t\t\t\t\t: \"1px solid #e5e7eb\";\n\n\t\t\t\t\t\t\tlet backgroundColor;\n\t\t\t\t\t\t\tif (d.isToday) {\n\t\t\t\t\t\t\t\tbackgroundColor = \"#fee2e2\";        // aujourd'hui\n\t\t\t\t\t\t\t} else if (d.isWeekend) {\n\t\t\t\t\t\t\t\tbackgroundColor = \"#e5e7eb\";        // samedi/dimanche\n\t\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\t\tbackgroundColor = \"#f9fafb\";        // jour normal\n\t\t\t\t\t\t\t}\n\n\t\t\t\t\t\t\treturn (\n\t\t\t\t\t\t\t\t<div\n\t\t\t\t\t\t\t\t\tkey={\"day-\" + d.key}\n\t\t\t\t\t\t\t\t\tclassName=\"planning-header-day\"\n\t\t\t\t\t\t\t\t\tdata-today={d.isToday ? \"1\" : \"0\"}\n\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\tborderLeft,\n\t\t\t\t\t\t\t\t\t\tbackgroundColor,\n\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t{d.label}\n\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t);\n\t\t\t\t\t\t})}\n\t\t\t\t\t</div>\n\n            {/* --- Lignes d'appareils --- */}\n            {rows.map((row) => {\n\t\t\t\t\t\tconst eventMap = {};\n\t\t\t\t\t\t(row.events || []).forEach((ev) => {\n\t\t\t\t\t\t\teventMap[ev.date] = ev;\n\t\t\t\t\t\t});\n\n\t\t\t\t\t\tconst delaiStr = row.delai ? String(row.delai).slice(0, 10) : null;\n\n\t\t\t\t\t\treturn (\n\t\t\t\t\t\t\t<div\n\t\t\t\t\t\t\t\tkey={row.appareil}\n\t\t\t\t\t\t\t\tclassName=\"planning-days-row\"\n\t\t\t\t\t\t\t\tstyle={{ width: daysWidth }}\n\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t{dayList.map((d) => {\n\t\t\t\t\t\t\t\t\tconst ev = eventMap[d.key];\n\t\t\t\t\t\t\t\t\tconst borderLeft = d.isToday\n\t\t\t\t\t\t\t\t\t\t? \"2px solid #ef4444\"\n\t\t\t\t\t\t\t\t\t\t: \"1px solid #e5e7eb\";\n\n\t\t\t\t\t\t\t\t\tconst isDelai = delaiStr && d.key === delaiStr;\n\n\t\t\t\t\t\t\t\t\tconst backgroundColor = d.isWeekend ? \"#f3f4f6\" : undefined;\n\n\t\t\t\t\t\t\t\t\treturn (\n\t\t\t\t\t\t\t\t\t\t<div\n\t\t\t\t\t\t\t\t\t\t\tkey={d.key}\n\t\t\t\t\t\t\t\t\t\t\tclassName=\"planning-day-cell\"\n\t\t\t\t\t\t\t\t\t\t\tstyle={{ borderLeft, backgroundColor }}\n\t\t\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t\t\t{ev && (\n\t\t\t\t\t\t\t\t\t\t\t\t<div\n\t\t\t\t\t\t\t\t\t\t\t\t\tclassName=\"planning-letter\"\n\t\t\t\t\t\t\t\t\t\t\t\t\tstyle={{ backgroundColor: ev.color }}\n\t\t\t\t\t\t\t\t\t\t\t\t\ttitle={`${ev.lettre} - ${ev.statut}`}\n\t\t\t\t\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t\t\t\t\t{ev.lettre}\n\t\t\t\t\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t\t\t\t)}\n\n\t\t\t\t\t\t\t\t\t\t\t{isDelai && (\n\t\t\t\t\t\t\t\t\t\t\t\t<div className=\"planning-flag\" title=\"D√©lai\">\n\t\t\t\t\t\t\t\t\t\t\t\t\tüö©\n\t\t\t\t\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t\t\t\t)}\n\t\t\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t\t);\n\t\t\t\t\t\t\t\t})}\n\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t);\n\t\t\t\t\t})}\n\t\t\t\t\t{/* Ligne fant√¥me pour laisser de la place √† la scrollbar */}\n\t\t\t\t\t<div\n\t\t\t\t\t\tclassName=\"planning-days-row planning-days-row-ghost\"\n\t\t\t\t\t\tstyle={{ width: daysWidth }}\n\t\t\t\t\t>\n\t\t\t\t\t\t{dayList.map((d) => (\n\t\t\t\t\t\t\t<div\n\t\t\t\t\t\t\t\tkey={d.key}\n\t\t\t\t\t\t\t\tclassName=\"planning-day-cell\"\n\t\t\t\t\t\t\t/>\n\t\t\t\t\t\t))}\n\t\t\t\t\t</div>\n\n          </div>\n        </div>\n      </div>\n    </div>\n  );\n}\n\n// essaie une fois de centrer la date du jour, retourne true si OK\nfunction centerTodayOnce() {\n  const rootEl = document.getElementById(\"root\");\n  if (!rootEl) return false;\n\n  const container = rootEl.querySelector(\".planning-col-days\");\n  if (!container) return false;\n\n  const todayCell = container.querySelector(\n    '.planning-header-day[data-today=\"1\"]'\n  );\n  if (!todayCell) return false;\n\n  const cellWidth = todayCell.offsetWidth || 0;\n  const cellLeft = todayCell.offsetLeft || 0;\n  const visibleWidth = container.clientWidth || 0;\n  const scrollWidth = container.scrollWidth || 0;\n\n  if (!visibleWidth || !scrollWidth) return false;\n\n  let target =\n    cellLeft - visibleWidth / 2 + cellWidth / 2;\n\n  if (target < 0) target = 0;\n  const maxScroll = scrollWidth - visibleWidth;\n  if (target > maxScroll) target = maxScroll;\n\n  container.scrollLeft = target;\n  return true;\n}\n\n// lance plusieurs tentatives espac√©es (donn√©es qui arrivent en retard, redraw Appsmith, etc.)\nfunction centerTodayWithRetry() {\n  let attempts = 0;\n  const maxAttempts = 20;   // ~2s si interval = 100ms\n\n  const timer = setInterval(() => {\n    attempts += 1;\n    const ok = centerTodayOnce();\n    if (ok || attempts >= maxAttempts) {\n      clearInterval(timer);\n    }\n  }, 100);\n}\n\n\nfunction render() {\n  const rootEl = document.getElementById(\"root\");\n  if (!rootEl) return;\n  ReactDOM.render(<App />, rootEl);\n\t\n\tcenterTodayWithRetry();\n}\n\nappsmith.onReady(render);\nappsmith.onModelChange(render);\n"
  },
  "version": 1,
  "widgetId": "5nqeyv7e5x",
  "widgetName": "CustomPlanning"
}