{
  "gitSyncId": "6915b9d6a2ab6852a3eeef70_54259a97-bdd9-443f-b27c-e7f0e52307d8",
  "id": "Tableau de bord fabrication_QryDashboardSuiviFabrication",
  "pluginId": "postgres-plugin",
  "pluginType": "DB",
  "unpublishedAction": {
    "actionConfiguration": {
      "body": "SELECT\n  a.numero_appareil,\n  a.numero_affaire,\n  ca.nom_appareil,\n  a.delai,\n  aff.nom_client AS client,\n\n  -- Stats globales par appareil\n  COUNT(wga.*) AS total_etapes,\n  COUNT(*) FILTER (WHERE wga.statut_travail = 'fait')        AS etapes_faites,\n  COUNT(*) FILTER (WHERE wga.statut_travail = 'en_cours')    AS etapes_en_cours,\n  COUNT(*) FILTER (WHERE wga.statut_travail = 'non_commence') AS etapes_non_commencees,\n  COUNT(*) FILTER (WHERE wga.statut_validation_client = 'en_attente_client') AS nb_en_attente_client,\n\n  -- Détail des grandes étapes pour l'appareil (utilisé dans la List + boutons)\n  jsonb_agg(\n    jsonb_build_object(\n      'groupe_id',                wge.id,\n      'groupe_code',              wge.code,          -- NOTE_CALCUL, PLAN, APPRO, ...\n      'groupe_libelle',           wge.libelle,\n\n      'statut_travail',           wga.statut_travail,            -- non_concerne / non_commence / en_cours / fait\n      'statut_validation_client', wga.statut_validation_client,  -- non_concerne / en_attente_client / ...\n\n      'date_debut',               wga.date_debut,\n      'date_fin',                 wga.date_fin,\n      'date_envoi_client',        wga.date_envoi_client,\n      'date_retour_client',       wga.date_retour_client,\n      'responsable',              wga.responsable,\n      'commentaire',              wga.commentaire,\n      'meta',                     wga.meta,          -- tous les champs spécifiques (demande appro, ressuyage, etc.)\n      'groupe_appareil_id',       wga.id,            -- pour les UPDATE\n\n      -- Couleur pré-calculée pour l'UI\n      'color',\n        CASE\n          WHEN wga.statut_travail = 'non_concerne'                 THEN '#e5e7eb' -- gris\n          WHEN wga.statut_validation_client = 'en_attente_client'  THEN '#7AC2F0' -- jaune\n          WHEN wga.statut_validation_client = 'refuse_client'      THEN '#ef4444' -- rouge\n          WHEN wga.statut_validation_client = 'valide_client'      THEN '#22c55e' -- vert\n          WHEN wga.statut_travail = 'fait'                         THEN '#22c55e' -- vert\n          WHEN wga.statut_travail = 'en_cours'                     THEN '#facc15' -- orange\n          WHEN wga.statut_travail = 'non_commence'                 THEN '#ef4444' -- rouge\n          ELSE '#e5e7eb'\n        END\n    )\n    ORDER BY wge.ordre\n  ) AS etapes\n\nFROM public.appareils a\nLEFT JOIN public.affaires aff\n       ON aff.numero_affaire = a.numero_affaire\nLEFT JOIN public.caracteristiques_appareils ca\n       ON ca.numero_appareil = a.numero_appareil\nLEFT JOIN public.workflow_groupe_appareil wga\n       ON wga.numero_appareil = a.numero_appareil\nLEFT JOIN public.workflow_groupe_etape wge\n       ON wge.id = wga.groupe_id\n\nGROUP BY\n  a.numero_appareil,\n  a.numero_affaire,\n  ca.nom_appareil,\n  a.delai,\n  aff.nom_client\n\nORDER BY a.numero_appareil DESC;\n",
      "encodeParamsToggle": true,
      "paginationType": "NONE",
      "pluginSpecifiedTemplates": [
        {
          "value": true
        }
      ],
      "timeoutInMillisecond": 10000
    },
    "confirmBeforeExecute": false,
    "datasource": {
      "id": "Databook - Neon",
      "isAutoGenerated": false,
      "name": "Databook - Neon",
      "pluginId": "postgres-plugin"
    },
    "dynamicBindingPathList": [],
    "name": "QryDashboardSuiviFabrication",
    "pageId": "Tableau de bord fabrication",
    "runBehaviour": "AUTOMATIC",
    "userSetOnLoad": false
  }
}