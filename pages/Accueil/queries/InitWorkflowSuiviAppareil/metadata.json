{
  "gitSyncId": "6915b9d6a2ab6852a3eeef70_3ffb1da0-9417-4587-bfcf-7822352b0593",
  "id": "Accueil_InitWorkflowSuiviAppareil",
  "pluginId": "postgres-plugin",
  "pluginType": "DB",
  "unpublishedAction": {
    "actionConfiguration": {
      "body": "WITH etapes AS (\n  SELECT id, code\n  FROM public.workflow_groupe_etape\n  WHERE code IN (\n    'NOTE_CALCUL',\n    'PLAN',\n    'CAHIER_SOUDAGE',\n    'PREPARATION',\n    'BESOINS',\n    'ACHATS',\n    'FABRICATION',\n    'CONTROLE',\n    'PRESTA_EXTERNES',\n    'DOSSIER_CE',\n    'DOSSIER_CONSTRUCTEUR'\n  )\n),\n\n-- 1) insère (si nécessaire) les lignes header par étape\ninsert_wga AS (\n  INSERT INTO public.workflow_groupe_appareil (\n    numero_appareil,\n    groupe_id,\n    statut_id\n  )\n  SELECT\n    {{ ListeAffaires.selectedRow.numero_affaire + InputRepereAppareil.text }} AS numero_appareil,\n    e.id                             AS groupe_id,\n    (SELECT id FROM public.workflow_statut WHERE code = 'A_FAIRE') AS statut_id\n  FROM etapes e\n  ON CONFLICT (numero_appareil, groupe_id) DO NOTHING\n  RETURNING id, groupe_id\n),\n\n-- 2) récupère toutes les lignes header (nouvelles + existantes)\nall_wga AS (\n  SELECT iw.id, iw.groupe_id\n  FROM insert_wga iw\n  UNION ALL\n  SELECT wga.id, wga.groupe_id\n  FROM public.workflow_groupe_appareil wga\n  JOIN etapes e ON e.id = wga.groupe_id\n  WHERE wga.numero_appareil = {{ ListeAffaires.selectedRow.numero_affaire + InputRepereAppareil.text }}\n),\n\n-- 3) identifie la ligne correspondant à l'étape FABRICATION\nfab_wga AS (\n  SELECT aw.id\n  FROM all_wga aw\n  JOIN public.workflow_groupe_etape e ON e.id = aw.groupe_id\n  WHERE e.code = 'FABRICATION'\n)\n\n-- 4) initialise / met à jour workflow_fabrication avec les heures prévues\nINSERT INTO public.workflow_fabrication (\n  groupe_appareil_id,\n  monteur_id,\n  heures_prevues,\n\theures_prevues_montage,\n\tnombre_jours_marge_fab,\n  heures_passees\n)\nSELECT\n  fw.id          AS groupe_appareil_id,\n  NULL::text     AS monteur_id,\n  {{ this.params.heures_prevues }}::numeric AS heures_prevues,\n\t{{ this.params.heures_prevues_montage }}::numeric AS heures_prevues_montage,\n\t{{ this.params.nombre_jours_marge }}     AS nombre_jours_marge,\n  NULL::numeric  AS heures_passees\nFROM fab_wga fw\nON CONFLICT (groupe_appareil_id) DO UPDATE SET\n  heures_prevues = EXCLUDED.heures_prevues;\n",
      "encodeParamsToggle": true,
      "paginationType": "NONE",
      "pluginSpecifiedTemplates": [
        {
          "value": true
        }
      ],
      "timeoutInMillisecond": 10000
    },
    "confirmBeforeExecute": false,
    "datasource": {
      "id": "Databook - Neon",
      "isAutoGenerated": false,
      "name": "Databook - Neon",
      "pluginId": "postgres-plugin"
    },
    "dynamicBindingPathList": [
      {
        "key": "body"
      }
    ],
    "name": "InitWorkflowSuiviAppareil",
    "pageId": "Accueil",
    "runBehaviour": "MANUAL",
    "userSetOnLoad": false
  }
}