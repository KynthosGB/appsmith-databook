WITH params AS (
  SELECT
    '{{ appsmith.URL.queryParams.numero_affaire + InputRepereAppareil.text }}'::text AS num_app,
    '{{ appsmith.URL.queryParams.numero_affaire }}'::text                            AS num_aff,
    '{{ InputNomAppareil.text }}'::text                                              AS nom_appareil,
    '{{ InputRepereAppareil.text }}'::text                                           AS repere
),
ins_app AS (
  INSERT INTO public.appareils (numero_appareil, numero_affaire)
  SELECT num_app, num_aff FROM params
  ON CONFLICT (numero_appareil) DO NOTHING
  RETURNING 1
),
ins_carac AS (
  INSERT INTO public.caracteristiques_appareils (numero_appareil, numero_affaire, nom_appareil, repere_appareil)
  SELECT p.num_app, p.num_aff, p.num_aff || ' - ' || p.nom_appareil, p.repere
  FROM params p
  ON CONFLICT (numero_appareil) DO NOTHING
  RETURNING 1
),
ins_dg AS (
  INSERT INTO public.donnees_generales_appareils (numero_appareil, numero_affaire, nom_client, nom_affaire)
  SELECT p.num_app, p.num_aff, a.nom_client, p.num_aff
  FROM params p
  JOIN public.affaires a ON a.numero_affaire = p.num_aff
  ON CONFLICT (numero_appareil) DO NOTHING
  RETURNING 1
),
sync AS (
  SELECT public.sync_sommaire_appareil((SELECT num_app FROM params)) AS synced
)
SELECT
  (SELECT COALESCE(COUNT(*),0) FROM ins_app)   AS app_inserted,
  (SELECT COALESCE(COUNT(*),0) FROM ins_carac) AS carac_inserted,
  (SELECT COALESCE(COUNT(*),0) FROM ins_dg)    AS dg_inserted,
  (SELECT synced FROM sync)                    AS sommaire_synced;
