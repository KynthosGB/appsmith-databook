{
  "gitSyncId": "6979c7d7d480504e63533c43_9251a0fd-9f5d-481a-b615-94e30fc36c69",
  "id": "Accueil_AjoutAppareilPrelancement",
  "pluginId": "postgres-plugin",
  "pluginType": "DB",
  "unpublishedAction": {
    "actionConfiguration": {
      "body": "WITH params AS (\n  SELECT\n    '{{ this.params.numero_appareil }}'::text AS num_app,\n    '{{ this.params.numero_affaire }}'::text  AS num_aff,\n    '{{ this.params.nom_appareil }}'::text    AS nom_appareil,\n    '{{ this.params.repere_appareil }}'::text AS repere,\n    NULL::date AS delai\n),\n\n-- 1) appareils\nins_app AS (\n  INSERT INTO public.appareils (numero_appareil, numero_affaire, delai)\n  SELECT num_app, num_aff, delai\n  FROM params\n  ON CONFLICT (numero_appareil) DO NOTHING\n  RETURNING 1\n),\n\n-- 2) caractéristiques\nins_carac AS (\n  INSERT INTO public.caracteristiques_appareils\n         (numero_appareil, numero_affaire, nom_appareil, repere_appareil)\n  SELECT\n    p.num_app,\n    p.num_aff,\n    p.num_aff || p.repere || ' - ' || p.nom_appareil,\n    p.repere\n  FROM params p\n  ON CONFLICT (numero_appareil) DO NOTHING\n  RETURNING 1\n),\n\n-- 3) données générales\nins_dg AS (\n  INSERT INTO public.donnees_generales_appareils\n         (numero_appareil, numero_affaire, nom_client, nom_affaire)\n  SELECT\n    p.num_app,\n    p.num_aff,\n    a.nom_client,\n    p.num_aff\n  FROM params p\n  JOIN public.affaires a ON a.numero_affaire = p.num_aff\n  ON CONFLICT (numero_appareil) DO NOTHING\n  RETURNING 1\n)\n\nSELECT\n  (SELECT COALESCE(COUNT(*), 0) FROM ins_app)   AS app_inserted,\n  (SELECT COALESCE(COUNT(*), 0) FROM ins_carac) AS carac_inserted,\n  (SELECT COALESCE(COUNT(*), 0) FROM ins_dg)    AS dg_inserted;\n",
      "encodeParamsToggle": true,
      "paginationType": "NONE",
      "pluginSpecifiedTemplates": [
        {
          "value": true
        }
      ],
      "timeoutInMillisecond": 60000
    },
    "confirmBeforeExecute": false,
    "datasource": {
      "id": "Databook - Neon",
      "isAutoGenerated": false,
      "name": "Databook - Neon",
      "pluginId": "postgres-plugin"
    },
    "dynamicBindingPathList": [
      {
        "key": "body"
      }
    ],
    "name": "AjoutAppareilPrelancement",
    "pageId": "Accueil",
    "runBehaviour": "MANUAL",
    "userSetOnLoad": false
  }
}