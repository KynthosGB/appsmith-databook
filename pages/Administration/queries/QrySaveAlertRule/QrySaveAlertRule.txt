UPDATE public.alert_rules
SET
  event_type = '{{ TableAlertRules.updatedRow.event_type ?? TableAlertRules.triggeredRow.event_type }}',

  step_code = CASE
    WHEN '{{ TableAlertRules.updatedRow.event_type ?? TableAlertRules.triggeredRow.event_type }}' = 'STATUS_CHANGED'
      THEN NULLIF('{{ TableAlertRules.updatedRow.step_code ?? TableAlertRules.triggeredRow.step_code }}','')
    ELSE NULL
  END,

  status_code = CASE
    WHEN '{{ TableAlertRules.updatedRow.event_type ?? TableAlertRules.triggeredRow.event_type }}' = 'STATUS_CHANGED'
      THEN NULLIF('{{ TableAlertRules.updatedRow.status_code ?? TableAlertRules.triggeredRow.status_code }}','')
    ELSE NULL
  END,

  event_key = CASE
    WHEN '{{ TableAlertRules.updatedRow.event_type ?? TableAlertRules.triggeredRow.event_type }}' <> 'STATUS_CHANGED'
      THEN NULLIF('{{ TableAlertRules.updatedRow.event_key ?? TableAlertRules.triggeredRow.event_key }}','')
    ELSE NULL
  END,

  event_value = CASE
    WHEN '{{ TableAlertRules.updatedRow.event_type ?? TableAlertRules.triggeredRow.event_type }}' <> 'STATUS_CHANGED'
      THEN 'true'
    ELSE NULL
  END,

  target_everwin_user_id = CASE
    WHEN
      '{{ TableAlertRules.updatedRow.event_type ?? TableAlertRules.triggeredRow.event_type }}' = 'STATUS_CHANGED'
      AND NULLIF('{{ TableAlertRules.updatedRow.status_code ?? TableAlertRules.triggeredRow.status_code }}','') = 'ATTENTE_CLIENT'
    THEN NULL
    ELSE NULLIF('{{ TableAlertRules.updatedRow.target_everwin_user_id ?? TableAlertRules.triggeredRow.target_everwin_user_id }}','')
  END,

  enabled = {{
    (() => {
      const v = TableAlertRules.updatedRow.enabled ?? TableAlertRules.triggeredRow.enabled;
      if (v === true || v === false) return v;
      if (v === "true") return true;
      if (v === "false") return false;
      return true;
    })()
  }},

  only_on_change = {{
    (() => {
      const v = TableAlertRules.updatedRow.only_on_change ?? TableAlertRules.triggeredRow.only_on_change;
      if (v === true || v === false) return v;
      if (v === "true") return true;
      if (v === "false") return false;
      return true;
    })()
  }},

  throttle_minutes = {{
    (() => {
      const v = TableAlertRules.updatedRow.throttle_minutes ?? TableAlertRules.triggeredRow.throttle_minutes;
      const n = Number(v);
      return Number.isFinite(n) ? n : 0;
    })()
  }},

  description = '{{ ((TableAlertRules.updatedRow.description ?? TableAlertRules.triggeredRow.description) || "").replaceAll("'", "''") }}',
	
	notify_charge_affaire = {{
		(() => {
			const v = TableAlertRules.updatedRow.notify_charge_affaire ?? TableAlertRules.triggeredRow.notify_charge_affaire;
			if (v === true || v === false) return v;
			if (v === "true") return true;
			if (v === "false") return false;
			return false;
		})()
	}},
	
  updated_at = now()
	
	


WHERE id = '{{ (TableAlertRules.updatedRow?.id ?? TableAlertRules.triggeredRow?.id) }}'::uuid;
