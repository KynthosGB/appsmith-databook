INSERT INTO public.alert_rules (
  event_type,
  step_code,
  status_code,
  event_key,
  event_value,
  target_type,
  target_everwin_user_id,
  target_slack_channel_id,
  enabled,
  only_on_change,
  throttle_minutes,
  description
)
VALUES (
  '{{ TableAlertRules.newRow.event_type ?? "STATUS_CHANGED" }}',

  CASE
    WHEN '{{ TableAlertRules.newRow.event_type ?? "STATUS_CHANGED" }}' = 'STATUS_CHANGED'
      THEN NULLIF('{{ TableAlertRules.newRow.step_code ?? "" }}', '')
    ELSE NULL
  END,

  CASE
    WHEN '{{ TableAlertRules.newRow.event_type ?? "STATUS_CHANGED" }}' = 'STATUS_CHANGED'
      THEN NULLIF('{{ TableAlertRules.newRow.status_code ?? "" }}', '')
    ELSE NULL
  END,

  CASE
    WHEN '{{ TableAlertRules.newRow.event_type ?? "STATUS_CHANGED" }}' <> 'STATUS_CHANGED'
      THEN NULLIF('{{ TableAlertRules.newRow.event_key ?? "" }}', '')
    ELSE NULL
  END,

  CASE
    WHEN '{{ TableAlertRules.newRow.event_type ?? "STATUS_CHANGED" }}' <> 'STATUS_CHANGED'
      THEN 'true'
    ELSE NULL
  END,

  '{{ TableAlertRules.newRow.target_type ?? "DM" }}',

  CASE
    WHEN '{{ TableAlertRules.newRow.target_type ?? "DM" }}' = 'DM'
      THEN NULLIF('{{ TableAlertRules.newRow.target_everwin_user_id ?? "" }}', '')
    ELSE NULL
  END,

  CASE
    WHEN '{{ TableAlertRules.newRow.target_type ?? "DM" }}' = 'CHANNEL'
      THEN NULLIF('{{ TableAlertRules.newRow.target_slack_channel_id ?? "" }}', '')
    ELSE NULL
  END,

  {{ TableAlertRules.newRow.enabled ?? true }},
  {{ TableAlertRules.newRow.only_on_change ?? true }},
  {{ TableAlertRules.newRow.throttle_minutes ?? 0 }},
  '{{ (TableAlertRules.newRow.description || "").replaceAll("'", "''") }}'
)
RETURNING id;
