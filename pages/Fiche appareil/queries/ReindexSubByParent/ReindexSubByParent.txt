-- ReindexSubByParent (v2)
-- Params: this.params.numero_appareil, this.params.parent_master_id

WITH sibs AS (
  -- Tous les sous-chapitres du même parent pour l'appareil donné
  SELECT
    s.master_id,
    a.include,
    COALESCE(a.sub_ord_override, s.default_sub_ord) AS ord
  FROM public.sommaire s
  JOIN public.sommaire_appareils a ON a.master_id = s.master_id
  WHERE a.numero_appareil   = {{ this.params.numero_appareil }}
    AND s.parent_master_id  = {{ this.params.parent_master_id }}
),
rank_all AS (
  SELECT master_id,
         ROW_NUMBER() OVER (ORDER BY ord, master_id) AS rn_all
  FROM sibs
),
rank_active AS (
  SELECT master_id,
         ROW_NUMBER() OVER (ORDER BY ord, master_id) AS rn_active
  FROM sibs
  WHERE include IS TRUE
),
merged AS (
  SELECT a.master_id,
         a.include,
         ra.rn_active,
         r.rn_all
  FROM public.sommaire_appareils a
  JOIN rank_all r        ON r.master_id = a.master_id
  LEFT JOIN rank_active ra ON ra.master_id = a.master_id
  WHERE a.numero_appareil = {{ this.params.numero_appareil }}
)
UPDATE public.sommaire_appareils AS a
SET sub_ord_override = CASE
      WHEN m.include IS TRUE THEN m.rn_active       -- actifs compactés 1..N
      ELSE 1000 + m.rn_all                          -- exclus rangés "loin"
    END
FROM merged m
WHERE a.numero_appareil = {{ this.params.numero_appareil }}
  AND a.master_id       = m.master_id;
